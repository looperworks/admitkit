<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdmitKit — US Graduate Admissions Requirements</title>
  <meta name="description" content="Find US graduate program admissions requirements, GPA minimums, GRE scores, essay prompts, recommendation letters, and application deadlines for top universities. Save, compare, and export.">
  <meta name="keywords" content="graduate admissions, masters programs, admission requirements, GRE, TOEFL, GPA, US universities, grad school">
  <meta property="og:title" content="AdmitKit — US Graduate Admissions Requirements">
  <meta property="og:description" content="Search, compare, and save admission requirements for graduate programs at 6,000+ US colleges and universities.">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    /* ─── Theme Variables ─────────────────────────────────────── */
    :root {
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-xs: 6px;
    }

    [data-theme="dark"] {
      --bg: #0a0a0f;
      --bg-elevated: #13131a;
      --bg-card: rgba(255,255,255,0.04);
      --bg-card-hover: rgba(255,255,255,0.08);
      --bg-glass: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.08);
      --border-hover: rgba(139,92,246,0.4);
      --text-primary: #f0f0f5;
      --text-secondary: #8b8b9e;
      --text-tertiary: #5a5a6e;
      --accent: #8b5cf6;
      --accent-soft: rgba(139,92,246,0.15);
      --accent-glow: rgba(139,92,246,0.3);
      --success: #34d399;
      --success-soft: rgba(52,211,153,0.12);
      --warning: #fbbf24;
      --warning-soft: rgba(251,191,36,0.12);
      --danger: #f87171;
      --danger-soft: rgba(248,113,113,0.1);
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --shadow-glow: 0 0 60px rgba(139,92,246,0.08);
      --modal-bg: rgba(0,0,0,0.7);
      --input-bg: rgba(255,255,255,0.06);
    }

    [data-theme="light"] {
      --bg: #fafafe;
      --bg-elevated: #ffffff;
      --bg-card: rgba(0,0,0,0.02);
      --bg-card-hover: rgba(0,0,0,0.04);
      --bg-glass: rgba(255,255,255,0.8);
      --border: rgba(0,0,0,0.08);
      --border-hover: rgba(139,92,246,0.4);
      --text-primary: #0f0f1a;
      --text-secondary: #6b6b80;
      --text-tertiary: #9b9bae;
      --accent: #7c3aed;
      --accent-soft: rgba(124,58,237,0.1);
      --accent-glow: rgba(124,58,237,0.15);
      --success: #059669;
      --success-soft: rgba(5,150,105,0.1);
      --warning: #d97706;
      --warning-soft: rgba(217,119,6,0.1);
      --danger: #dc2626;
      --danger-soft: rgba(220,38,38,0.08);
      --shadow: 0 8px 32px rgba(0,0,0,0.08);
      --shadow-glow: 0 0 60px rgba(124,58,237,0.05);
      --modal-bg: rgba(0,0,0,0.3);
      --input-bg: rgba(0,0,0,0.04);
    }

    /* ─── Reset ─────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.4s var(--ease), color 0.4s var(--ease);
      -webkit-font-smoothing: antialiased;
    }

    .container { max-width: 1140px; margin: 0 auto; padding: 0 24px; }
    .hidden { display: none !important; }

    /* ─── Scroll-Reveal Animation ─────────────────────────────── */
    .reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.7s var(--ease), transform 0.7s var(--ease);
    }
    .reveal.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ─── Header ─────────────────────────────────────── */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 72px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text-primary);
      cursor: pointer;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.03em;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 100px;
      transition: all 0.3s var(--ease);
    }

    .nav-link:hover { color: var(--text-primary); background: var(--bg-card); }
    .nav-link.active { color: var(--accent); background: var(--accent-soft); }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s var(--ease);
      margin-left: 8px;
      color: var(--text-primary);
    }
    .theme-toggle:hover { border-color: var(--accent); background: var(--accent-soft); }

    /* ─── Hero ─────────────────────────────────────── */
    .hero {
      padding: 100px 0 80px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: -200px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      pointer-events: none;
    }

    .hero-content {
      max-width: 720px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      background: var(--accent-soft);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 32px;
    }

    .hero h1 {
      font-size: clamp(40px, 6vw, 64px);
      font-weight: 900;
      letter-spacing: -0.04em;
      line-height: 1.05;
      margin-bottom: 20px;
    }

    .hero h1 .gradient-text {
      background: linear-gradient(135deg, var(--accent), #c084fc, #e879f9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 18px;
      color: var(--text-secondary);
      max-width: 540px;
      margin: 0 auto 48px;
      line-height: 1.7;
      font-weight: 400;
    }

    /* ─── Search Bar ─────────────────────────────────── */
    .search-bar {
      display: flex;
      gap: 12px;
      max-width: 680px;
      margin: 0 auto;
      flex-wrap: wrap;
      justify-content: center;
    }

    .search-input-wrapper {
      flex: 1;
      min-width: 260px;
      position: relative;
    }

    .search-input-wrapper svg {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      width: 18px;
      height: 18px;
    }

    .search-input {
      width: 100%;
      padding: 14px 16px 14px 48px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      font-family: var(--font);
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.3s var(--ease);
      outline: none;
    }

    .search-input::placeholder { color: var(--text-tertiary); }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }

    .search-select {
      padding: 14px 16px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      font-family: var(--font);
      font-size: 14px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s var(--ease);
      outline: none;
      min-width: 140px;
      -webkit-appearance: none;
      appearance: none;
    }

    .search-select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }

    .btn-search {
      padding: 14px 32px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 14px;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s var(--ease);
      letter-spacing: 0.02em;
    }

    .btn-search:hover {
      filter: brightness(1.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px var(--accent-glow);
    }

    /* ─── Stats Row ─────────────────────────────────── */
    .stats-row {
      display: flex;
      justify-content: center;
      gap: 48px;
      padding: 48px 0 0;
      margin-top: 48px;
      border-top: 1px solid var(--border);
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-tertiary);
      font-weight: 500;
      margin-top: 4px;
    }

    /* ─── How It Works ─────────────────────────────────── */
    .how-section {
      padding: 100px 0;
    }

    .section-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin-bottom: 16px;
      text-align: center;
    }

    .section-heading {
      font-size: clamp(28px, 4vw, 40px);
      font-weight: 800;
      letter-spacing: -0.03em;
      text-align: center;
      margin-bottom: 16px;
    }

    .section-desc {
      font-size: 16px;
      color: var(--text-secondary);
      text-align: center;
      max-width: 560px;
      margin: 0 auto 64px;
      line-height: 1.7;
    }

    .steps-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .step-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px 28px;
      text-align: center;
      transition: all 0.4s var(--ease);
      position: relative;
      overflow: hidden;
    }

    .step-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.4s var(--ease);
    }

    .step-card:hover {
      border-color: var(--border-hover);
      background: var(--bg-card-hover);
      transform: translateY(-4px);
    }
    .step-card:hover::before { opacity: 1; }

    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 800;
      font-size: 20px;
      margin-bottom: 20px;
    }

    .step-card h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.01em;
    }

    .step-card p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    .why-box {
      margin-top: 48px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: var(--radius);
      padding: 28px 32px;
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.8;
    }
    .why-box strong { color: var(--text-primary); }

    /* ─── Main Content ─────────────────────────────────── */
    main { flex: 1; padding: 40px 0 80px; }

    .filters-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 32px;
      align-items: center;
    }

    .results-count {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-left: auto;
      font-weight: 500;
    }

    .sort-dropdown {
      padding: 8px 28px 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: var(--font);
      font-size: 0.85rem;
      color: var(--text-primary);
      background: var(--input-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M3 5l3 3 3-3'/%3E%3C/svg%3E") no-repeat right 10px center;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
      min-width: 180px;
      transition: all 0.3s var(--ease);
    }
    .sort-dropdown:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    /* ─── Cards Grid ─────────────────────────────────── */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 48px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      cursor: pointer;
      transition: all 0.35s var(--ease);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--accent-glow), transparent);
      opacity: 0;
      transition: opacity 0.35s var(--ease);
      pointer-events: none;
    }

    .card:hover {
      border-color: var(--border-hover);
      transform: translateY(-6px);
      box-shadow: var(--shadow), var(--shadow-glow);
    }
    .card:hover::after { opacity: 1; }

    .card-school {
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
    }

    .card-program {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 16px;
      line-height: 1.3;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tag {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
    }

    .tag.degree { color: var(--accent); border-color: rgba(139,92,246,0.25); background: var(--accent-soft); }
    .tag.format { color: var(--success); border-color: rgba(52,211,153,0.25); background: var(--success-soft); }

    .card-info {
      font-size: 13px;
      color: var(--text-tertiary);
      line-height: 1.7;
      flex-grow: 1;
      margin-bottom: 20px;
    }
    .card-info strong { color: var(--text-secondary); }

    .card-cta {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: gap 0.3s var(--ease);
    }
    .card:hover .card-cta { gap: 10px; }

    /* ─── Pagination ─────────────────────────────────── */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .pagination button {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font);
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s var(--ease);
    }

    .pagination button:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .pagination button.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }

    /* ─── Modal ─────────────────────────────────────── */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: var(--modal-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow-y: auto;
    }
    .modal.active { display: flex; align-items: flex-start; justify-content: center; padding: 40px 24px; }

    .modal-content {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 20px;
      max-width: 760px;
      width: 100%;
      overflow: hidden;
      box-shadow: var(--shadow);
      animation: modalSlideUp 0.4s var(--ease);
    }

    @keyframes modalSlideUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 32px 32px 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.03em;
    }

    .modal-header .school {
      font-size: 13px;
      color: var(--accent);
      font-weight: 600;
      margin-top: 6px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s var(--ease);
      flex-shrink: 0;
    }
    .modal-close:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-soft); }

    .modal-body { padding: 32px; }

    .modal-section { margin-bottom: 32px; }
    .modal-section:last-child { margin-bottom: 0; }

    .modal-section h3 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .overview-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .overview-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: var(--radius-sm);
    }

    .overview-item-label {
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 4px;
    }

    .overview-item-value {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .link-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .link-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s var(--ease);
    }

    .link-button:hover {
      filter: brightness(1.15);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--accent-glow);
    }

    .requirements-subsection { margin-bottom: 20px; }

    .requirements-subsection h4 {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 12px;
      letter-spacing: 0.02em;
    }

    .requirements-list { list-style: none; }

    .requirements-list li {
      padding: 10px 0;
      font-size: 14px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }
    .requirements-list li:last-child { border-bottom: none; }
    .requirements-list strong { color: var(--text-primary); font-weight: 600; }

    .checklist-grid { display: flex; flex-direction: column; gap: 12px; }
    .checklist-item { display: flex; gap: 12px; padding: 14px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; transition: all 0.3s var(--ease); }
    .checklist-item:hover { border-color: var(--accent); transform: translateX(4px); }
    .checklist-icon { font-size: 1.3rem; flex-shrink: 0; width: 28px; text-align: center; padding-top: 2px; }
    .checklist-content { flex: 1; }
    .checklist-label { font-weight: 700; color: var(--text); margin-bottom: 4px; font-size: 0.95rem; }
    .checklist-detail { color: var(--text-muted); font-size: 0.85rem; line-height: 1.5; }
    .insider-notes {
      background: var(--warning-soft);
      border-left: 3px solid var(--warning);
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
    }
    .insider-notes strong { color: var(--text-primary); }

    .disclaimer-box {
      background: var(--danger-soft);
      border: 1px solid rgba(248,113,113,0.2);
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.7;
    }
    .disclaimer-box strong { color: var(--text-primary); display: block; margin-bottom: 6px; }

    /* ─── Footer ─────────────────────────────────────── */
    .footer {
      border-top: 1px solid var(--border);
      padding: 48px 0 32px;
      margin-top: auto;
    }

    .footer-inner {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 32px;
    }

    .footer-brand {
      font-size: 14px;
      color: var(--text-tertiary);
      line-height: 1.8;
      max-width: 400px;
    }
    .footer-brand strong { color: var(--text-primary); font-size: 16px; display: block; margin-bottom: 8px; }

    .footer-links {
      display: flex;
      gap: 24px;
    }

    .footer-links a {
      color: var(--text-tertiary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: color 0.3s var(--ease);
    }
    .footer-links a:hover { color: var(--accent); }

    .footer-bottom {
      border-top: 1px solid var(--border);
      padding-top: 24px;
      font-size: 12px;
      color: var(--text-tertiary);
      text-align: center;
    }

    /* ─── Page Sections ─────────────────────────────────── */
    .page-section { display: none; }
    .page-section.active { display: block; }

    .page-content {
      padding: 80px 0;
      max-width: 720px;
      margin: 0 auto;
    }

    .page-content h1 {
      font-size: clamp(32px, 4vw, 44px);
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 32px;
    }

    .page-content h2 {
      font-size: 22px;
      font-weight: 700;
      margin-top: 40px;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }

    .page-content p {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.8;
      margin-bottom: 16px;
    }

    .page-content ul { margin-bottom: 24px; list-style: none; }

    .page-content li {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.8;
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }

    .page-content li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
    }

    .page-content li strong { color: var(--text-primary); }

    .page-content a { color: var(--accent); text-decoration: none; }
    .page-content a:hover { text-decoration: underline; }

    /* ─── Toast Notification ─────────────────────────────────── */
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 24px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      box-shadow: var(--shadow);
      z-index: 2000;
      opacity: 0;
      transition: all 0.4s var(--ease);
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .toast .toast-icon { font-size: 18px; }

    /* ─── Bookmark Button ─────────────────────────────────── */
    .bookmark-btn {
      width: 36px;
      height: 36px;
      position: absolute;
      top: 14px;
      right: 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s var(--ease);
      z-index: 10;
      padding: 0;
      color: var(--text-tertiary);
      line-height: 1;
    }
    .bookmark-btn:hover { border-color: var(--accent); background: var(--accent-soft); color: var(--accent); transform: scale(1.1); }
    .bookmark-btn.saved { border-color: var(--accent); background: var(--accent-soft); color: var(--accent); }

    .modal-save-btn {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s var(--ease);
      white-space: nowrap;
    }
    .modal-save-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    .modal-save-btn.saved { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }

    /* ─── Save Badge ─────────────────────────────────── */
    .save-badge {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      margin-left: 2px;
    }

    /* ─── Saved Page ─────────────────────────────────── */
    .saved-header {
      padding: 80px 0 40px;
    }
    .saved-header h1 {
      font-size: clamp(28px, 4vw, 40px);
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
    }
    .saved-header p {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 0;
    }

    .saved-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
      align-items: center;
    }

    .export-btn {
      padding: 12px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-family: var(--font);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s var(--ease);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .export-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); transform: translateY(-2px); }
    .export-btn .icon { font-size: 16px; }

    .saved-empty {
      text-align: center;
      padding: 80px 20px;
    }
    .saved-empty-icon { font-size: 56px; margin-bottom: 16px; opacity: 0.5; }
    .saved-empty p { font-size: 16px; color: var(--text-secondary); margin-bottom: 16px; }
    .saved-empty a { color: var(--accent); text-decoration: none; font-weight: 600; font-size: 14px; }
    .saved-empty a:hover { text-decoration: underline; }

    /* ─── Explore / Live API Section ─────────────────────────────────── */
    .explore-section { padding: 80px 0; }

    .api-setup-banner {
      background: var(--warning-soft);
      border: 1px solid rgba(251,191,36,0.25);
      border-radius: var(--radius);
      padding: 24px 28px;
      margin-bottom: 40px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }
    .api-setup-banner .banner-icon { font-size: 24px; flex-shrink: 0; margin-top: 2px; }
    .api-setup-banner .banner-text { flex: 1; }
    .api-setup-banner .banner-text strong { color: var(--text-primary); display: block; margin-bottom: 4px; }
    .api-setup-banner .banner-text p { font-size: 14px; color: var(--text-secondary); margin: 0; line-height: 1.6; }
    .api-setup-banner .banner-text a { color: var(--accent); font-weight: 600; }
    .api-setup-banner .banner-text code {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-family: monospace;
    }

    .api-key-row {
      display: flex;
      gap: 12px;
      margin-bottom: 48px;
      flex-wrap: wrap;
    }

    .api-key-input {
      flex: 1;
      min-width: 200px;
      padding: 14px 16px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      font-family: monospace;
      font-size: 14px;
      color: var(--text-primary);
      outline: none;
      transition: all 0.3s var(--ease);
    }
    .api-key-input::placeholder { color: var(--text-tertiary); }
    .api-key-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }

    .btn-save-key {
      padding: 14px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 14px;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s var(--ease);
    }
    .btn-save-key:hover { filter: brightness(1.15); }

    .key-status {
      font-size: 13px;
      color: var(--success);
      font-weight: 600;
      align-self: center;
    }

    .explore-search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .explore-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .school-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      transition: all 0.35s var(--ease);
    }
    .school-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-4px);
      box-shadow: var(--shadow);
    }

    .school-card-name {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 6px;
    }

    .school-card-location {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 16px;
    }

    .school-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .school-stat {
      background: var(--bg-card-hover);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .school-stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
      font-weight: 600;
      margin-bottom: 2px;
    }
    .school-stat-value {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .school-card-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      text-decoration: none;
      transition: gap 0.3s var(--ease);
    }
    .school-card-link:hover { gap: 10px; }

    .api-loading {
      text-align: center;
      padding: 48px 0;
      color: var(--text-tertiary);
    }
    .api-loading .spinner {
      display: inline-block;
      width: 28px;
      height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .api-error {
      text-align: center;
      padding: 48px 0;
      color: var(--danger);
      font-size: 14px;
    }

    /* ─── Empty State ─────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 80px 0;
      color: var(--text-tertiary);
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state p { font-size: 15px; }

    /* ─── Responsive ─────────────────────────────────── */
    @media (max-width: 768px) {
      .hero { padding: 60px 0; }
      .search-bar { flex-direction: column; }
      .search-input-wrapper { min-width: 100%; }
      .search-select { width: 100%; }
      .btn-search { width: 100%; }
      .steps-grid { grid-template-columns: 1fr; }
      .stats-row { gap: 24px; }
      .cards-grid { grid-template-columns: 1fr; }
      .overview-grid { grid-template-columns: 1fr; }
      .link-buttons { grid-template-columns: 1fr; }
      .footer-inner { flex-direction: column; }
      .footer-links { flex-direction: column; gap: 12px; }
      .nav-link { padding: 8px 10px; font-size: 12px; }
      .filters-bar { flex-direction: column; }
      .results-count { margin-left: 0; }
      .explore-results { grid-template-columns: 1fr; }
      .saved-actions { flex-direction: column; }
      .explore-search-bar { flex-direction: column; }
      .api-key-row { flex-direction: column; }
      .api-setup-banner { flex-direction: column; }
      .school-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-inner">
        <a href="#" class="logo" onclick="showPage('search'); return false;">
          <div class="logo-icon">A</div>
          <span class="logo-text">AdmitKit</span>
        </a>
        <nav class="nav">
          <a class="nav-link active" href="#" onclick="showPage('search'); return false;">Search</a>
          <a class="nav-link" href="#" onclick="showPage('saved'); return false;">Saved <span class="save-badge" id="save-badge"></span></a>
          <a class="nav-link" href="#" onclick="showPage('about'); return false;">About</a>
          <a class="nav-link" href="#" onclick="showPage('disclaimer'); return false;">Disclaimer</a>
          <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle dark/light mode">
            <span id="theme-icon">&#9788;</span>
          </button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Search Page -->
  <div id="search-page" class="page-section active">
    <!-- Hero -->
    <section class="hero">
      <div class="container">
        <div class="hero-content">
          <div class="hero-badge">Free Resource &mdash; 6,000+ US Schools &mdash; Live API Data &mdash; Updated Feb 2026</div>
          <h1>Find your path to<br><span class="gradient-text">graduate school.</span></h1>
          <p>Search admission requirements, deadlines, and program details for master's and doctoral programs at any US university. Powered by the U.S. Department of Education.</p>

          <form class="search-bar" onsubmit="handleSearch(event)">
            <div class="search-input-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
              <input type="text" id="search-query" class="search-input" placeholder="Search school or program..." oninput="handleSearchDebounced()">
            </div>
            <select id="filter-state" class="search-select">
              <option value="">All States</option>
            </select>
            <select id="filter-degree" class="search-select">
              <option value="">All Degrees</option>
              <option value="Masters">Master's</option>
              <option value="Doctoral">Doctoral</option>
            </select>
            <select id="filter-region" class="search-select" onchange="var br=document.getElementById('browse-region'); if(br) br.value=this.value; handleRegionFilter();">
              <option value="">All Regions</option>
              <option value="Northeast">Northeast</option>
              <option value="Southeast">Southeast</option>
              <option value="Midwest">Midwest</option>
              <option value="West">West</option>
              <option value="Texas">Texas</option>
            </select>
            <button type="submit" class="btn-search" onclick="handleSearch(event)">Search</button>
          </form>

          <div class="stats-row reveal">
            <div class="stat">
              <div class="stat-number">6,000+</div>
              <div class="stat-label">US Schools</div>
            </div>
            <div class="stat">
              <div class="stat-number">50</div>
              <div class="stat-label">States + DC</div>
            </div>
            <div class="stat">
              <div class="stat-number">Live</div>
              <div class="stat-label">Dept. of Education Data</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- How It Works -->
    <section class="how-section">
      <div class="container">
        <div class="section-label reveal">How It Works</div>
        <h2 class="section-heading reveal">Three steps to clarity.</h2>
        <p class="section-desc reveal">Stop juggling 20 browser tabs. We organize the details so you can focus on your application.</p>

        <div class="steps-grid">
          <div class="step-card reveal">
            <div class="step-number">1</div>
            <h3>Search</h3>
            <p>Enter a school name, program, or field of study. Filter by state and degree type to narrow your options.</p>
          </div>
          <div class="step-card reveal">
            <div class="step-number">2</div>
            <h3>Compare</h3>
            <p>Browse requirements, deadlines, and tuition side by side. Click any card for detailed admission criteria.</p>
          </div>
          <div class="step-card reveal">
            <div class="step-number">3</div>
            <h3>Apply</h3>
            <p>Use the details to prepare a stronger application. Visit official program pages and start your journey.</p>
          </div>
        </div>

        <div class="why-box reveal">
          <strong>Why AdmitKit?</strong> The grad application process can feel overwhelming. We organize the key details you need — GPA requirements, test scores, deadlines, prerequisites, and more — so you can focus on putting your best application forward.
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <main>
      <div class="container">
        <!-- Filters -->
        <div class="filters-bar">
          <select id="browse-state" class="search-select" onchange="applyFilters()">
            <option value="">All States</option>
          </select>
          <select id="browse-degree" class="search-select" onchange="applyFilters()">
            <option value="">All Degrees</option>
            <option value="Masters">Master's</option>
            <option value="Doctoral">Doctoral</option>
          </select>
          <select id="browse-format" class="search-select" onchange="applyFilters()">
            <option value="">All Formats</option>
            <option value="On-campus">On-campus</option>
            <option value="Online">Online</option>
            <option value="Hybrid">Hybrid</option>
          </select>
          <select id="browse-region" class="search-select" onchange="handleRegionFilter()">
            <option value="">All Regions</option>
            <option value="Northeast">Northeast</option>
            <option value="Southeast">Southeast</option>
            <option value="Midwest">Midwest</option>
            <option value="West">West</option>
            <option value="Texas">Texas</option>
          </select>
          <select id="browse-ranking" class="search-select" onchange="handleRankingFilter()">
            <option value="">Any Ranking</option>
            <option value="10">Top 10</option>
            <option value="25">Top 25</option>
            <option value="50">Top 50</option>
            <option value="100">Top 100</option>
          </select>
          <select id="search-sort" class="sort-dropdown" onchange="handleSort()" style="display:none;">
            <option value="relevance">Sort: Relevance</option>
            <option value="total-asc">Total Cost: Low &rarr; High</option>
            <option value="total-desc">Total Cost: High &rarr; Low</option>
            <option value="tuition-asc">Tuition: Low &rarr; High</option>
            <option value="ranking">Ranking: Best First</option>
          </select>
          <div class="results-count" id="results-count"></div>
        </div>

        <!-- Cards Grid -->
        <div class="cards-grid" id="cards-grid"></div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
      </div>
    </main>
  </div>

  <!-- About Page -->
  <div id="about-page" class="page-section">
    <div class="container">
      <div class="page-content">
        <h1>About AdmitKit</h1>

        <h2>Who We Are</h2>
        <p>AdmitKit is a free resource built to help prospective graduate students navigate the complex world of admissions. We believe every student deserves easy access to the information they need to make informed decisions about their academic future.</p>

        <h2>What We Do</h2>
        <p>AdmitKit gives you two powerful ways to research graduate programs:</p>
        <ul>
          <li><strong>Curated Database:</strong> 53 hand-picked programs across 15 top universities with detailed admission requirements — including essay prompts, recommendation letter details, CV requirements, transcript policies, and English proficiency scores.</li>
          <li><strong>Live API Search:</strong> Search any of the 6,000+ US colleges and universities via the U.S. Department of Education's College Scorecard. Get real-time acceptance rates, enrollment numbers, average costs, and graduate program counts.</li>
        </ul>

        <h2>How to Use AdmitKit</h2>
        <ul>
          <li><strong>Search Tab:</strong> Browse our curated database of 53 programs with full admission requirements. Use filters to narrow by state, degree type, or format.</li>
          <li><strong>Explore Tab:</strong> Search any US school by name and get live data from the Department of Education — no limits on which schools you can search.</li>
          <li><strong>Click for Details:</strong> Click any card to open detailed admission requirements, including a full Application Materials Checklist (essays, recommendation letters, CV, transcripts, English proficiency).</li>
          <li><strong>Save &amp; Export:</strong> Bookmark programs, then export your list as a CSV (for Excel) or a formatted PDF.</li>
        </ul>

        <h2>Accuracy &amp; Data Quality</h2>
        <p>While we work hard to keep our information accurate and up-to-date, admission requirements and deadlines can change at any time. Universities may update their websites, modify requirements, or adjust deadlines without notice.</p>
        <p>AdmitKit uses a combination of curated data and automated API integrations to collect program information. While we make every effort to ensure accuracy, we cannot guarantee that all details are current or complete.</p>

        <h2>Important Disclaimer</h2>
        <p><strong>We strongly recommend that you verify all critical information — including deadlines, requirements, and application procedures — directly with the institution's official admissions office before submitting your application.</strong></p>
        <p>AdmitKit is an informational resource and is not affiliated with any university. Use of this site does not constitute an application or guarantee of admission.</p>
      </div>
    </div>
  </div>

  <!-- Disclaimer Page -->
  <div id="disclaimer-page" class="page-section">
    <div class="container">
      <div class="page-content">
        <h1>Disclaimer &amp; Accuracy Notice</h1>

        <h2>Information Accuracy</h2>
        <p>While we work hard to keep our information accurate and up-to-date, admission requirements and deadlines can change at any time. Universities may update their websites, modify requirements, or adjust deadlines without notice.</p>
        <p>AdmitKit uses a combination of curated data and automated API integrations to collect program information. While we make every effort to ensure accuracy, we cannot guarantee that all details are current or complete.</p>

        <h2>Critical Recommendation</h2>
        <p><strong>We strongly recommend that you verify all critical information — including deadlines, requirements, and application procedures — directly with the institution's official admissions office before submitting your application.</strong></p>

        <h2>Affiliation</h2>
        <p>AdmitKit is an independent informational resource and is not affiliated with any university, college, or educational institution. Use of this site does not constitute an application, application submission, or guarantee of admission to any program.</p>

        <h2>Data Sources</h2>
        <ul>
          <li>University official websites and admissions offices</li>
          <li>U.S. Department of Education College Scorecard</li>
          <li>Publicly available program information</li>
        </ul>

        <h2>No Guarantee</h2>
        <p>AdmitKit does not guarantee the accuracy, completeness, or timeliness of any information on this site. Users access and use this site at their own risk. Neither AdmitKit nor its operators are responsible for any direct or indirect damages or losses arising from the use of this platform.</p>

        <h2>Changes to Information</h2>
        <p>Universities frequently update their admission requirements, application procedures, deadlines, and tuition costs. Users should always verify current information with official institutional sources before making any decisions or submissions.</p>

        <h2>Contact</h2>
        <p>If you find inaccurate information on AdmitKit, please contact us at <a href="mailto:seth@looperworks.com">seth@looperworks.com</a>.</p>
      </div>
    </div>
  </div>

  <!-- Saved Programs Page -->
  <div id="saved-page" class="page-section">
    <div class="container">
      <div class="saved-header">
        <h1>Saved Programs</h1>
        <p>Review and export your bookmarked programs.</p>
      </div>

      <!-- Empty State -->
      <div id="saved-empty" class="saved-empty">
        <div class="saved-empty-icon">&#128278;</div>
        <p>No programs saved yet. Bookmark programs you're interested in and they'll appear here.</p>
        <a href="#" onclick="showPage('search'); return false;">Browse programs &rarr;</a>
      </div>

      <!-- Saved Content (hidden until programs saved) -->
      <div id="saved-content" style="display:none;">
        <div class="saved-actions">
          <button class="export-btn" onclick="exportSavedCSV()"><span class="icon">&#128196;</span> Download CSV</button>
          <button class="export-btn" onclick="exportSavedPDF()"><span class="icon">&#128462;</span> Print / Save PDF</button>
          <button class="export-btn" onclick="clearAllSaved()" style="margin-left:auto; color:var(--danger); border-color:rgba(248,113,113,0.3);"><span class="icon">&#128465;</span> Clear all</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:20px;">
          <span style="font-size:0.85rem; color:var(--text-secondary); font-weight:600;">Sort by:</span>
          <select id="saved-sort" class="sort-dropdown" onchange="renderSavedPage()">
            <option value="name">Name (A &rarr; Z)</option>
            <option value="tuition-asc">Tuition: Low &rarr; High</option>
            <option value="tuition-desc">Tuition: High &rarr; Low</option>
            <option value="living-asc">Living Cost: Low &rarr; High</option>
            <option value="living-desc">Living Cost: High &rarr; Low</option>
            <option value="total-asc">Total Cost: Low &rarr; High</option>
            <option value="total-desc">Total Cost: High &rarr; Low</option>
            <option value="ranking">Ranking: Best First</option>
          </select>
          <span id="saved-count" style="font-size:0.8rem; color:var(--text-tertiary); margin-left:auto;"></span>
        </div>
        <div class="cards-grid" id="saved-cards-grid"></div>
      </div>
    </div>
  </div>


  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">
          <strong>AdmitKit</strong>
          Helping students find their path to graduate school. Data sourced from curated research and the U.S. Department of Education's College Scorecard. Always verify requirements with official university sources before applying.
        </div>
        <div class="footer-links">
          <a href="#" onclick="showPage('about'); return false;">About</a>
          <a href="#" onclick="showPage('disclaimer'); return false;">Disclaimer</a>
        </div>
      </div>
      <div class="footer-bottom">
        &copy; 2026 AdmitKit. All rights reserved.<br>
        <span style="font-size:0.75rem; opacity:0.7;">Curated data last updated: February 2026 &bull; API data is live from the U.S. Dept. of Education College Scorecard</span>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h2 id="modal-program-name"></h2>
          <div class="school" id="modal-school-name"></div>
        </div>
        <div style="display:flex; gap:10px; align-items:flex-start; flex-shrink:0;">
          <button class="modal-save-btn" id="modal-save-btn" onclick="toggleSaveFromModal()">&#9733; Save</button>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"><span class="toast-icon"></span><span id="toast-text"></span></div>

  <script>
    // ─── Embedded Database ───────────────────────────────────
    const DATABASE = {
      "schools": [
        {"id": 1, "scorecardId": 166027, "name": "Massachusetts Institute of Technology", "city": "Cambridge", "state": "MA", "zip": "02139", "website": "https://www.mit.edu", "type": "Private Nonprofit", "size": "Large"},
        {"id": 2, "scorecardId": 166683, "name": "Stanford University", "city": "Stanford", "state": "CA", "zip": "94305", "website": "https://www.stanford.edu", "type": "Private Nonprofit", "size": "Large"},
        {"id": 3, "scorecardId": 243744, "name": "University of Washington", "city": "Seattle", "state": "WA", "zip": "98195", "website": "https://www.washington.edu", "type": "Public", "size": "Large"},
        {"id": 4, "scorecardId": 110635, "name": "University of California-Berkeley", "city": "Berkeley", "state": "CA", "zip": "94720", "website": "https://www.berkeley.edu", "type": "Public", "size": "Large"},
        {"id": 5, "scorecardId": 186131, "name": "New York University", "city": "New York", "state": "NY", "zip": "10012", "website": "https://www.nyu.edu", "type": "Private Nonprofit", "size": "Large"},
        {"id": 6, "scorecardId": 170976, "name": "University of Michigan-Ann Arbor", "city": "Ann Arbor", "state": "MI", "zip": "48109", "website": "https://umich.edu", "type": "Public", "size": "Large"},
        {"id": 7, "scorecardId": 139959, "name": "Georgia Institute of Technology", "city": "Atlanta", "state": "GA", "zip": "30332", "website": "https://www.gatech.edu", "type": "Public", "size": "Large"},
        {"id": 8, "scorecardId": 228778, "name": "University of Texas at Austin", "city": "Austin", "state": "TX", "zip": "78712", "website": "https://www.utexas.edu", "type": "Public", "size": "Large"},
        {"id": 9, "scorecardId": 144050, "name": "University of Illinois Urbana-Champaign", "city": "Champaign", "state": "IL", "zip": "61820", "website": "https://illinois.edu", "type": "Public", "size": "Large"},
        {"id": 10, "scorecardId": 123961, "name": "University of Southern California", "city": "Los Angeles", "state": "CA", "zip": "90089", "website": "https://www.usc.edu", "type": "Private Nonprofit", "size": "Large"},
        {"id": 11, "scorecardId": 190150, "name": "Columbia University", "city": "New York", "state": "NY", "zip": "10027", "website": "https://www.columbia.edu", "type": "Private Nonprofit", "size": "Large"},
        {"id": 12, "scorecardId": 215062, "name": "Carnegie Mellon University", "city": "Pittsburgh", "state": "PA", "zip": "15213", "website": "https://www.cmu.edu", "type": "Private Nonprofit", "size": "Medium"},
        {"id": 13, "scorecardId": 130794, "name": "Yale University", "city": "New Haven", "state": "CT", "zip": "06520", "website": "https://www.yale.edu", "type": "Private Nonprofit", "size": "Medium"},
        {"id": 14, "scorecardId": 147767, "name": "Northwestern University", "city": "Evanston", "state": "IL", "zip": "60208", "website": "https://www.northwestern.edu", "type": "Private Nonprofit", "size": "Large"},
        {"id": 15, "scorecardId": 131496, "name": "Georgetown University", "city": "Washington", "state": "DC", "zip": "20057", "website": "https://www.georgetown.edu", "type": "Private Nonprofit", "size": "Medium"}
      ],
      "programs": [
        {"id": 1, "schoolId": 1, "name": "Computer Science", "degreeType": "Masters", "department": "Electrical Engineering and Computer Science", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 58240, "tuitionOutState": 58240, "website": null},
        {"id": 2, "schoolId": 1, "name": "Data Science", "degreeType": "Masters", "department": "Institute for Data, Systems, and Society", "cipCode": "3070", "description": null, "duration": "1 year", "format": "On-campus", "tuitionInState": 58240, "tuitionOutState": 58240, "website": null},
        {"id": 3, "schoolId": 1, "name": "Mechanical Engineering", "degreeType": "Masters", "department": "Mechanical Engineering", "cipCode": "1419", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 58240, "tuitionOutState": 58240, "website": null},
        {"id": 4, "schoolId": 1, "name": "MBA (Sloan)", "degreeType": "Masters", "department": "Sloan School of Management", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 82000, "tuitionOutState": 82000, "website": null},
        {"id": 5, "schoolId": 2, "name": "Computer Science", "degreeType": "Masters", "department": "School of Engineering", "cipCode": "1107", "description": null, "duration": "1.5-2 years", "format": "On-campus", "tuitionInState": 57861, "tuitionOutState": 57861, "website": null},
        {"id": 6, "schoolId": 2, "name": "Electrical Engineering", "degreeType": "Masters", "department": "School of Engineering", "cipCode": "1410", "description": null, "duration": "1.5-2 years", "format": "On-campus", "tuitionInState": 57861, "tuitionOutState": 57861, "website": null},
        {"id": 7, "schoolId": 2, "name": "MBA (GSB)", "degreeType": "Masters", "department": "Graduate School of Business", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 78444, "tuitionOutState": 78444, "website": null},
        {"id": 8, "schoolId": 2, "name": "Public Policy", "degreeType": "Masters", "department": "School of Humanities and Sciences", "cipCode": "4405", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 57861, "tuitionOutState": 57861, "website": null},
        {"id": 9, "schoolId": 3, "name": "Computer Science & Engineering", "degreeType": "Masters", "department": "Paul G. Allen School", "cipCode": "1107", "description": null, "duration": "1.5-2 years", "format": "On-campus", "tuitionInState": 19584, "tuitionOutState": 35262, "website": null},
        {"id": 10, "schoolId": 3, "name": "Data Science", "degreeType": "Masters", "department": "eScience Institute", "cipCode": "3070", "description": null, "duration": "1.5 years", "format": "On-campus", "tuitionInState": 19584, "tuitionOutState": 35262, "website": null},
        {"id": 11, "schoolId": 3, "name": "Public Health (MPH)", "degreeType": "Masters", "department": "School of Public Health", "cipCode": "5122", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 19584, "tuitionOutState": 35262, "website": null},
        {"id": 12, "schoolId": 4, "name": "Computer Science", "degreeType": "Masters", "department": "Electrical Engineering and Computer Sciences", "cipCode": "1107", "description": null, "duration": "1-2 years", "format": "On-campus", "tuitionInState": 14312, "tuitionOutState": 29414, "website": null},
        {"id": 13, "schoolId": 4, "name": "Information Management & Systems (MIMS)", "degreeType": "Masters", "department": "School of Information", "cipCode": "1104", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 14312, "tuitionOutState": 29414, "website": null},
        {"id": 14, "schoolId": 4, "name": "MBA (Haas)", "degreeType": "Masters", "department": "Haas School of Business", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 68444, "tuitionOutState": 73444, "website": null},
        {"id": 15, "schoolId": 5, "name": "Data Science", "degreeType": "Masters", "department": "Center for Data Science", "cipCode": "3070", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 62520, "tuitionOutState": 62520, "website": null},
        {"id": 16, "schoolId": 5, "name": "Computer Science", "degreeType": "Masters", "department": "Courant Institute of Mathematical Sciences", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 62520, "tuitionOutState": 62520, "website": null},
        {"id": 17, "schoolId": 5, "name": "MBA (Stern)", "degreeType": "Masters", "department": "Stern School of Business", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 80364, "tuitionOutState": 80364, "website": null},
        {"id": 18, "schoolId": 5, "name": "Public Health (MPH)", "degreeType": "Masters", "department": "School of Global Public Health", "cipCode": "5122", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 55820, "tuitionOutState": 55820, "website": null},
        {"id": 19, "schoolId": 6, "name": "Computer Science & Engineering", "degreeType": "Masters", "department": "College of Engineering", "cipCode": "1107", "description": null, "duration": "1-2 years", "format": "On-campus", "tuitionInState": 27756, "tuitionOutState": 52994, "website": null},
        {"id": 20, "schoolId": 6, "name": "Data Science (MADS)", "degreeType": "Masters", "department": "School of Information", "cipCode": "3070", "description": null, "duration": "1-3 years", "format": "Online", "tuitionInState": 34356, "tuitionOutState": 34356, "website": null},
        {"id": 21, "schoolId": 6, "name": "MBA (Ross)", "degreeType": "Masters", "department": "Stephen M. Ross School of Business", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 75410, "tuitionOutState": 75410, "website": null},
        {"id": 22, "schoolId": 6, "name": "Public Policy (MPP)", "degreeType": "Masters", "department": "Gerald R. Ford School of Public Policy", "cipCode": "4405", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 28590, "tuitionOutState": 52590, "website": null},
        {"id": 23, "schoolId": 7, "name": "Computer Science", "degreeType": "Masters", "department": "College of Computing", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 13788, "tuitionOutState": 29140, "website": null},
        {"id": 24, "schoolId": 7, "name": "Computer Science (OMSCS)", "degreeType": "Masters", "department": "College of Computing", "cipCode": "1107", "description": null, "duration": "1-4 years", "format": "Online", "tuitionInState": 7000, "tuitionOutState": 7000, "website": null},
        {"id": 25, "schoolId": 7, "name": "Analytics", "degreeType": "Masters", "department": "Interdisciplinary", "cipCode": "3070", "description": null, "duration": "1 year", "format": "On-campus", "tuitionInState": 20790, "tuitionOutState": 43046, "website": null},
        {"id": 26, "schoolId": 7, "name": "Cybersecurity", "degreeType": "Masters", "department": "College of Computing", "cipCode": "1110", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 13788, "tuitionOutState": 29140, "website": null},
        {"id": 27, "schoolId": 8, "name": "Computer Science", "degreeType": "Masters", "department": "College of Natural Sciences", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 11448, "tuitionOutState": 22194, "website": null},
        {"id": 28, "schoolId": 8, "name": "Data Science (MSDS)", "degreeType": "Masters", "department": "College of Natural Sciences", "cipCode": "3070", "description": null, "duration": "1.5 years", "format": "Online", "tuitionInState": 10000, "tuitionOutState": 10000, "website": null},
        {"id": 29, "schoolId": 8, "name": "MBA (McCombs)", "degreeType": "Masters", "department": "McCombs School of Business", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 56000, "tuitionOutState": 56000, "website": null},
        {"id": 30, "schoolId": 9, "name": "Computer Science (MCS)", "degreeType": "Masters", "department": "Grainger College of Engineering", "cipCode": "1107", "description": null, "duration": "1.5 years", "format": "On-campus", "tuitionInState": 17700, "tuitionOutState": 35500, "website": null},
        {"id": 31, "schoolId": 9, "name": "Computer Science (MCS-DS)", "degreeType": "Masters", "department": "Grainger College of Engineering", "cipCode": "1107", "description": null, "duration": "1-3 years", "format": "Online", "tuitionInState": 21440, "tuitionOutState": 21440, "website": null},
        {"id": 32, "schoolId": 9, "name": "Information Management", "degreeType": "Masters", "department": "School of Information Sciences", "cipCode": "1104", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 14500, "tuitionOutState": 28500, "website": null},
        {"id": 33, "schoolId": 10, "name": "Computer Science", "degreeType": "Masters", "department": "Viterbi School of Engineering", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 62984, "tuitionOutState": 62984, "website": null},
        {"id": 34, "schoolId": 10, "name": "Data Science", "degreeType": "Masters", "department": "Viterbi School of Engineering", "cipCode": "3070", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 62984, "tuitionOutState": 62984, "website": null},
        {"id": 35, "schoolId": 10, "name": "Social Work (MSW)", "degreeType": "Masters", "department": "Suzanne Dworak-Peck School of Social Work", "cipCode": "4407", "description": null, "duration": "2 years", "format": "Hybrid", "tuitionInState": 55000, "tuitionOutState": 55000, "website": null},
        {"id": 36, "schoolId": 11, "name": "Computer Science", "degreeType": "Masters", "department": "Fu Foundation School of Engineering", "cipCode": "1107", "description": null, "duration": "1.5 years", "format": "On-campus", "tuitionInState": 62640, "tuitionOutState": 62640, "website": null},
        {"id": 37, "schoolId": 11, "name": "Data Science", "degreeType": "Masters", "department": "Data Science Institute", "cipCode": "3070", "description": null, "duration": "1.5 years", "format": "On-campus", "tuitionInState": 62640, "tuitionOutState": 62640, "website": null},
        {"id": 38, "schoolId": 11, "name": "MBA", "degreeType": "Masters", "department": "Columbia Business School", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 84496, "tuitionOutState": 84496, "website": null},
        {"id": 39, "schoolId": 11, "name": "Journalism", "degreeType": "Masters", "department": "Graduate School of Journalism", "cipCode": "0904", "description": null, "duration": "1 year", "format": "On-campus", "tuitionInState": 62640, "tuitionOutState": 62640, "website": null},
        {"id": 40, "schoolId": 12, "name": "Computer Science", "degreeType": "Masters", "department": "School of Computer Science", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 53000, "tuitionOutState": 53000, "website": null},
        {"id": 41, "schoolId": 12, "name": "Artificial Intelligence (MSAII)", "degreeType": "Masters", "department": "School of Computer Science", "cipCode": "1107", "description": null, "duration": "16 months", "format": "On-campus", "tuitionInState": 53000, "tuitionOutState": 53000, "website": null},
        {"id": 42, "schoolId": 12, "name": "Information Technology (MSIT)", "degreeType": "Masters", "department": "School of Computer Science", "cipCode": "1104", "description": null, "duration": "16 months", "format": "On-campus", "tuitionInState": 50000, "tuitionOutState": 50000, "website": null},
        {"id": 43, "schoolId": 12, "name": "Public Policy & Management (MSPPM)", "degreeType": "Masters", "department": "Heinz College", "cipCode": "4405", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 55000, "tuitionOutState": 55000, "website": null},
        {"id": 44, "schoolId": 13, "name": "Computer Science", "degreeType": "Masters", "department": "School of Engineering & Applied Science", "cipCode": "1107", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 46900, "tuitionOutState": 46900, "website": null},
        {"id": 45, "schoolId": 13, "name": "MBA", "degreeType": "Masters", "department": "Yale School of Management", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 79500, "tuitionOutState": 79500, "website": null},
        {"id": 46, "schoolId": 13, "name": "Public Health (MPH)", "degreeType": "Masters", "department": "Yale School of Public Health", "cipCode": "5122", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 46900, "tuitionOutState": 46900, "website": null},
        {"id": 47, "schoolId": 14, "name": "Computer Science", "degreeType": "Masters", "department": "McCormick School of Engineering", "cipCode": "1107", "description": null, "duration": "1.5 years", "format": "On-campus", "tuitionInState": 60984, "tuitionOutState": 60984, "website": null},
        {"id": 48, "schoolId": 14, "name": "Data Science (MSiA)", "degreeType": "Masters", "department": "McCormick School of Engineering", "cipCode": "3070", "description": null, "duration": "15 months", "format": "On-campus", "tuitionInState": 72000, "tuitionOutState": 72000, "website": null},
        {"id": 49, "schoolId": 14, "name": "MBA (Kellogg)", "degreeType": "Masters", "department": "Kellogg School of Management", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 78276, "tuitionOutState": 78276, "website": null},
        {"id": 50, "schoolId": 14, "name": "Journalism (MSJ)", "degreeType": "Masters", "department": "Medill School of Journalism", "cipCode": "0904", "description": null, "duration": "1 year", "format": "On-campus", "tuitionInState": 60984, "tuitionOutState": 60984, "website": null},
        {"id": 51, "schoolId": 15, "name": "Data Science & Analytics", "degreeType": "Masters", "department": "Graduate School of Arts & Sciences", "cipCode": "3070", "description": null, "duration": "1 year", "format": "On-campus", "tuitionInState": 57240, "tuitionOutState": 57240, "website": null},
        {"id": 52, "schoolId": 15, "name": "Public Policy (MPP)", "degreeType": "Masters", "department": "McCourt School of Public Policy", "cipCode": "4405", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 57240, "tuitionOutState": 57240, "website": null},
        {"id": 53, "schoolId": 15, "name": "MBA (McDonough)", "degreeType": "Masters", "department": "McDonough School of Business", "cipCode": "5202", "description": null, "duration": "2 years", "format": "On-campus", "tuitionInState": 64800, "tuitionOutState": 64800, "website": null}
      ],
      "requirements": [
        {"id":1,"programId":1,"minGpa":3.5,"gpaScale":4,"greRequired":"Required","greVerbalMin":160,"greQuantMin":165,"greWritingMin":4.5,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Undergraduate degree in CS or related field, strong math background","otherRequirements":"Research statement, coding portfolio recommended","applicationFee":75,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":"Highly competitive; most admits have research experience","essayDetails":"Statement of Objectives (1-2 pages): Describe your research interests, relevant experience, and goals. Research statement and coding portfolio recommended.","lorDetails":"3 letters required. Should be from professors or research supervisors who can speak to your technical abilities and research potential.","cvDetails":"Academic CV required: Include research experience, publications, projects, technical skills, and relevant coursework.","transcriptDetails":"Official transcripts from all post-secondary institutions. Electronic transcripts accepted during review; hard copies upon admission.","languageTestDetails":"TOEFL iBT: 100+ (all sections 23+) | IELTS: 7.0+ | Duolingo: Not accepted. Waived if prior degree from English-speaking institution."},
        {"id":2,"programId":2,"minGpa":3.5,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Linear algebra, probability, statistics, programming proficiency","otherRequirements":null,"applicationFee":75,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":"Interdisciplinary program; admits from engineering, math, and science backgrounds","essayDetails":"Statement of Purpose (1-2 pages): Describe your interest in data science, relevant background, and career goals.","lorDetails":"3 letters required. At least one academic reference preferred; professional references accepted for industry applicants.","cvDetails":"Resume/CV required: Highlight quantitative skills, programming experience, and relevant projects.","transcriptDetails":"Official transcripts from all institutions attended.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+ | Waived if prior degree from English-speaking institution."},
        {"id":3,"programId":3,"minGpa":3.5,"gpaScale":4,"greRequired":"Required","greVerbalMin":155,"greQuantMin":165,"greWritingMin":4,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"BS in Mechanical Engineering or related field","otherRequirements":"Research interests statement","applicationFee":75,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): Research interests and career objectives. Describe relevant lab or industry experience.","lorDetails":"3 letters required from professors or research/industry supervisors familiar with your engineering work.","cvDetails":"Academic CV required: Include research, publications, design projects, and technical skills.","transcriptDetails":"Official transcripts from all post-secondary institutions attended.","languageTestDetails":"TOEFL iBT: 100+ (all sections 23+) | IELTS: 7.0+"},
        {"id":4,"programId":4,"minGpa":3.5,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"5+ years recommended","prerequisites":null,"otherRequirements":"Video statement, organizational chart, cover letter","applicationFee":250,"fallDeadline":"January 18","springDeadline":null,"rollingAdmissions":false,"notes":"Median GMAT: 730; average work experience: 5 years","essayDetails":"Cover Letter (1 page): Describe what you would contribute. Video Statement (1 min): Introduce yourself. Organizational Chart required.","lorDetails":"2 professional letters required. Should be from direct supervisors who can evaluate leadership and teamwork.","cvDetails":"Professional resume required: Employment history with dates, titles, responsibilities. Leadership and extracurricular activities.","transcriptDetails":"Official transcripts from all institutions. WES evaluation not required for international transcripts.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+ | Waived for degrees taught entirely in English."},
        {"id":5,"programId":5,"minGpa":3.6,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Strong background in CS, math, and programming","otherRequirements":null,"applicationFee":125,"fallDeadline":"December 5","springDeadline":null,"rollingAdmissions":false,"notes":"GRE suspended; ~2% acceptance rate for MS program","essayDetails":"Statement of Purpose (1-2 pages): Your CS interests, research experience, and career goals. No supplemental essays required.","lorDetails":"3 letters required. Strong preference for academic references who can evaluate research potential.","cvDetails":"Resume/CV required: Academic and professional experience, publications, technical projects, and skills.","transcriptDetails":"Unofficial transcripts for review; official required upon admission. Self-reported transcripts accepted initially.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+ | GRE suspended for admissions cycle."},
        {"id":6,"programId":6,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"BS in EE or related field, strong math and physics","otherRequirements":null,"applicationFee":125,"fallDeadline":"December 5","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): Research interests in electrical engineering and career goals.","lorDetails":"3 letters required from academic or research supervisors.","cvDetails":"Resume/CV required: Research, projects, technical skills, and relevant coursework.","transcriptDetails":"Unofficial transcripts for review; official required upon admission.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":7,"programId":7,"minGpa":3.7,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"4+ years recommended","prerequisites":null,"otherRequirements":"Essays, short-answer questions","applicationFee":275,"fallDeadline":"January 6","springDeadline":null,"rollingAdmissions":false,"notes":"Most selective MBA program globally; ~6% acceptance rate","essayDetails":"Essay A: What matters most to you, and why? (unlimited length) | Essay B: Why Stanford? (unlimited length). Short-answer questions also required.","lorDetails":"2 letters required. At least one from current direct supervisor. Recommenders answer structured questions about leadership.","cvDetails":"Professional resume required: Full employment history, education, activities, honors.","transcriptDetails":"Official transcripts from all institutions. WES or ECE evaluation recommended for international degrees.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+ | PTE: 68+"},
        {"id":8,"programId":8,"minGpa":3.4,"gpaScale":4,"greRequired":"Required","greVerbalMin":160,"greQuantMin":155,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"2+ years recommended","prerequisites":"Statistics or economics coursework","otherRequirements":null,"applicationFee":125,"fallDeadline":"December 1","springDeadline":null,"rollingAdmissions":false,"notes":"Policy analysis focus with quantitative emphasis","essayDetails":"Statement of Purpose (2 pages): Policy interests, relevant experience, and career goals. Describe quantitative and analytical preparation.","lorDetails":"3 letters required. Mix of academic and professional references preferred.","cvDetails":"Resume/CV required: Policy work, research, leadership, and community engagement.","transcriptDetails":"Official transcripts from all institutions attended.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":9,"programId":9,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":92,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Data structures, algorithms, systems, math","otherRequirements":null,"applicationFee":85,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":"Professional Masters (PMP) also available","essayDetails":"Personal Statement (1-2 pages): Research interests, technical background, and career objectives.","lorDetails":"3 letters required. Academic references preferred; professional references acceptable for industry applicants.","cvDetails":"Resume/CV required: Academic background, projects, publications, work experience.","transcriptDetails":"Official transcripts from all institutions. International transcripts may require WES evaluation.","languageTestDetails":"TOEFL iBT: 92+ (all sections 20+) | IELTS: 7.0+"},
        {"id":10,"programId":10,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":92,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Preferred but not required","prerequisites":"Programming, statistics, linear algebra","otherRequirements":null,"applicationFee":85,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1 page): Why data science, relevant experience, and career aspirations.","lorDetails":"3 letters required. At least one academic; professional references welcome.","cvDetails":"Resume/CV required: Quantitative skills, programming experience, data projects.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 92+ | IELTS: 7.0+"},
        {"id":11,"programId":11,"minGpa":3,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":92,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Public health experience recommended","prerequisites":"Biology, statistics recommended","otherRequirements":null,"applicationFee":85,"fallDeadline":"December 1","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Personal Statement (750 words): Public health interests, relevant experience, and how MPH fits career goals. Diversity statement optional.","lorDetails":"3 letters required. One academic, two professional or academic. Should address public health aptitude.","cvDetails":"Resume/CV required: Public health experience, volunteer work, leadership, research.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 92+ | IELTS: 7.0+"},
        {"id":12,"programId":12,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Strong undergraduate CS background required","otherRequirements":null,"applicationFee":140,"fallDeadline":"December 8","springDeadline":null,"rollingAdmissions":false,"notes":"Professional MS program (5th Year MS for Berkeley students)","essayDetails":"Statement of Purpose (1-2 pages): Research interests and academic/professional goals. Personal History Statement also required.","lorDetails":"3 letters required. Strong academic references critical; research supervisors ideal.","cvDetails":"Resume/CV required: Research, publications, technical projects, coursework highlights.","transcriptDetails":"Unofficial transcripts for review. Official transcripts from all institutions required upon admission.","languageTestDetails":"TOEFL iBT: 90+ | IELTS: 7.0+"},
        {"id":13,"programId":13,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Relevant experience preferred","prerequisites":null,"otherRequirements":"Video essay, written essays","applicationFee":140,"fallDeadline":"January 6","springDeadline":null,"rollingAdmissions":false,"notes":"Interdisciplinary program: technology, people, and policy","essayDetails":"Statement of Purpose (1-2 pages): Why MIMS, career goals. Personal History Statement. Video essay and written essays also required.","lorDetails":"3 letters required. Academic or professional references who know your analytical and collaborative work.","cvDetails":"Resume/CV required: Technical and non-technical experience, projects, skills.","transcriptDetails":"Unofficial transcripts for review; official upon admission.","languageTestDetails":"TOEFL iBT: 90+ | IELTS: 7.0+"},
        {"id":14,"programId":14,"minGpa":3.6,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"5+ years recommended","prerequisites":null,"otherRequirements":"Short answer questions, optional essay","applicationFee":200,"fallDeadline":"January 4","springDeadline":null,"rollingAdmissions":false,"notes":"Culture-focused program; median GMAT ~730","essayDetails":"Essay 1: What makes you feel alive? | Essay 2: What is something you've done that you're most proud of? Short-answer questions on goals.","lorDetails":"2 letters required. One professional, one of your choice. Structured evaluation form.","cvDetails":"Professional resume required: Full work history, education, activities.","transcriptDetails":"Official transcripts from all institutions. WES evaluation recommended for international degrees.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":15,"programId":15,"minGpa":3.3,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Calculus, linear algebra, probability, programming (Python)","otherRequirements":"Video introduction","applicationFee":80,"fallDeadline":"January 24","springDeadline":null,"rollingAdmissions":false,"notes":"One of the first dedicated Data Science MS programs in the US","essayDetails":"Statement of Purpose (1-2 pages): Data science interests, technical background, and career goals. Video introduction also required.","lorDetails":"3 letters required. At least two academic references preferred.","cvDetails":"Resume/CV required: Programming skills, coursework, quantitative projects.","transcriptDetails":"Official transcripts from all institutions. WES evaluation for international transcripts.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+ | Duolingo: 125+"},
        {"id":16,"programId":16,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Data structures, algorithms, OS, computer architecture","otherRequirements":null,"applicationFee":80,"fallDeadline":"February 1","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): CS interests and career goals.","lorDetails":"3 letters required. Academic references who can evaluate technical and research abilities.","cvDetails":"Resume/CV required: Technical skills, projects, research experience.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":17,"programId":17,"minGpa":3.5,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"5+ years recommended","prerequisites":null,"otherRequirements":"Personal expression video, essay","applicationFee":250,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"NYC location; strong finance and tech placement","essayDetails":"Essay 1: Professional aspirations (500 words). Personal Expression: Video or written (additional). Short-answer: Why Stern?","lorDetails":"2 letters required. Professional references from direct supervisors preferred.","cvDetails":"Professional resume required: Full employment history, leadership activities, education.","transcriptDetails":"Official transcripts from all institutions. WES evaluation for international degrees.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":18,"programId":18,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Public health or healthcare experience recommended","prerequisites":"Biology, statistics","otherRequirements":null,"applicationFee":80,"fallDeadline":"February 1","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Personal Statement (750 words): Public health career goals, relevant experience, and why NYU.","lorDetails":"3 letters required. Academic or professional references with knowledge of your public health interests.","cvDetails":"Resume/CV required: Healthcare/public health experience, volunteer work, research.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":19,"programId":19,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":84,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Algorithms, data structures, programming, math","otherRequirements":null,"applicationFee":90,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"Professional and research-track options available","essayDetails":"Statement of Purpose (1-2 pages): Research interests, relevant experience, and career goals in CS.","lorDetails":"3 letters required. Academic references with knowledge of your CS background.","cvDetails":"Resume/CV required: Research, projects, publications, technical skills.","transcriptDetails":"Official transcripts from all institutions. WES or ECE evaluation for international transcripts.","languageTestDetails":"TOEFL iBT: 84+ (23+ each section) | IELTS: 6.5+ (6.5+ each section)"},
        {"id":20,"programId":20,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":84,"ieltsMin":6.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Statistics, Python programming, math","otherRequirements":null,"applicationFee":75,"fallDeadline":"Rolling","springDeadline":null,"rollingAdmissions":true,"notes":"Fully online program; flexible pacing","essayDetails":"Personal Statement (500 words): Why MADS, your data science goals, and relevant experience.","lorDetails":"2 letters required. Academic or professional. At least one who can speak to analytical abilities.","cvDetails":"Resume/CV required: Data skills, programming experience, professional background.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 84+ | IELTS: 6.5+"},
        {"id":21,"programId":21,"minGpa":3.5,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"4-6 years recommended","prerequisites":null,"otherRequirements":"Short essays, team-based experiences","applicationFee":200,"fallDeadline":"January 3","springDeadline":null,"rollingAdmissions":false,"notes":"Action-based learning approach","essayDetails":"Short-answer: Career goals (100 words). Essay: Tell us about a time you led a team (300 words). Additional optional essay.","lorDetails":"2 letters required. Professional references from supervisors who can assess leadership and teamwork.","cvDetails":"Professional resume required: Employment, leadership, community involvement.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+ | Duolingo: 130+"},
        {"id":22,"programId":22,"minGpa":3.3,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":84,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Professional experience preferred","prerequisites":"Economics and statistics recommended","otherRequirements":null,"applicationFee":75,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): Policy interests, career goals, why Ford School.","lorDetails":"3 letters required. Academic or professional. Policy-related references valued.","cvDetails":"Resume/CV required: Policy work, research, community engagement, leadership.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 84+ | IELTS: 6.5+"},
        {"id":23,"programId":23,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Undergraduate CS degree or equivalent","otherRequirements":null,"applicationFee":85,"fallDeadline":"February 1","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (2 pages max): Research interests, background, and career goals in computer science.","lorDetails":"3 letters required. Academic references strongly preferred for on-campus program.","cvDetails":"Resume/CV required: Research, projects, publications, technical skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ (all sections 19+) | IELTS: 7.5+"},
        {"id":24,"programId":24,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Undergraduate CS background, programming experience","otherRequirements":null,"applicationFee":85,"fallDeadline":"March 1","springDeadline":"August 1","rollingAdmissions":false,"notes":"Groundbreaking affordable online MS; ~$7,000 total cost","essayDetails":"Background Statement (1 page): Describe your CS background. Goals Statement (1 page): Career aspirations and how OMSCS fits.","lorDetails":"3 letters required. Professional or academic. Should speak to CS aptitude and readiness for graduate study.","cvDetails":"Resume/CV required: Technical experience, programming skills, education.","transcriptDetails":"Official transcripts from all institutions. International transcripts accepted without WES.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+ | Duolingo: 115+ | Waived for US degree holders."},
        {"id":25,"programId":25,"minGpa":3.3,"gpaScale":4,"greRequired":"Recommended","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Preferred but not required","prerequisites":"Programming, statistics, linear algebra, calculus","otherRequirements":null,"applicationFee":85,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (500 words): Interest in analytics, relevant background, career goals.","lorDetails":"3 letters required. At least one academic; industry references welcome.","cvDetails":"Resume/CV required: Analytical skills, programming, quantitative experience.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":26,"programId":26,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Computer science or engineering background","otherRequirements":null,"applicationFee":85,"fallDeadline":"February 1","springDeadline":null,"rollingAdmissions":false,"notes":"Interdisciplinary: CS, public policy, and information security","essayDetails":"Statement of Purpose (2 pages max): Cybersecurity interests, technical background, and goals.","lorDetails":"3 letters required. Academic or professional references who can speak to your technical capabilities.","cvDetails":"Resume/CV required: Security experience, technical projects, certifications.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":27,"programId":27,"minGpa":3.3,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":79,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Strong CS undergraduate background","otherRequirements":null,"applicationFee":90,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): CS research interests and career objectives.","lorDetails":"3 letters required. Academic references who can assess research potential and technical abilities.","cvDetails":"Resume/CV required: Research, projects, publications, relevant experience.","transcriptDetails":"Official transcripts from all institutions. International transcripts may need WES evaluation.","languageTestDetails":"TOEFL iBT: 79+ | IELTS: 6.5+"},
        {"id":28,"programId":28,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":79,"ieltsMin":6.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Calculus, linear algebra, statistics, Python","otherRequirements":null,"applicationFee":65,"fallDeadline":"Rolling","springDeadline":null,"rollingAdmissions":true,"notes":"Affordable online program; ~$10,000 total cost","essayDetails":"Personal Statement (500 words): Why data science, relevant background, and career aspirations.","lorDetails":"2 letters required. Academic or professional references.","cvDetails":"Resume/CV required: Data experience, programming skills, professional background.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 79+ | IELTS: 6.5+"},
        {"id":29,"programId":29,"minGpa":3.4,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"4-6 years recommended","prerequisites":null,"otherRequirements":"Video essays, written essays","applicationFee":200,"fallDeadline":"January 5","springDeadline":null,"rollingAdmissions":false,"notes":"Strong tech and energy sector placement in Austin market","essayDetails":"Essay 1: Describe your short-term and long-term career goals (500 words). Video essays and written essays required.","lorDetails":"2 letters required. Professional supervisors preferred. Structured recommendation form.","cvDetails":"Professional resume required: Full work history, leadership, activities.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":30,"programId":30,"minGpa":3.2,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":96,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"CS degree or equivalent coursework","otherRequirements":null,"applicationFee":70,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1 page): CS interests, preparation, and career goals.","lorDetails":"3 letters required. Academic references who can speak to CS coursework and research abilities.","cvDetails":"Resume/CV required: CS projects, research, technical skills, work experience.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 96+ (all sections 22+) | IELTS: 6.5+ (all sections 6.0+)"},
        {"id":31,"programId":31,"minGpa":3.2,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":96,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Data structures, algorithms, linear algebra, probability","otherRequirements":null,"applicationFee":70,"fallDeadline":"Rolling","springDeadline":null,"rollingAdmissions":true,"notes":"Flexible online format via Coursera","essayDetails":"Statement of Purpose (500 words): Interest in data science, relevant background, career goals.","lorDetails":"3 letters required. Academic or professional references.","cvDetails":"Resume/CV required: Technical experience, data skills, programming background.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 96+ | IELTS: 6.5+"},
        {"id":32,"programId":32,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":96,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":null,"otherRequirements":null,"applicationFee":70,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"ALA-accredited with specialization tracks","essayDetails":"Statement of Purpose (1-2 pages): Interest in information science, career goals.","lorDetails":"3 letters required. Academic or professional references.","cvDetails":"Resume/CV required: Relevant experience, technical and interpersonal skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 96+ | IELTS: 6.5+"},
        {"id":33,"programId":33,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"BS in CS or related field","otherRequirements":null,"applicationFee":90,"fallDeadline":"December 15","springDeadline":null,"rollingAdmissions":false,"notes":"Multiple specialization tracks: AI, games, security, systems","essayDetails":"Statement of Purpose (1-2 pages): CS interests, specialization preference, and career goals.","lorDetails":"3 letters required. Academic references who can assess technical and research abilities.","cvDetails":"Resume/CV required: Research, projects, internships, technical skills.","transcriptDetails":"Official transcripts from all institutions. WES evaluation for international degrees.","languageTestDetails":"TOEFL iBT: 90+ (all sections 20+) | IELTS: 6.5+ (all sections 6.0+)"},
        {"id":34,"programId":34,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Statistics, programming, linear algebra","otherRequirements":null,"applicationFee":90,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"Applied data science focus with industry practicum","essayDetails":"Statement of Purpose (1-2 pages): Data science interests, quantitative background, and career aspirations.","lorDetails":"3 letters required. Academic or professional references with knowledge of your analytical abilities.","cvDetails":"Resume/CV required: Programming, data analysis, relevant projects and coursework.","transcriptDetails":"Official transcripts from all institutions. WES evaluation for international degrees.","languageTestDetails":"TOEFL iBT: 90+ | IELTS: 6.5+"},
        {"id":35,"programId":35,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":6.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Community or volunteer experience recommended","prerequisites":null,"otherRequirements":null,"applicationFee":90,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Personal Statement (3-5 pages): Social work values, relevant experience, populations of interest, career goals. Diversity essay also required.","lorDetails":"3 letters required. Should address interpersonal skills, commitment to social justice, and readiness for graduate study.","cvDetails":"Resume/CV required: Social services experience, volunteer work, community engagement, leadership.","transcriptDetails":"Official transcripts from all institutions. WES evaluation for international degrees.","languageTestDetails":"TOEFL iBT: 90+ | IELTS: 6.5+"},
        {"id":36,"programId":36,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":101,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"CS fundamentals, discrete math, data structures","otherRequirements":null,"applicationFee":110,"fallDeadline":"February 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): CS research interests and career goals. No additional essays required.","lorDetails":"3 letters required. Academic references strongly preferred who can evaluate technical and research potential.","cvDetails":"Resume/CV required: Research, publications, technical projects, skills.","transcriptDetails":"Official transcripts from all institutions. WES evaluation recommended for international degrees.","languageTestDetails":"TOEFL iBT: 101+ | IELTS: 7.5+"},
        {"id":37,"programId":37,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":101,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Calculus, linear algebra, probability, Python or R","otherRequirements":null,"applicationFee":110,"fallDeadline":"February 15","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Academic Purpose (1-2 pages): Data science interests, quantitative preparation, career goals.","lorDetails":"3 letters required. At least two academic. Should address quantitative and analytical skills.","cvDetails":"Resume/CV required: Technical skills, data projects, programming proficiency.","transcriptDetails":"Official transcripts from all institutions. WES evaluation recommended for international degrees.","languageTestDetails":"TOEFL iBT: 101+ | IELTS: 7.5+"},
        {"id":38,"programId":38,"minGpa":3.6,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"5+ years recommended","prerequisites":null,"otherRequirements":"Essays, video questions","applicationFee":250,"fallDeadline":"January 5","springDeadline":null,"rollingAdmissions":false,"notes":"NYC location; strong finance and consulting placement","essayDetails":"Essay 1: Through your resume and recommendation, we have a clear sense of your achievements. What else would you like us to know? (500 words). Video essays on goals.","lorDetails":"2 letters required. Professional supervisors preferred. Structured questions about leadership and impact.","cvDetails":"Professional resume required: Complete employment history, education, activities, honors.","transcriptDetails":"Official transcripts from all institutions. WES or ECE evaluation for international degrees.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":39,"programId":39,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":114,"ieltsMin":8,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":null,"otherRequirements":"Writing samples, journalism experience","applicationFee":110,"fallDeadline":"January 10","springDeadline":null,"rollingAdmissions":false,"notes":"Ivy League journalism program; strong emphasis on digital media","essayDetails":"Personal Essay: Why journalism? (500 words). Writing samples: 3-5 published clips or academic writing samples required.","lorDetails":"3 letters required. At least one from journalism professional or editor. Academic references also accepted.","cvDetails":"Resume/CV required: Journalism experience, published work, media roles, relevant skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 114+ | IELTS: 8.0+ (highest requirements — strong English skills critical)"},
        {"id":40,"programId":40,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Excellent CS undergraduate background","otherRequirements":null,"applicationFee":125,"fallDeadline":"December 13","springDeadline":null,"rollingAdmissions":false,"notes":"Top-ranked CS program; multiple MS tracks available","essayDetails":"Statement of Purpose (2 pages max): Research interests, relevant experience, and career goals in CS.","lorDetails":"3 letters required. Academic references from CS faculty or research supervisors strongly preferred.","cvDetails":"Resume/CV required: Research, publications, projects, teaching experience, technical skills.","transcriptDetails":"Official transcripts from all institutions. No WES required; CMU evaluates international transcripts directly.","languageTestDetails":"TOEFL iBT: 100+ (all sections 25+) | IELTS: 7.5+"},
        {"id":41,"programId":41,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"3+ years industry experience strongly preferred","prerequisites":"Math, programming, statistics","otherRequirements":null,"applicationFee":125,"fallDeadline":"December 1","springDeadline":null,"rollingAdmissions":false,"notes":"Designed for industry professionals; includes capstone project","essayDetails":"Statement of Purpose (2 pages): AI interests, industry experience, and career goals. Describe specific AI problems you want to solve.","lorDetails":"3 letters required. Industry supervisors and academic references both valued. Should address AI/ML aptitude.","cvDetails":"Resume/CV required: AI/ML projects, industry experience (3+ years preferred), publications, technical skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":42,"programId":42,"minGpa":3.2,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Professional experience preferred","prerequisites":"Technical background","otherRequirements":null,"applicationFee":125,"fallDeadline":"January 10","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): IT interests, professional background, and career goals.","lorDetails":"3 letters required. Professional references welcome. Should address technical and collaborative skills.","cvDetails":"Resume/CV required: Professional experience, technical projects, skills, certifications.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":43,"programId":43,"minGpa":3.3,"gpaScale":4,"greRequired":"Required","greVerbalMin":155,"greQuantMin":155,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Quantitative coursework recommended","otherRequirements":null,"applicationFee":80,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"Data-driven policy program; strong analytics focus","essayDetails":"Essay 1: Career goals and how Heinz College fits (500 words). Essay 2: Describe a policy challenge you care about (500 words).","lorDetails":"3 letters required. Academic and/or professional. Should address analytical and leadership skills.","cvDetails":"Resume/CV required: Policy experience, quantitative work, community engagement.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":44,"programId":44,"minGpa":3.5,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Strong CS and math background","otherRequirements":null,"applicationFee":105,"fallDeadline":"January 2","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): Research interests and career goals in computer science.","lorDetails":"3 letters required. Academic references from CS professors strongly preferred.","cvDetails":"Resume/CV required: Research, publications, projects, relevant technical experience.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+ | Duolingo: 120+"},
        {"id":45,"programId":45,"minGpa":3.7,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"4-6 years recommended","prerequisites":null,"otherRequirements":"Video questions, behavioral assessment","applicationFee":250,"fallDeadline":"January 7","springDeadline":null,"rollingAdmissions":false,"notes":"Focus on leadership in business and society","essayDetails":"Essay: Describe the biggest commitment you have ever made (500 words). Video questions on leadership and values.","lorDetails":"2 letters required. Professional references. Behavioral assessment also required as part of application.","cvDetails":"Professional resume required: Full employment history, leadership roles, community involvement.","transcriptDetails":"Official transcripts from all institutions. WES or ECE evaluation for international degrees.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+ | PTE: 70+"},
        {"id":46,"programId":46,"minGpa":3.3,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Public health experience recommended","prerequisites":"Biology, statistics, and quantitative methods","otherRequirements":null,"applicationFee":105,"fallDeadline":"December 1","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Personal Statement (750 words): Public health interests, relevant experience, career goals. Describe specific health issues you want to address.","lorDetails":"3 letters required. Academic and/or professional. Should address public health aptitude and research skills.","cvDetails":"Resume/CV required: Public health experience, research, volunteer work, relevant skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.0+"},
        {"id":47,"programId":47,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":7,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"CS undergraduate background or bridge courses","otherRequirements":null,"applicationFee":95,"fallDeadline":"December 31","springDeadline":null,"rollingAdmissions":false,"notes":null,"essayDetails":"Statement of Purpose (1-2 pages): CS interests, technical background, and career goals.","lorDetails":"3 letters required. Academic references preferred for CS program.","cvDetails":"Resume/CV required: Technical projects, research, publications, skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 90+ | IELTS: 7.0+"},
        {"id":48,"programId":48,"minGpa":3.3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":90,"ieltsMin":7,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Programming, calculus, linear algebra, statistics","otherRequirements":"Industry practicum required","applicationFee":95,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"Analytics and AI focus; includes industry project","essayDetails":"Essay (500 words): Describe your interest in analytics and career aspirations. Industry practicum interest statement.","lorDetails":"2 letters required. One academic, one professional preferred. Should address analytical abilities.","cvDetails":"Resume/CV required: Quantitative experience, programming, data projects, work experience.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 90+ | IELTS: 7.0+"},
        {"id":49,"programId":49,"minGpa":3.6,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"5+ years recommended","prerequisites":null,"otherRequirements":"Video essays, written essays","applicationFee":250,"fallDeadline":"January 10","springDeadline":null,"rollingAdmissions":false,"notes":"Known for team-based culture and marketing/strategy focus","essayDetails":"Essay 1: What experiences, values, and goals have shaped who you are? (450 words). Video essays on teamwork and leadership.","lorDetails":"2 letters required. Professional references from direct supervisors. Structured evaluation on leadership.","cvDetails":"Professional resume required: Full career history, leadership, extracurriculars.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":50,"programId":50,"minGpa":3,"gpaScale":4,"greRequired":"Not Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":null,"otherRequirements":"Portfolio of published journalism work","applicationFee":95,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"Medill is one of the top journalism programs in the US","essayDetails":"Personal Statement: Why Medill? (500 words). Writing samples: Portfolio of published journalism work required.","lorDetails":"3 letters required. At least one from journalism professional, editor, or professor.","cvDetails":"Resume/CV required: Journalism experience, media roles, published work, multimedia skills.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":51,"programId":51,"minGpa":3,"gpaScale":4,"greRequired":"Optional","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":null,"prerequisites":"Calculus, statistics, some programming","otherRequirements":null,"applicationFee":90,"fallDeadline":"March 1","springDeadline":null,"rollingAdmissions":false,"notes":"DC location ideal for policy-oriented data science careers","essayDetails":"Statement of Purpose (500 words): Interest in data science, relevant quantitative background, and career goals.","lorDetails":"2 letters required. Academic or professional. Should address analytical and technical skills.","cvDetails":"Resume/CV required: Quantitative experience, programming skills, relevant projects.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+ | Duolingo: 130+"},
        {"id":52,"programId":52,"minGpa":3.3,"gpaScale":4,"greRequired":"Required","greVerbalMin":155,"greQuantMin":155,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":3,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"Policy or government experience preferred","prerequisites":"Economics and statistics coursework recommended","otherRequirements":null,"applicationFee":90,"fallDeadline":"January 15","springDeadline":null,"rollingAdmissions":false,"notes":"DC location offers extensive policy networking opportunities","essayDetails":"Personal Statement (750 words): Policy interests, career goals, and why McCourt. Analytical writing sample also recommended.","lorDetails":"3 letters required. Academic and/or professional. Should speak to analytical and policy skills.","cvDetails":"Resume/CV required: Policy experience, government/nonprofit work, research, leadership.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"},
        {"id":53,"programId":53,"minGpa":3.3,"gpaScale":4,"greRequired":"GMAT or GRE Required","greVerbalMin":null,"greQuantMin":null,"greWritingMin":null,"toeflMin":100,"ieltsMin":7.5,"lettersOfRec":2,"personalStatement":true,"resumeCv":true,"transcripts":"Official transcripts from all institutions attended","workExperience":"3-5 years recommended","prerequisites":null,"otherRequirements":"Essays and video component","applicationFee":200,"fallDeadline":"January 7","springDeadline":null,"rollingAdmissions":false,"notes":"Strong government, consulting, and international business placement","essayDetails":"Essay 1: What are your short-term and long-term career goals? (500 words). Video component on values and fit.","lorDetails":"2 letters required. Professional supervisors preferred. Structured evaluation form.","cvDetails":"Professional resume required: Full career history, leadership, community involvement.","transcriptDetails":"Official transcripts from all institutions.","languageTestDetails":"TOEFL iBT: 100+ | IELTS: 7.5+"}
      ]
    };

    // ─── App State ───────────────────────────────────
    let currentPage = 1;
    const itemsPerPage = 12;
    let filteredPrograms = [];

    // ─── Theme Toggle ───────────────────────────────────
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      document.getElementById('theme-icon').innerHTML = next === 'dark' ? '&#9788;' : '&#9790;';
      try { localStorage.setItem('ak-theme', next); } catch(e) {}
    }

    // ─── Init ───────────────────────────────────
    document.addEventListener('DOMContentLoaded', function() {
      // Restore theme
      try {
        const saved = localStorage.getItem('ak-theme');
        if (saved) {
          document.documentElement.setAttribute('data-theme', saved);
          document.getElementById('theme-icon').innerHTML = saved === 'dark' ? '&#9788;' : '&#9790;';
        }
      } catch(e) {}

      populateStates();
      loadPrograms();
      updateBadge();
      initScrollReveal();

      // Bind search events explicitly (backup for onsubmit/oninput attributes)
      var searchForm = document.querySelector('.search-bar');
      if (searchForm) searchForm.addEventListener('submit', handleSearch);
      var searchInput = document.getElementById('search-query');
      if (searchInput) {
        searchInput.addEventListener('input', handleSearchDebounced);
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') { e.preventDefault(); handleSearch(e); }
        });
      }
      var searchBtn = document.querySelector('.btn-search');
      if (searchBtn) searchBtn.addEventListener('click', handleSearch);

      // Also bind the filter dropdowns in the hero section
      var filterState = document.getElementById('filter-state');
      var filterDegree = document.getElementById('filter-degree');
      if (filterState) filterState.addEventListener('change', function() { handleSearch(new Event('change')); });
      if (filterDegree) filterDegree.addEventListener('change', function() { handleSearch(new Event('change')); });

      // Page load init complete
    });

    // ─── Scroll Reveal ───────────────────────────────────
    function initScrollReveal() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, i) => {
          if (entry.isIntersecting) {
            setTimeout(() => entry.target.classList.add('visible'), i * 80);
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

      document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
    }

    // ─── Estimated Annual Living Costs by State (BEA Regional Price Parities 2023) ──
    // National baseline ~$31,000/yr for single adult, adjusted by each state's RPP
    var STATE_LIVING_COSTS = {
      'AL':27800,'AK':38900,'AZ':30200,'AR':27100,'CA':39800,
      'CO':32100,'CT':37500,'DE':31800,'DC':42300,'FL':30500,
      'GA':29600,'HI':43200,'ID':28900,'IL':31200,'IN':28500,
      'IA':27600,'KS':28300,'KY':28100,'LA':28600,'ME':29800,
      'MD':32900,'MA':35800,'MI':29400,'MN':30900,'MS':26900,
      'MO':28700,'MT':29700,'NE':28500,'NV':31100,'NH':32400,
      'NJ':34200,'NM':28400,'NY':33100,'NC':29200,'ND':27800,
      'OH':28900,'OK':27500,'OR':32100,'PA':30100,'RI':32800,
      'SC':28600,'SD':28100,'TN':28900,'TX':29100,'UT':29600,
      'VT':31200,'VA':31400,'WA':33200,'WV':27600,'WI':29200,'WY':28800
    };

    // FIPS state codes for MIT Living Wage Calculator links
    var STATE_FIPS = {
      'AL':'01','AK':'02','AZ':'04','AR':'05','CA':'06',
      'CO':'08','CT':'09','DE':'10','DC':'11','FL':'12',
      'GA':'13','HI':'15','ID':'16','IL':'17','IN':'18',
      'IA':'19','KS':'20','KY':'21','LA':'22','ME':'23',
      'MD':'24','MA':'25','MI':'26','MN':'27','MS':'28',
      'MO':'29','MT':'30','NE':'31','NV':'32','NH':'33',
      'NJ':'34','NM':'35','NY':'36','NC':'37','ND':'38',
      'OH':'39','OK':'40','OR':'41','PA':'42','RI':'44',
      'SC':'45','SD':'46','TN':'47','TX':'48','UT':'49',
      'VT':'50','VA':'51','WA':'53','WV':'54','WI':'55','WY':'56'
    };

    // Full US states + DC list with names
    var US_STATES = {
      'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
      'CO':'Colorado','CT':'Connecticut','DE':'Delaware','DC':'District of Columbia','FL':'Florida',
      'GA':'Georgia','HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana',
      'IA':'Iowa','KS':'Kansas','KY':'Kentucky','LA':'Louisiana','ME':'Maine',
      'MD':'Maryland','MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi',
      'MO':'Missouri','MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire',
      'NJ':'New Jersey','NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota',
      'OH':'Ohio','OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island',
      'SC':'South Carolina','SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah',
      'VT':'Vermont','VA':'Virginia','WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming'
    };

    // Geographic regions for filtering
    var US_REGIONS = {
      'Northeast': ['CT','DE','DC','ME','MD','MA','NH','NJ','NY','PA','RI','VT'],
      'Southeast': ['AL','AR','FL','GA','KY','LA','MS','NC','SC','TN','VA','WV'],
      'Midwest': ['IL','IN','IA','KS','MI','MN','MO','NE','ND','OH','SD','WI'],
      'West': ['AK','AZ','CA','CO','HI','ID','MT','NV','NM','OR','UT','WA','WY'],
      'Texas': ['TX']
    };

    function getRegionForState(stateCode) {
      for (var region in US_REGIONS) {
        if (US_REGIONS[region].indexOf(stateCode) >= 0) return region;
      }
      return null;
    }

    function populateStates() {
      var stateKeys = Object.keys(US_STATES).sort();
      ['filter-state', 'browse-state'].forEach(id => {
        const sel = document.getElementById(id);
        stateKeys.forEach(st => {
          const opt = document.createElement('option');
          opt.value = st;
          opt.textContent = st + ' — ' + US_STATES[st];
          sel.appendChild(opt);
        });
      });
    }

    function loadPrograms() {
      // Start with empty state — don't clutter landing page with curated cards
      filteredPrograms = [];
      currentPage = 1;
      var grid = document.getElementById('cards-grid');
      var countEl = document.getElementById('results-count');
      var pagination = document.getElementById('pagination');
      if (countEl) countEl.textContent = '';
      if (pagination) pagination.innerHTML = '';
      if (grid) grid.innerHTML =
        '<div class="empty-state" style="grid-column: 1 / -1; padding: 40px 20px;">' +
          '<div class="empty-state-icon" style="font-size: 3rem;">&#127891;</div>' +
          '<h3 style="margin: 12px 0 8px; color: var(--heading);">Start your search</h3>' +
          '<p style="color: var(--muted); max-width: 420px; margin: 0 auto;">Type a <strong>school name</strong> (e.g. MIT, Stanford, Cornell) or a <strong>program</strong> (e.g. data science, MBA, architecture) in the search bar above, then click Search.</p>' +
        '</div>';
      // Hide the browse filters bar on initial load (no cards to filter)
      var filtersBar = document.querySelector('.filters-bar');
      if (filtersBar) filtersBar.style.display = 'none';
    }

    // Flag: allow API fallback only on explicit search (not while typing)
    var _allowApiFallback = false;

    function handleSearch(e) {
      if (e && e.preventDefault) e.preventDefault();
      _allowApiFallback = true; // Allow API fallback on explicit search
      const query = document.getElementById('search-query').value.toLowerCase().trim();
      const state = document.getElementById('filter-state').value;
      const degree = document.getElementById('filter-degree').value;
      applyCustomFilters(query, state, degree);

      // Scroll to results
      const grid = document.getElementById('cards-grid');
      if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Debounce helper for real-time search (local DB only, no API calls)
    var _searchTimer = null;
    function handleSearchDebounced() {
      clearTimeout(_searchTimer);
      _searchTimer = setTimeout(function() {
        _allowApiFallback = false; // Don't hit API while typing
        var query = document.getElementById('search-query').value.toLowerCase().trim();
        var state = document.getElementById('filter-state').value;
        var degree = document.getElementById('filter-degree').value;
        applyCustomFilters(query, state, degree);
      }, 300);
    }

    function applyCustomFilters(query = '', state = '', degree = '') {
      // Show filters bar when user is searching
      var filtersBar = document.querySelector('.filters-bar');
      if (filtersBar) filtersBar.style.display = (query || state || degree) ? '' : 'none';
      // Expand aliases for local search too (e.g., "MIT" → matches "Massachusetts Institute of Technology")
      var expandedQuery = query;
      if (query) {
        if (SCHOOL_ALIASES[query]) {
          expandedQuery = SCHOOL_ALIASES[query].toLowerCase();
        } else {
          // Check if query starts with an alias (e.g., "mit computer science" → expand "mit")
          var _aliasKeys = Object.keys(SCHOOL_ALIASES).sort(function(a,b){ return b.length - a.length; });
          for (var _ai = 0; _ai < _aliasKeys.length; _ai++) {
            var _ak = _aliasKeys[_ai];
            if (query.indexOf(_ak) === 0 && (query.length === _ak.length || query[_ak.length] === ' ')) {
              expandedQuery = SCHOOL_ALIASES[_ak].toLowerCase();
              break;
            }
          }
        }
      }

      // Also check CIP-based program matching for better relevance
      // But skip CIP matching if query is a known school alias (e.g., "MIT" should not match "IT")
      var isSchoolAlias = query && (SCHOOL_ALIASES[query] || expandedQuery !== query);
      var cipMatch = null;
      if (!isSchoolAlias && query) {
        // Use findProgramCIP which handles degree-word stripping, multi-word queries, and substring matching
        var cipResult = findProgramCIP(query);
        if (cipResult) {
          cipMatch = { cip: cipResult.cipCodes, label: cipResult.label };
        }
      }

      filteredPrograms = DATABASE.programs.filter(prog => {
        const school = DATABASE.schools.find(s => s.id === prog.schoolId);
        // Match against program name
        var nameMatch = prog.name.toLowerCase().includes(query);
        // Match against school name (including alias expansion)
        var schoolMatch = school.name.toLowerCase().includes(query) ||
          (expandedQuery !== query && school.name.toLowerCase().includes(expandedQuery));
        // Match against department name
        var deptMatch = prog.department && prog.department.toLowerCase().includes(query);
        // Match against CIP code (e.g., searching "journalism" matches CIP 0904)
        var cipCodeMatch = cipMatch && cipMatch.cip && cipMatch.cip.indexOf(prog.cipCode) >= 0;

        // If query matches a known program field (CIP), only show programs that match that CIP
        // Don't show unrelated programs just because they're at a matching school
        var matchQuery;
        if (!query) {
          matchQuery = true;
        } else if (cipMatch) {
          // Program-specific search: require CIP match, or program name match
          matchQuery = cipCodeMatch || nameMatch;
        } else {
          // General search: match school name, program name, or department
          matchQuery = nameMatch || schoolMatch || deptMatch;
        }

        const matchState = !state || school.state === state;
        const matchDegree = !degree || prog.degreeType === degree;
        return matchQuery && matchState && matchDegree &&
               stateMatchesRegionFilter(school.state) &&
               schoolMatchesRankingFilter(school.name);
      });
      currentPage = 1;
      renderCards();
    }

    // Active region and ranking filters (applied to both curated + API results)
    var _activeRegionFilter = '';
    var _activeRankingFilter = 0;

    function handleRegionFilter() {
      var region = document.getElementById('browse-region').value;
      _activeRegionFilter = region;
      // If region is selected, clear individual state filter (region overrides)
      if (region) {
        document.getElementById('browse-state').value = '';
        document.getElementById('filter-state').value = '';
      }
      // Re-run the current search/filter
      var query = document.getElementById('search-query').value.trim();
      if (query || _lastSearchContext) {
        handleSearch(new Event('submit'));
      } else {
        applyFilters();
      }
    }

    function handleRankingFilter() {
      var rank = document.getElementById('browse-ranking').value;
      _activeRankingFilter = rank ? parseInt(rank) : 0;
      // Re-run the current search/filter
      var query = document.getElementById('search-query').value.trim();
      if (query || _lastSearchContext) {
        handleSearch(new Event('submit'));
      } else {
        applyFilters();
      }
    }

    function schoolMatchesRankingFilter(schoolName) {
      if (!_activeRankingFilter) return true;
      var key = schoolName.toLowerCase();
      var r = RANKINGS_DATA[key];
      if (!r) {
        // Try fuzzy match
        for (var rk in RANKINGS_DATA) {
          if (key.indexOf(rk) >= 0 || rk.indexOf(key) >= 0) { r = RANKINGS_DATA[rk]; break; }
        }
      }
      if (!r) return false; // No ranking data = filtered out when ranking filter is active
      return r.un && r.un <= _activeRankingFilter;
    }

    function stateMatchesRegionFilter(stateCode) {
      if (!_activeRegionFilter) return true;
      var regionStates = US_REGIONS[_activeRegionFilter];
      return regionStates && regionStates.indexOf(stateCode) >= 0;
    }

    function applyFilters() {
      const state = document.getElementById('browse-state').value;
      const degree = document.getElementById('browse-degree').value;
      const format = document.getElementById('browse-format').value;

      filteredPrograms = DATABASE.programs.filter(prog => {
        const school = DATABASE.schools.find(s => s.id === prog.schoolId);
        return (!state || school.state === state) &&
               (!degree || prog.degreeType === degree) &&
               (!format || prog.format === format) &&
               stateMatchesRegionFilter(school.state) &&
               schoolMatchesRankingFilter(school.name);
      });
      currentPage = 1;
      renderCards();
    }

    function renderCards() {
      const grid = document.getElementById('cards-grid');
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pagePrograms = filteredPrograms.slice(start, end);

      // Update results count
      const countEl = document.getElementById('results-count');
      if (countEl) countEl.textContent = `${filteredPrograms.length} program${filteredPrograms.length !== 1 ? 's' : ''} found`;

      if (pagePrograms.length === 0) {
        // Try live API search as fallback (only on explicit search, not while typing)
        const query = document.getElementById('search-query').value.trim();
        const selectedState = document.getElementById('filter-state').value;
        const selectedDegree = document.getElementById('filter-degree').value;
        if (_allowApiFallback && (query || selectedState) && getApiKey()) {
          // Analyze query to determine if it's a program search, school search, or mixed
          var queryAnalysis = query ? analyzeSearchQuery(query) : { type: 'school' };

          // Apply the degree dropdown filter: override or set the degreeLevel from the dropdown
          // Dropdown values: "Masters" → API level 5, "Doctoral" → API level 6
          if (selectedDegree === 'Masters' && !queryAnalysis.degreeLevel) {
            queryAnalysis.degreeLevel = 5;
          } else if (selectedDegree === 'Doctoral' && !queryAnalysis.degreeLevel) {
            queryAnalysis.degreeLevel = 6;
          }

          var searchLabel = '';
          if (queryAnalysis.type === 'program' || queryAnalysis.type === 'mixed') {
            searchLabel = queryAnalysis.cipLabel + (queryAnalysis.degreeLevel === 5 ? " Master's" : queryAnalysis.degreeLevel === 6 ? ' Doctoral' : '') + ' programs';
            if (queryAnalysis.schoolName) searchLabel += ' at ' + queryAnalysis.schoolName;
          } else {
            var parsedSchool = query ? extractSchoolName(query) : '';
            searchLabel = parsedSchool || (selectedState ? 'schools in ' + (US_STATES[selectedState] || selectedState) : 'all schools');
          }
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1">
              <div class="api-loading"><div class="spinner"></div><p>Searching 6,000+ US schools for "${searchLabel}"...</p></div>
            </div>`;
          document.getElementById('pagination').innerHTML = '';

          // Save search context for modal use
          _lastSearchQuery = query;
          _lastSearchProgramLabel = (queryAnalysis.type === 'program' || queryAnalysis.type === 'mixed') ? (queryAnalysis.cipLabel || '') : '';
          _lastSearchTerms = (queryAnalysis.type === 'program' || queryAnalysis.type === 'mixed') ? (queryAnalysis.searchTerms || queryAnalysis.cipLabel || '') : '';

          // Route to program CIP search or school name search
          if (queryAnalysis.type === 'program' || queryAnalysis.type === 'mixed') {
            searchProgramsAPI(queryAnalysis, selectedState);
          } else {
            searchFromMainPage(query, selectedState);
          }
          return;
        }
        var emptyMsg = query ? 'No curated programs match "' + query + '". Click <strong>Search</strong> or press Enter to search 6,000+ US schools via live API.' : 'No programs found. Try adjusting your filters.';
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1">
            <div class="empty-state-icon">&#128269;</div>
            <p>${emptyMsg}</p>
          </div>`;
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      grid.innerHTML = pagePrograms.map(prog => {
        const school = DATABASE.schools.find(s => s.id === prog.schoolId);
        const tuition = prog.tuitionInState ? `$${(prog.tuitionInState / 1000).toFixed(0)}K` : 'N/A';
        const saved = isSaved(prog.id);
        return `
          <div class="card" onclick="openModal(${prog.id})" style="position:relative;">
            <button class="bookmark-btn ${saved ? 'saved' : ''}" onclick="event.stopPropagation(); toggleSave(${prog.id});" title="${saved ? 'Remove from saved' : 'Save program'}" aria-label="Save program">&#9733;</button>
            <div class="card-school">${school.name}</div>
            <div class="card-program">${prog.name}</div>
            <div class="card-tags">
              <span class="tag degree">${prog.degreeType}</span>
              <span class="tag format">${prog.format}</span>
              <span class="tag">${prog.duration}</span>
            </div>
            <div class="card-info">
              <strong>Tuition:</strong> ${tuition} &middot; <strong>Dept:</strong> ${prog.department}
            </div>
            <span class="card-cta">View requirements &rarr;</span>
          </div>`;
      }).join('');

      renderPagination();
    }

    function renderPagination() {
      const container = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredPrograms.length / itemsPerPage);
      container.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === currentPage ? 'active' : '';
        btn.onclick = () => { currentPage = i; renderCards(); window.scrollTo({ top: document.getElementById('cards-grid').offsetTop - 100, behavior: 'smooth' }); };
        container.appendChild(btn);
      }
    }

    function openModal(programId) {
      const prog = DATABASE.programs.find(p => p.id === programId);
      const school = DATABASE.schools.find(s => s.id === prog.schoolId);
      const req = DATABASE.requirements.find(r => r.programId === programId);

      document.getElementById('modal-program-name').textContent = prog.name;
      document.getElementById('modal-school-name').textContent = school.name;

      // Update modal save button
      const modalSaveBtn = document.getElementById('modal-save-btn');
      modalSaveBtn.setAttribute('data-program-id', programId);
      if (isSaved(programId)) {
        modalSaveBtn.classList.add('saved');
        modalSaveBtn.innerHTML = '&#9733; Saved';
      } else {
        modalSaveBtn.classList.remove('saved');
        modalSaveBtn.innerHTML = '&#9733; Save';
      }

      const tuition = prog.tuitionInState ? `$${prog.tuitionInState.toLocaleString()}` : 'N/A';

      let html = `
        <div class="modal-section">
          <h3>Program Overview</h3>
          <div class="overview-grid">
            <div class="overview-item"><div class="overview-item-label">Degree</div><div class="overview-item-value">${prog.degreeType}</div></div>
            <div class="overview-item"><div class="overview-item-label">Department</div><div class="overview-item-value">${prog.department}</div></div>
            <div class="overview-item"><div class="overview-item-label">Duration</div><div class="overview-item-value">${prog.duration}</div></div>
            <div class="overview-item"><div class="overview-item-label">Format</div><div class="overview-item-value">${prog.format}</div></div>
            <div class="overview-item"><div class="overview-item-label">Tuition</div><div class="overview-item-value">${tuition}</div></div>
          </div>
        </div>

        <div class="modal-section">
          <h3>Key Resources</h3>
          <div class="link-buttons">
            <a href="${school.website}" target="_blank" class="link-button">${school.name} Website</a>
            <a href="https://www.google.com/search?q=${encodeURIComponent(school.name + ' ' + prog.name + ' masters admissions')}" target="_blank" class="link-button">Search Admissions Page</a>
            <a href="https://www.google.com/search?q=${encodeURIComponent(school.name + ' graduate application portal')}" target="_blank" class="link-button">Find Application Portal</a>
            <a href="https://www.google.com/search?q=${encodeURIComponent(school.name + ' graduate financial aid scholarships')}" target="_blank" class="link-button">Financial Aid Info</a>
          </div>
        </div>

        <div class="modal-section">
          <h3>Admission Requirements</h3>
          <div class="requirements-subsection">
            <h4>Academic</h4>
            <ul class="requirements-list">
              <li><strong>Minimum GPA:</strong> ${req.minGpa || 'Not specified'} / ${req.gpaScale}</li>
              <li><strong>GRE:</strong> ${req.greRequired}${req.greVerbalMin ? ` (V: ${req.greVerbalMin}, Q: ${req.greQuantMin}${req.greWritingMin ? ', W: ' + req.greWritingMin : ''})` : ''}</li>
              <li><strong>Prerequisites:</strong> ${req.prerequisites || 'None specified'}</li>
            </ul>
          </div>
          <div class="requirements-subsection">
            <h4>Application Materials Checklist</h4>
            <div class="checklist-grid">
              <div class="checklist-item">
                <div class="checklist-icon">📝</div>
                <div class="checklist-content">
                  <div class="checklist-label">Essays / Statement of Purpose</div>
                  <div class="checklist-detail">${req.essayDetails || (req.personalStatement ? 'Personal statement required' : 'Not required')}</div>
                </div>
              </div>
              <div class="checklist-item">
                <div class="checklist-icon">📨</div>
                <div class="checklist-content">
                  <div class="checklist-label">Letters of Recommendation</div>
                  <div class="checklist-detail">${req.lorDetails || req.lettersOfRec + ' letter(s) required'}</div>
                </div>
              </div>
              <div class="checklist-item">
                <div class="checklist-icon">📄</div>
                <div class="checklist-content">
                  <div class="checklist-label">Resume / CV</div>
                  <div class="checklist-detail">${req.cvDetails || (req.resumeCv ? 'Required' : 'Not required')}</div>
                </div>
              </div>
              <div class="checklist-item">
                <div class="checklist-icon">🎓</div>
                <div class="checklist-content">
                  <div class="checklist-label">Transcripts</div>
                  <div class="checklist-detail">${req.transcriptDetails || req.transcripts}</div>
                </div>
              </div>
              <div class="checklist-item">
                <div class="checklist-icon">🌐</div>
                <div class="checklist-content">
                  <div class="checklist-label">Language / English Proficiency</div>
                  <div class="checklist-detail">${req.languageTestDetails || ('TOEFL: ' + (req.toeflMin || 'N/A') + ' | IELTS: ' + (req.ieltsMin || 'N/A'))}</div>
                </div>
              </div>
              ${req.otherRequirements ? `<div class="checklist-item"><div class="checklist-icon">➕</div><div class="checklist-content"><div class="checklist-label">Additional Requirements</div><div class="checklist-detail">${req.otherRequirements}</div></div></div>` : ''}
            </div>
          </div>
          ${req.workExperience ? `
          <div class="requirements-subsection">
            <h4>Work Experience</h4>
            <ul class="requirements-list"><li>${req.workExperience}</li></ul>
          </div>` : ''}
        </div>

        <div class="modal-section">
          <h3>Deadlines &amp; Fees</h3>
          <ul class="requirements-list">
            ${req.fallDeadline ? `<li><strong>Fall Deadline:</strong> ${req.fallDeadline}</li>` : ''}
            ${req.springDeadline ? `<li><strong>Spring Deadline:</strong> ${req.springDeadline}</li>` : ''}
            ${req.rollingAdmissions ? `<li><strong>Rolling Admissions:</strong> Yes</li>` : ''}
            <li><strong>Application Fee:</strong> $${req.applicationFee}</li>
          </ul>
        </div>

        ${req.notes ? `
        <div class="modal-section">
          <div class="insider-notes"><strong>Insider Tip:</strong> ${req.notes}</div>
        </div>` : ''}

        <div class="modal-section">
          <div class="disclaimer-box">
            <strong>Important Reminder</strong>
            This information is provided as a reference. Requirements, deadlines, and tuition are subject to change. Verify all details with the institution's official admissions office before submitting your application.
          </div>
        </div>`;

      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        var modal = document.getElementById('modal');
        if (modal && modal.classList.contains('active')) {
          closeModal();
        }
      }
    });

    // Close modal on backdrop click
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // ─── API Result Detail Modal ─────────────────────────────────────────
    // Stores API result data temporarily so cards can open a detail modal
    var _apiResultsCache = {};
    var _lastSearchQuery = ''; // Track search query for modal context
    var _lastSearchProgramLabel = ''; // e.g. "Architecture", "Computer Science"
    var _lastSearchTerms = ''; // User's actual search words after stripping degree words, e.g. "communication"

    function openApiModal(cacheKey) {
      var school = _apiResultsCache[cacheKey];
      if (!school) return;

      var name = school['school.name'] || 'Unknown';
      var city = school['school.city'] || '';
      var state = school['school.state'] || '';
      var sUrl = school['school.school_url'] || '';
      var fullUrl = sUrl ? (sUrl.startsWith('http') ? sUrl : 'https://' + sUrl) : '#';
      var ownership = school['school.ownership'];
      var ownershipLabel = ownership === 1 ? 'Public' : ownership === 2 ? 'Private Nonprofit' : ownership === 3 ? 'For-Profit' : 'N/A';
      var setting = getLocaleSetting(school['school.locale']);
      var inStateTuition = school['latest.cost.tuition.in_state'];
      var outStateTuition = school['latest.cost.tuition.out_of_state'];
      var tuitionStr = formatTuition(school);
      var acceptanceRate = school['latest.admissions.admission_rate.overall'];
      var avgNetPrice = school['latest.cost.avg_net_price.overall'];

      // Check if this school has curated data in our DATABASE
      var curatedSchool = DATABASE.schools.find(function(s) {
        return name.toLowerCase().indexOf(s.name.toLowerCase()) >= 0 ||
               s.name.toLowerCase().indexOf(name.toLowerCase()) >= 0;
      });
      var curatedPrograms = curatedSchool ? DATABASE.programs.filter(function(p) { return p.schoolId === curatedSchool.id; }) : [];

      // Get all graduate programs from CIP data
      var programs = school['latest.programs.cip_4_digit'] || [];
      var masterProgs = programs.filter(function(p) { return p.credential && p.credential.level === 5; });
      var doctoralProgs = programs.filter(function(p) { return p.credential && p.credential.level === 6; });

      // Set modal header — include searched program field if available
      var _modalProgCtx = _lastSearchProgramLabel || '';
      document.getElementById('modal-program-name').textContent = name;
      document.getElementById('modal-school-name').textContent = (_modalProgCtx ? _modalProgCtx + ' \u2022 ' : '') + city + ', ' + state + (setting !== 'N/A' ? ' \u2022 ' + setting : '');

      // Set up save button for API results
      var modalSaveBtn = document.getElementById('modal-save-btn');
      modalSaveBtn.style.display = '';
      modalSaveBtn.setAttribute('data-program-id', '');
      modalSaveBtn.setAttribute('data-api-cache-key', cacheKey);
      modalSaveBtn.onclick = toggleSaveApiFromModal;
      if (isApiSchoolSaved(school)) {
        modalSaveBtn.classList.add('saved');
        modalSaveBtn.innerHTML = '&#9733; Saved';
      } else {
        modalSaveBtn.classList.remove('saved');
        modalSaveBtn.innerHTML = '&#9733; Save';
      }

      // Identify program-specific data from matched CIP programs
      // Uses keyword matching (not phrase matching) for accurate results
      var _isProgSearch = !!_lastSearchProgramLabel;
      var _matchedCipProgs = [];
      if (_isProgSearch && _lastSearchContext && _lastSearchContext.args) {
        var _a = _lastSearchContext.args[0];
        // Step 1: Filter by CIP code + grad level
        if (_a && _a.cipCodes) {
          _matchedCipProgs = programs.filter(function(p) {
            for (var ci = 0; ci < _a.cipCodes.length; ci++) {
              if (p.code === _a.cipCodes[ci] && p.credential && (p.credential.level === 5 || p.credential.level === 6)) return true;
            }
            return false;
          });
        }
        // Step 2: Further narrow by keyword matching on titles
        var _modalKw = (_lastSearchTerms || _lastSearchProgramLabel || '').toLowerCase();
        var _modalKwWords = _modalKw.split(/\s+/).filter(function(w) { return w.length >= 3; });
        if (_modalKwWords.length > 0 && _matchedCipProgs.length > 0) {
          var _kwNarrowed = _matchedCipProgs.filter(function(p) {
            var t = (p.title || '').toLowerCase();
            return _modalKwWords.some(function(w) { return t.indexOf(w) >= 0; });
          });
          if (_kwNarrowed.length > 0) _matchedCipProgs = _kwNarrowed;
        }
      }
      var _modalProgEarnings = getProgramEarnings(_matchedCipProgs);
      var _modalProgDebt = getProgramDebt(_matchedCipProgs);

      // Build tuition display for modal (more detailed than card)
      var tuitionLabelSuffix = _isProgSearch ? ' (Institutional)' : '';
      var tuitionDetailHtml = '';
      if (inStateTuition && outStateTuition && inStateTuition !== outStateTuition) {
        tuitionDetailHtml = '<div class="overview-item"><div class="overview-item-label">In-State Tuition' + tuitionLabelSuffix + '</div><div class="overview-item-value">$' + inStateTuition.toLocaleString() + '</div></div>' +
          '<div class="overview-item"><div class="overview-item-label">Out-of-State Tuition' + tuitionLabelSuffix + '</div><div class="overview-item-value">$' + outStateTuition.toLocaleString() + '</div></div>';
      } else if (outStateTuition) {
        tuitionDetailHtml = '<div class="overview-item"><div class="overview-item-label">Tuition' + tuitionLabelSuffix + '</div><div class="overview-item-value">$' + outStateTuition.toLocaleString() + '</div></div>';
      } else if (inStateTuition) {
        tuitionDetailHtml = '<div class="overview-item"><div class="overview-item-label">Tuition' + tuitionLabelSuffix + '</div><div class="overview-item-value">$' + inStateTuition.toLocaleString() + '</div></div>';
      } else {
        tuitionDetailHtml = '<div class="overview-item"><div class="overview-item-label">Tuition</div><div class="overview-item-value">N/A</div></div>';
      }

      var outcomes = getSchoolOutcomes(school);

      // Build program-specific earnings section (shown prominently when available)
      var progEarningsHtml = '';
      if (_modalProgEarnings) {
        progEarningsHtml += '<div class="overview-item"><div class="overview-item-label">' + _modalProgEarnings.label + '</div><div class="overview-item-value" style="color:#059669;font-weight:700;">' + _modalProgEarnings.value + '</div></div>';
      }
      if (_modalProgDebt) {
        progEarningsHtml += '<div class="overview-item"><div class="overview-item-label">Median Grad Debt</div><div class="overview-item-value" style="color:#b45309;font-weight:700;">' + _modalProgDebt.value + '</div></div>';
      }

      var html = '<div class="modal-section">' +
        '<h3>School Overview</h3>' +
        '<div class="overview-grid">' +
          '<div class="overview-item"><div class="overview-item-label">Type</div><div class="overview-item-value">' + ownershipLabel + '</div></div>' +
          '<div class="overview-item"><div class="overview-item-label">Setting</div><div class="overview-item-value">' + setting + '</div></div>' +
          (acceptanceRate ? '<div class="overview-item"><div class="overview-item-label">Acceptance Rate</div><div class="overview-item-value" style="font-weight:700; color:' + (acceptanceRate < 0.2 ? '#dc2626' : acceptanceRate < 0.5 ? '#d97706' : '#059669') + ';">' + (acceptanceRate * 100).toFixed(0) + '%</div></div>' : '') +
          tuitionDetailHtml +
          (avgNetPrice ? '<div class="overview-item"><div class="overview-item-label">Avg Net Price</div><div class="overview-item-value" style="color:#059669;">$' + Math.round(avgNetPrice).toLocaleString() + '</div></div>' : '') +
          '<div class="overview-item"><div class="overview-item-label">Grad Programs</div><div class="overview-item-value">' + (masterProgs.length + doctoralProgs.length) + '</div></div>' +
          '<div class="overview-item"><div class="overview-item-label">Est. Living Cost (Annual)</div><div class="overview-item-value" style="color:#0369a1;font-weight:700;">' + formatLivingCost(state) + '</div></div>' +
          progEarningsHtml +
          (!_modalProgEarnings && outcomes.earnings ? '<div class="overview-item"><div class="overview-item-label">Avg Earnings (10yr, All Students)</div><div class="overview-item-value" style="color:var(--success);font-weight:700;">' + outcomes.earnings + '</div></div>' : '') +
          (outcomes.debt ? '<div class="overview-item"><div class="overview-item-label">Median Debt (All)</div><div class="overview-item-value">' + outcomes.debt + '</div></div>' : '') +
          (outcomes.gradRate ? '<div class="overview-item"><div class="overview-item-label">Undergrad Grad Rate</div><div class="overview-item-value">' + outcomes.gradRate + '</div></div>' : '') +
          (outcomes.retention ? '<div class="overview-item"><div class="overview-item-label">Undergrad Retention</div><div class="overview-item-value">' + outcomes.retention + '</div></div>' : '') +
        '</div>' +
        (_isProgSearch ? '<div style="margin-top:6px; font-size:0.75rem; color:var(--muted); padding:4px 8px; background:var(--surface); border-radius:6px;">&#9432; Tuition shown is the institutional rate. Graduate program tuition may differ. Grad rate and retention are undergraduate metrics.</div>' : '') +
        '<div style="margin-top:8px; font-size:0.8rem; color:var(--muted);">Living cost based on BEA Regional Price Parities (2023). <a href="' + getMitLivingWageLink(state) + '" target="_blank" style="color:var(--accent);">View MIT Living Wage Calculator for ' + (US_STATES[state] || state) + ' &rarr;</a></div>' +
      '</div>';

      // ── If we have curated data, show FULL admission requirements for each program ──
      if (curatedPrograms.length > 0) {
        html += '<div class="modal-section" style="background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(168,85,247,0.06)); border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
          '<div style="display:inline-block; background: var(--accent); color:#fff; padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; margin-bottom: 10px;">DETAILED REQUIREMENTS AVAILABLE</div>' +
          '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">This school has ' + curatedPrograms.length + ' program' + (curatedPrograms.length > 1 ? 's' : '') + ' with full admission details curated by AdmitKit.</p>' +
        '</div>';

        curatedPrograms.forEach(function(prog) {
          var req = DATABASE.requirements.find(function(r) { return r.programId === prog.id; });
          if (!req) return;
          var tuition = prog.tuitionInState ? '$' + prog.tuitionInState.toLocaleString() : 'N/A';

          html += '<div class="modal-section" style="border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px;">' +
            '<h3 style="margin-top:0;">' + prog.name + '</h3>' +
            '<div class="overview-grid">' +
              '<div class="overview-item"><div class="overview-item-label">Degree</div><div class="overview-item-value">' + prog.degreeType + '</div></div>' +
              '<div class="overview-item"><div class="overview-item-label">Department</div><div class="overview-item-value">' + prog.department + '</div></div>' +
              '<div class="overview-item"><div class="overview-item-label">Duration</div><div class="overview-item-value">' + prog.duration + '</div></div>' +
              '<div class="overview-item"><div class="overview-item-label">Format</div><div class="overview-item-value">' + prog.format + '</div></div>' +
              '<div class="overview-item"><div class="overview-item-label">Tuition</div><div class="overview-item-value">' + tuition + '</div></div>' +
            '</div>' +

            '<div class="requirements-subsection" style="margin-top: 12px;">' +
              '<h4>Admission Requirements</h4>' +
              '<ul class="requirements-list">' +
                '<li><strong>Minimum GPA:</strong> ' + (req.minGpa || 'Not specified') + ' / ' + req.gpaScale + '</li>' +
                '<li><strong>GRE:</strong> ' + req.greRequired + (req.greVerbalMin ? ' (V: ' + req.greVerbalMin + ', Q: ' + req.greQuantMin + (req.greWritingMin ? ', W: ' + req.greWritingMin : '') + ')' : '') + '</li>' +
                '<li><strong>Prerequisites:</strong> ' + (req.prerequisites || 'None specified') + '</li>' +
              '</ul>' +
            '</div>' +

            '<div class="requirements-subsection">' +
              '<h4>Application Materials</h4>' +
              '<div class="checklist-grid">' +
                '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCDD</div><div class="checklist-content"><div class="checklist-label">Essays / Statement of Purpose</div><div class="checklist-detail">' + (req.essayDetails || (req.personalStatement ? 'Personal statement required' : 'Not required')) + '</div></div></div>' +
                '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCE8</div><div class="checklist-content"><div class="checklist-label">Letters of Recommendation</div><div class="checklist-detail">' + (req.lorDetails || req.lettersOfRec + ' letter(s) required') + '</div></div></div>' +
                '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCC4</div><div class="checklist-content"><div class="checklist-label">Resume / CV</div><div class="checklist-detail">' + (req.cvDetails || (req.resumeCv ? 'Required' : 'Not required')) + '</div></div></div>' +
                '<div class="checklist-item"><div class="checklist-icon">\uD83C\uDF93</div><div class="checklist-content"><div class="checklist-label">Transcripts</div><div class="checklist-detail">' + (req.transcriptDetails || req.transcripts) + '</div></div></div>' +
                '<div class="checklist-item"><div class="checklist-icon">\uD83C\uDF10</div><div class="checklist-content"><div class="checklist-label">English Proficiency</div><div class="checklist-detail">' + (req.languageTestDetails || ('TOEFL: ' + (req.toeflMin || 'N/A') + ' | IELTS: ' + (req.ieltsMin || 'N/A'))) + '</div></div></div>' +
                (req.otherRequirements ? '<div class="checklist-item"><div class="checklist-icon">\u2795</div><div class="checklist-content"><div class="checklist-label">Additional Requirements</div><div class="checklist-detail">' + req.otherRequirements + '</div></div></div>' : '') +
              '</div>' +
            '</div>' +

            '<div class="requirements-subsection">' +
              '<h4>Deadlines &amp; Fees</h4>' +
              '<ul class="requirements-list">' +
                (req.fallDeadline ? '<li><strong>Fall Deadline:</strong> ' + req.fallDeadline + '</li>' : '') +
                (req.springDeadline ? '<li><strong>Spring Deadline:</strong> ' + req.springDeadline + '</li>' : '') +
                (req.rollingAdmissions ? '<li><strong>Rolling Admissions:</strong> Yes</li>' : '') +
                '<li><strong>Application Fee:</strong> $' + req.applicationFee + '</li>' +
              '</ul>' +
            '</div>' +

            (req.workExperience ? '<div class="requirements-subsection"><h4>Work Experience</h4><ul class="requirements-list"><li>' + req.workExperience + '</li></ul></div>' : '') +
            (req.notes ? '<div class="insider-notes" style="margin-top: 8px;"><strong>Insider Tip:</strong> ' + req.notes + '</div>' : '') +
          '</div>';
        });
      }

      // ── Show API program list — highlight searched program first ──
      // Helper to build a program card
      function buildProgCard(p, isHighlighted) {
        var pTitle = p.title || 'Unknown Program';
        var deptUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + pTitle + ' admissions program');
        var essayUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + pTitle + ' statement of purpose essay prompt application requirements');
        var deadlineUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + pTitle + ' application deadline tuition');
        var highlightStyle = isHighlighted ? 'border: 2px solid var(--accent); background: var(--accent-soft); border-radius: 12px; padding: 10px;' : '';
        var badge = isHighlighted ? '<span style="font-size:0.65rem; padding:2px 8px; background:var(--accent); color:#fff; border-radius:10px; margin-left:6px;">Searched</span>' : '';
        // Extract program-specific earnings/debt for this program
        var _pe = getProgramEarnings([p]);
        var _pd = getProgramDebt([p]);
        var earningsLine = '';
        if (_pe || _pd) {
          earningsLine = '<div style="display:flex; gap:10px; margin-top:3px; font-size:0.75rem;">';
          if (_pe) earningsLine += '<span style="color:#059669; font-weight:600;">' + _pe.label + ': ' + _pe.value + '</span>';
          if (_pd) earningsLine += '<span style="color:#b45309; font-weight:600;">Median Debt: ' + _pd.value + '</span>';
          earningsLine += '</div>';
        }
        return '<div class="checklist-item" style="align-items:flex-start;' + highlightStyle + '">' +
          '<div class="checklist-icon">\uD83C\uDF93</div>' +
          '<div class="checklist-content">' +
            '<div class="checklist-label">' + pTitle + badge + '</div>' +
            '<div class="checklist-detail">' + (p.credential.title || 'Graduate degree') + '</div>' +
            earningsLine +
            '<div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px;">' +
              '<a href="' + deptUrl + '" target="_blank" rel="noopener noreferrer" style="font-size:0.7rem; padding:2px 8px; background:var(--accent); color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">Program page</a>' +
              '<a href="' + essayUrl + '" target="_blank" rel="noopener noreferrer" style="font-size:0.7rem; padding:2px 8px; background:#d97706; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">Essay / SOP</a>' +
              '<a href="' + deadlineUrl + '" target="_blank" rel="noopener noreferrer" style="font-size:0.7rem; padding:2px 8px; background:#059669; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">Deadlines</a>' +
            '</div>' +
          '</div>' +
        '</div>';
      }

      // Determine which programs match the user's search (keyword-based)
      var _modalSearchKw = (_lastSearchTerms || _lastSearchProgramLabel || '').toLowerCase();
      var _modalSearchWords = _modalSearchKw.split(/\s+/).filter(function(w) { return w.length >= 3; });
      function isSearchMatch(prog) {
        if (_modalSearchWords.length === 0) return false;
        var title = (prog.title || '').toLowerCase();
        return _modalSearchWords.some(function(w) { return title.indexOf(w) >= 0; });
      }

      // Split programs into matched vs other
      var matchedMasters = masterProgs.filter(isSearchMatch);
      var otherMasters = masterProgs.filter(function(p) { return !isSearchMatch(p); });
      var matchedDoctoral = doctoralProgs.filter(isSearchMatch);
      var otherDoctoral = doctoralProgs.filter(function(p) { return !isSearchMatch(p); });

      // Show matched programs first in a highlighted section
      if (matchedMasters.length > 0 || matchedDoctoral.length > 0) {
        var matchedAll = matchedMasters.concat(matchedDoctoral);
        html += '<div class="modal-section"><h3>' + _lastSearchProgramLabel + ' Programs at ' + name + ' (' + matchedAll.length + ')</h3><div class="checklist-grid">';
        matchedAll.forEach(function(p) { html += buildProgCard(p, true); });
        html += '</div></div>';
      }

      // Show other master's programs in a collapsible section
      if (otherMasters.length > 0) {
        otherMasters.sort(function(a,b) { return (a.title || '').localeCompare(b.title || ''); });
        var showByDefault = !searchLabel; // Only expand if user wasn't searching a specific program
        html += '<div class="modal-section"><h3 onclick="var el=this.nextElementSibling; el.style.display=el.style.display===\'none\'?\'block\':\'none\'; this.querySelector(\'span\').textContent=el.style.display===\'none\'?\'\u25B6\':\'\u25BC\';" style="cursor:pointer;">Other Master\'s Programs (' + otherMasters.length + ') <span style="font-size:0.75rem;">' + (showByDefault ? '\u25BC' : '\u25B6') + '</span></h3><div class="checklist-grid" style="display:' + (showByDefault ? 'block' : 'none') + ';">';
        otherMasters.forEach(function(p) { html += buildProgCard(p, false); });
        html += '</div></div>';
      }

      if (otherDoctoral.length > 0) {
        otherDoctoral.sort(function(a,b) { return (a.title || '').localeCompare(b.title || ''); });
        var showByDefault2 = !searchLabel;
        html += '<div class="modal-section"><h3 onclick="var el=this.nextElementSibling; el.style.display=el.style.display===\'none\'?\'block\':\'none\'; this.querySelector(\'span\').textContent=el.style.display===\'none\'?\'\u25B6\':\'\u25BC\';" style="cursor:pointer;">Other Doctoral Programs (' + otherDoctoral.length + ') <span style="font-size:0.75rem;">' + (showByDefault2 ? '\u25BC' : '\u25B6') + '</span></h3><div class="checklist-grid" style="display:' + (showByDefault2 ? 'block' : 'none') + ';">';
        otherDoctoral.forEach(function(p) { html += buildProgCard(p, false); });
        html += '</div></div>';
      }

      // Legacy fallback - if no search label, show all (backward compatible)
      if (!searchLabel && masterProgs.length > 0 && matchedMasters.length === 0) {
        html += '<div class="modal-section"><h3>All Master\'s Programs (' + masterProgs.length + ')</h3><div class="checklist-grid">';
        masterProgs.sort(function(a,b) { return (a.title || '').localeCompare(b.title || ''); });
        masterProgs.forEach(function(p) { html += buildProgCard(p, false); });
        html += '</div></div>';
      }

      if (!searchLabel && doctoralProgs.length > 0 && matchedDoctoral.length === 0) {
        html += '<div class="modal-section"><h3>All Doctoral Programs (' + doctoralProgs.length + ')</h3><div class="checklist-grid">';
        doctoralProgs.sort(function(a,b) { return (a.title || '').localeCompare(b.title || ''); });
        doctoralProgs.forEach(function(p) { html += buildProgCard(p, false); });
        html += '</div></div>';
      }

      if (masterProgs.length === 0 && doctoralProgs.length === 0 && curatedPrograms.length === 0) {
        html += '<div class="modal-section"><h3>Graduate Programs</h3><p style="color: var(--muted);">Program details not available. Visit the school website for more information.</p></div>';
      }

      // ── Application Materials Guide (for non-curated schools) ──
      var _guideProgCtx = _lastSearchProgramLabel || '';
      var _guideProgramSearch = _guideProgCtx ? ' ' + _guideProgCtx : ' graduate';
      var _deptReqs = getSearchedProgramRequirements();
      if (curatedPrograms.length === 0 && (masterProgs.length > 0 || doctoralProgs.length > 0)) {
        html += '<div class="modal-section" style="background: linear-gradient(135deg, rgba(217,119,6,0.06), rgba(5,150,105,0.06)); border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
          '<h3 style="margin-top:0;">\uD83D\uDCDD ' + (_deptReqs ? _deptReqs.label + ' Admission Requirements' : 'Application Materials Guide' + (_guideProgCtx ? ' — ' + _guideProgCtx : '')) + '</h3>' +
          '<p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 14px;">' + (_deptReqs ? 'Typical department-specific requirements for ' + _deptReqs.label + ' programs at ' + name + ':' : 'Most' + _guideProgramSearch + ' programs at ' + name + ' require the following materials:') + '</p>' +
          '<div class="checklist-grid">';

        // Portfolio / Audition — show FIRST if this field requires it
        if (_deptReqs && _deptReqs.portfolio) {
          html += '<div class="checklist-item" style="border: 2px solid #d97706; border-radius: 12px; padding: 10px;"><div class="checklist-icon">\uD83C\uDFA8</div><div class="checklist-content">' +
              '<div class="checklist-label" style="color: #d97706; font-weight: 800;">Portfolio / Creative Work</div>' +
              '<div class="checklist-detail">' + _deptReqs.portfolio + '</div>' +
              '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + _guideProgramSearch + ' portfolio requirements format guidelines') + '" target="_blank" style="display:inline-block; font-size:0.72rem; margin-top:4px; padding:2px 8px; background:#d97706; color:#fff; border-radius:10px; text-decoration:none;">Find portfolio requirements &rarr;</a>' +
            '</div></div>';
        }

        html += '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCDD</div><div class="checklist-content">' +
              '<div class="checklist-label">Statement of Purpose</div>' +
              '<div class="checklist-detail">' + (_deptReqs ? _deptReqs.sop : 'Usually 1-2 pages describing your research interests, academic background, and career goals.') + '</div>' +
              '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + _guideProgramSearch + ' statement of purpose guidelines requirements') + '" target="_blank" style="display:inline-block; font-size:0.72rem; margin-top:4px; padding:2px 8px; background:#d97706; color:#fff; border-radius:10px; text-decoration:none;">Find SOP guidelines &rarr;</a>' +
            '</div></div>' +
            '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCE8</div><div class="checklist-content">' +
              '<div class="checklist-label">Letters of Recommendation</div>' +
              '<div class="checklist-detail">' + (_deptReqs ? _deptReqs.lor : 'Typically 2-3 letters from professors or professional supervisors.') + '</div>' +
              '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + _guideProgramSearch + ' letters of recommendation requirements') + '" target="_blank" style="display:inline-block; font-size:0.72rem; margin-top:4px; padding:2px 8px; background:#059669; color:#fff; border-radius:10px; text-decoration:none;">Find LOR requirements &rarr;</a>' +
            '</div></div>' +
            '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCC4</div><div class="checklist-content">' +
              '<div class="checklist-label">Resume / CV</div>' +
              '<div class="checklist-detail">' + (_deptReqs ? _deptReqs.resume : 'Academic CV highlighting research, publications, relevant coursework, and professional experience.') + '</div>' +
            '</div></div>' +
            '<div class="checklist-item"><div class="checklist-icon">\uD83C\uDF93</div><div class="checklist-content">' +
              '<div class="checklist-label">Transcripts & Prerequisites</div>' +
              '<div class="checklist-detail">' + (_deptReqs ? _deptReqs.transcripts : 'Official transcripts from all post-secondary institutions required.') + '</div>' +
            '</div></div>' +
            '<div class="checklist-item"><div class="checklist-icon">\uD83D\uDCCA</div><div class="checklist-content">' +
              '<div class="checklist-label">GPA & Test Scores</div>' +
              '<div class="checklist-detail">' + (_deptReqs ? 'GPA: ' + _deptReqs.gpa + ' | GRE: ' + _deptReqs.gre : 'Requirements vary by program. Many programs have made GRE optional.') + '</div>' +
              '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + _guideProgramSearch + ' GPA GRE requirements minimum') + '" target="_blank" style="display:inline-block; font-size:0.72rem; margin-top:4px; padding:2px 8px; background:#6366f1; color:#fff; border-radius:10px; text-decoration:none;">Find GPA &amp; test requirements &rarr;</a>' +
            '</div></div>' +
            '<div class="checklist-item"><div class="checklist-icon">\uD83C\uDF10</div><div class="checklist-content">' +
              '<div class="checklist-label">English Proficiency (International Students)</div>' +
              '<div class="checklist-detail">' + (_deptReqs ? _deptReqs.english : 'TOEFL, IELTS, or Duolingo scores required for non-native English speakers.') + '</div>' +
              '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + _guideProgramSearch + ' TOEFL IELTS minimum score international students') + '" target="_blank" style="display:inline-block; font-size:0.72rem; margin-top:4px; padding:2px 8px; background:#0891b2; color:#fff; border-radius:10px; text-decoration:none;">Find English proficiency requirements &rarr;</a>' +
            '</div></div>';

        // Special notes / insider tips for this field
        if (_deptReqs && _deptReqs.special) {
          html += '<div class="checklist-item" style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(168,85,247,0.06)); border-radius: 12px; padding: 10px;"><div class="checklist-icon">\uD83D\uDCA1</div><div class="checklist-content">' +
              '<div class="checklist-label" style="color: var(--accent); font-weight: 800;">Important Notes for ' + _deptReqs.label + ' Applicants</div>' +
              '<div class="checklist-detail">' + _deptReqs.special + '</div>' +
            '</div></div>';
        }

        html += '</div></div>';
      }

      // ── For NON-CURATED programs: show structured requirements with research links ──
      // Build a list of grad programs that DON'T already have curated data
      var curatedNames = curatedPrograms.map(function(p) { return p.name.toLowerCase(); });
      var allGradProgs = masterProgs.concat(doctoralProgs);
      // Pick up to 8 notable grad programs to show the requirement research template for
      var templateProgs = allGradProgs.filter(function(p) {
        var title = (p.title || '').toLowerCase();
        // Skip if we already showed curated details for a similar program
        var alreadyCurated = curatedNames.some(function(cn) { return title.indexOf(cn) >= 0 || cn.indexOf(title) >= 0; });
        return !alreadyCurated;
      });
      // Sort: prioritize common/popular programs
      templateProgs.sort(function(a,b) { return (a.title || '').localeCompare(b.title || ''); });
      var showProgs = templateProgs.slice(0, 8);

      if (showProgs.length > 0) {
        html += '<div class="modal-section">' +
          '<h3>Admission Requirements Lookup' + (_guideProgCtx ? ' — ' + _guideProgCtx : '') + '</h3>' +
          '<p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 12px;">Click any link below to find specific admission details for each program. Each link opens a targeted search to help you find GPA, GRE, essay, and deadline requirements.</p>';

        showProgs.forEach(function(p) {
          var progTitle = p.title || 'Graduate Program';
          var credTitle = (p.credential && p.credential.title) ? p.credential.title : '';
          var sq = encodeURIComponent(name + ' ' + progTitle + ' ' + credTitle);

          html += '<div style="border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 10px;">' +
            '<h4 style="margin: 0 0 8px;">' + progTitle + (credTitle ? ' <span style="font-weight:400; color: var(--muted); font-size: 0.85rem;">(' + credTitle + ')</span>' : '') + '</h4>' +

            '<div class="checklist-grid">' +
              '<div class="checklist-item">' +
                '<div class="checklist-icon">\uD83D\uDCCA</div>' +
                '<div class="checklist-content">' +
                  '<div class="checklist-label">GPA &amp; Test Scores</div>' +
                  '<div class="checklist-detail"><a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + progTitle + ' minimum GPA GRE requirements') + '" target="_blank" style="color: var(--accent);">Find GPA &amp; GRE requirements &rarr;</a></div>' +
                '</div>' +
              '</div>' +
              '<div class="checklist-item">' +
                '<div class="checklist-icon">\uD83D\uDCDD</div>' +
                '<div class="checklist-content">' +
                  '<div class="checklist-label">Essays &amp; Statement of Purpose</div>' +
                  '<div class="checklist-detail"><a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + progTitle + ' statement of purpose essay prompts') + '" target="_blank" style="color: var(--accent);">Find essay requirements &rarr;</a></div>' +
                '</div>' +
              '</div>' +
              '<div class="checklist-item">' +
                '<div class="checklist-icon">\uD83D\uDCE8</div>' +
                '<div class="checklist-content">' +
                  '<div class="checklist-label">Letters of Recommendation</div>' +
                  '<div class="checklist-detail"><a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + progTitle + ' letters of recommendation requirements') + '" target="_blank" style="color: var(--accent);">Find LOR requirements &rarr;</a></div>' +
                '</div>' +
              '</div>' +
              '<div class="checklist-item">' +
                '<div class="checklist-icon">\uD83D\uDCC5</div>' +
                '<div class="checklist-content">' +
                  '<div class="checklist-label">Deadlines &amp; Application Fee</div>' +
                  '<div class="checklist-detail"><a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + progTitle + ' application deadline fee') + '" target="_blank" style="color: var(--accent);">Find deadlines &amp; fees &rarr;</a></div>' +
                '</div>' +
              '</div>' +
              '<div class="checklist-item">' +
                '<div class="checklist-icon">\uD83C\uDF10</div>' +
                '<div class="checklist-content">' +
                  '<div class="checklist-label">English Proficiency (TOEFL / IELTS)</div>' +
                  '<div class="checklist-detail"><a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + progTitle + ' TOEFL IELTS minimum score') + '" target="_blank" style="color: var(--accent);">Find English proficiency requirements &rarr;</a></div>' +
                '</div>' +
              '</div>' +
              '<div class="checklist-item">' +
                '<div class="checklist-icon">\uD83D\uDCC4</div>' +
                '<div class="checklist-content">' +
                  '<div class="checklist-label">Resume, Transcripts &amp; Prerequisites</div>' +
                  '<div class="checklist-detail"><a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + progTitle + ' admissions requirements prerequisites') + '" target="_blank" style="color: var(--accent);">Find full requirements &rarr;</a></div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
        });

        if (templateProgs.length > 8) {
          html += '<p style="color: var(--muted); font-size: 0.85rem; text-align: center;">+ ' + (templateProgs.length - 8) + ' more graduate programs. <a href="https://www.google.com/search?q=' + encodeURIComponent(name + ' graduate programs admissions') + '" target="_blank" style="color: var(--accent);">Search all programs &rarr;</a></p>';
        }
        html += '</div>';
      }

      // Career Outlook section (BLS links)
      var allProgsForBLS = masterProgs.concat(doctoralProgs);
      var blsLinksHtml = '';
      var shownBLS = {};
      allProgsForBLS.forEach(function(p) {
        var bls = getBLSLink(p.title);
        if (bls && !shownBLS[bls.url]) {
          shownBLS[bls.url] = true;
          blsLinksHtml += '<a href="' + bls.url + '" target="_blank" class="link-button" style="background: linear-gradient(135deg, rgba(5,150,105,0.1), rgba(5,150,105,0.05)); border-color: var(--success);">\uD83D\uDCBC ' + bls.title + '</a>';
        }
      });
      if (blsLinksHtml) {
        html += '<div class="modal-section">' +
          '<h3>\uD83D\uDCBC Career Outlook</h3>' +
          '<p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 12px;">Bureau of Labor Statistics occupation data for fields offered at ' + name + ':</p>' +
          '<div class="link-buttons">' + blsLinksHtml + '</div>' +
        '</div>';
      }

      // Rankings section
      var encodedName = encodeURIComponent(name);
      var overallRank = getOverallRanking(name);
      html += '<div class="modal-section">' +
        '<h3>\uD83C\uDFC6 Rankings</h3>';

      if (overallRank) {
        // Show actual ranking numbers with big styled display
        html += '<div class="overview-grid" style="margin-bottom: 12px;">';
        if (overallRank.un) html += '<div class="overview-item" style="text-align:center;"><div class="overview-item-label">U.S. News (National)</div><div class="overview-item-value" style="font-size: 1.4rem; color: #1a365d; font-weight: 800;">#' + overallRank.un + '</div></div>';
        if (overallRank.qs) html += '<div class="overview-item" style="text-align:center;"><div class="overview-item-label">QS World</div><div class="overview-item-value" style="font-size: 1.4rem; color: #0070c0; font-weight: 800;">#' + overallRank.qs + '</div></div>';
        if (overallRank.the) html += '<div class="overview-item" style="text-align:center;"><div class="overview-item-label">THE World</div><div class="overview-item-value" style="font-size: 1.4rem; color: #9b2335; font-weight: 800;">#' + overallRank.the + '</div></div>';
        html += '</div>';

        // Show program-specific rankings if any programs have them
        var allGradForRanking = masterProgs.concat(doctoralProgs);
        var progRankHtml = '';
        var shownFields = {};
        allGradForRanking.forEach(function(p) {
          var pr = getProgramRanking(name, p.title);
          if (pr && !shownFields[pr.field]) {
            shownFields[pr.field] = true;
            progRankHtml += '<span style="display:inline-block; background: var(--accent); color:#fff; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin: 3px 4px;">#' + pr.rank + ' in ' + pr.field.charAt(0).toUpperCase() + pr.field.slice(1) + '</span>';
          }
        });
        if (progRankHtml) {
          html += '<div style="margin-bottom: 10px;"><div style="font-size: 0.8rem; color: var(--muted); margin-bottom: 6px;">Program Rankings (U.S. News):</div>' + progRankHtml + '</div>';
        }
      }

      html += '<p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 12px;">' + (overallRank ? 'View detailed rankings:' : 'Check this school\'s latest rankings:') + '</p>' +
        '<div class="link-buttons">' +
          '<a href="https://www.usnews.com/best-graduate-schools/search?name=' + encodedName + '" target="_blank" class="link-button" style="background: linear-gradient(135deg, #1a365d, #2c5282); color: #fff; border: none;">' + (overallRank && overallRank.un ? '#' + overallRank.un + ' ' : '') + 'U.S. News Rankings</a>' +
          '<a href="https://www.topuniversities.com/universities?q=' + encodedName + '" target="_blank" class="link-button" style="background: linear-gradient(135deg, #1e3a5f, #0070c0); color: #fff; border: none;">' + (overallRank && overallRank.qs ? '#' + overallRank.qs + ' ' : '') + 'QS World Rankings</a>' +
          '<a href="https://www.timeshighereducation.com/world-university-rankings?search=' + encodedName + '" target="_blank" class="link-button" style="background: linear-gradient(135deg, #6b0f1a, #9b2335); color: #fff; border: none;">' + (overallRank && overallRank.the ? '#' + overallRank.the + ' ' : '') + 'THE World Rankings</a>' +
        '</div>' +
      '</div>';

      // Key resources links — use program context from search if available
      var progCtx = _lastSearchProgramLabel || '';
      var progCtxForSearch = progCtx ? ' ' + progCtx : ' graduate';
      var progCtxLabel = progCtx || 'Graduate';

      html += '<div class="modal-section">' +
        '<h3>Key Resources' + (progCtx ? ' — ' + progCtx : '') + '</h3>' +
        '<div class="link-buttons">' +
          '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + progCtxForSearch + ' program department') + '" target="_blank" class="link-button">' + progCtxLabel + ' Department Page</a>' +
          '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + progCtxForSearch + ' admissions requirements') + '" target="_blank" class="link-button">' + progCtxLabel + ' Admissions</a>' +
          '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + progCtxForSearch + ' application portal apply') + '" target="_blank" class="link-button">Application Portal</a>' +
          '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + progCtxForSearch + ' financial aid scholarships fellowships') + '" target="_blank" class="link-button">Financial Aid &amp; Fellowships</a>' +
          '<a href="https://www.google.com/search?q=' + encodeURIComponent(name + progCtxForSearch + ' tuition cost') + '" target="_blank" class="link-button">Tuition &amp; Costs</a>' +
          '<a href="' + fullUrl + '" target="_blank" class="link-button">' + name + ' Main Website</a>' +
        '</div>' +
      '</div>';

      // Disclaimer
      html += '<div class="modal-section">' +
        '<div class="disclaimer-box">' +
          '<strong>Important Reminder</strong> ' +
          (curatedPrograms.length > 0 ?
            'Detailed requirements are curated by AdmitKit and may change. ' :
            'This information comes from the U.S. Department of Education\'s College Scorecard. ') +
          'Verify all details with the institution\'s official admissions office before submitting your application.' +
        '</div>' +
      '</div>';

      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Override closeModal to restore save button to curated mode
    var _origCloseModal = closeModal;
    closeModal = function() {
      _origCloseModal();
      var modalSaveBtn = document.getElementById('modal-save-btn');
      if (modalSaveBtn) {
        modalSaveBtn.style.display = '';
        modalSaveBtn.removeAttribute('data-api-cache-key');
        modalSaveBtn.onclick = toggleSaveFromModal;
      }
    };

    function showPage(pageName) {
      document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
      document.getElementById(pageName + '-page').classList.add('active');
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      const navMap = { search: 0, saved: 1, about: 2, disclaimer: 3 };
      if (navMap[pageName] !== undefined) {
        document.querySelectorAll('.nav-link')[navMap[pageName]].classList.add('active');
      }
      if (pageName === 'search') loadPrograms();
      if (pageName === 'saved') renderSavedPage();
      window.scrollTo(0, 0);
    }

    // Close modal on backdrop click
    window.onclick = function(e) {
      if (e.target === document.getElementById('modal')) closeModal();
    };

    // Close modal on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });

    // ─── Save / Bookmark System ───────────────────────────────────
    function getSavedPrograms() {
      try { const s = localStorage.getItem('ak-saved-programs'); return s ? JSON.parse(s) : []; }
      catch(e) { return []; }
    }

    function saveProgramsToStorage(ids) {
      try { localStorage.setItem('ak-saved-programs', JSON.stringify(ids)); } catch(e) {}
    }

    function isSaved(programId) {
      return getSavedPrograms().includes(programId);
    }

    // ─── Application Tracking ─────────────────────────────────────────
    // Stores status + notes for each saved program/school
    var APP_STATUSES = [
      { value: '', label: 'No Status', color: '#9ca3af' },
      { value: 'researching', label: 'Researching', color: '#6366f1' },
      { value: 'preparing', label: 'Preparing Materials', color: '#0891b2' },
      { value: 'applied', label: 'Applied', color: '#d97706' },
      { value: 'interview', label: 'Interview Scheduled', color: '#7c3aed' },
      { value: 'accepted', label: 'Accepted', color: '#059669' },
      { value: 'waitlisted', label: 'Waitlisted', color: '#ea580c' },
      { value: 'rejected', label: 'Not Accepted', color: '#dc2626' },
      { value: 'declined', label: 'Offer Declined', color: '#6b7280' }
    ];

    function getAppTracker() {
      try { return JSON.parse(localStorage.getItem('ak-app-tracker') || '{}'); } catch(e) { return {}; }
    }
    function saveAppTracker(data) {
      try { localStorage.setItem('ak-app-tracker', JSON.stringify(data)); } catch(e) {}
    }
    function getTrackingKey(type, id) {
      return type + ':' + id; // e.g., "curated:5" or "api:MIT|MA"
    }
    function getTracking(trackKey) {
      var tracker = getAppTracker();
      return tracker[trackKey] || { status: '', notes: '' };
    }
    function updateTrackingStatus(trackKey, newStatus) {
      var tracker = getAppTracker();
      if (!tracker[trackKey]) tracker[trackKey] = { status: '', notes: '' };
      tracker[trackKey].status = newStatus;
      tracker[trackKey].updatedAt = new Date().toISOString();
      saveAppTracker(tracker);
      renderSavedPage(); // Re-render to update badge colors
    }
    function updateTrackingNotes(trackKey, notes) {
      var tracker = getAppTracker();
      if (!tracker[trackKey]) tracker[trackKey] = { status: '', notes: '' };
      tracker[trackKey].notes = notes;
      tracker[trackKey].updatedAt = new Date().toISOString();
      saveAppTracker(tracker);
    }

    function buildTrackingUI(trackKey) {
      var tracking = getTracking(trackKey);
      var statusObj = APP_STATUSES.find(function(s) { return s.value === tracking.status; }) || APP_STATUSES[0];
      var optionsHtml = APP_STATUSES.map(function(s) {
        return '<option value="' + s.value + '"' + (s.value === tracking.status ? ' selected' : '') + '>' + s.label + '</option>';
      }).join('');

      return '<div style="margin-top:8px; border-top: 1px dashed var(--border); padding-top: 8px;" onclick="event.stopPropagation();">' +
        '<div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">' +
          '<span style="font-size:0.7rem; font-weight:600; color:var(--muted);">Status:</span>' +
          '<select onchange="updateTrackingStatus(\'' + trackKey + '\', this.value)" style="font-size:0.72rem; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-primary); cursor:pointer;">' + optionsHtml + '</select>' +
          (statusObj.value ? '<span style="display:inline-block; font-size:0.65rem; padding:1px 7px; background:' + statusObj.color + '; color:#fff; border-radius:8px; font-weight:600;">' + statusObj.label + '</span>' : '') +
        '</div>' +
        '<div style="margin-top:4px;">' +
          '<textarea onblur="updateTrackingNotes(\'' + trackKey + '\', this.value)" onclick="event.stopPropagation();" placeholder="Add notes..." style="width:100%; font-size:0.75rem; padding:4px 6px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-primary); resize:vertical; min-height:24px; max-height:80px; font-family:var(--font);">' + (tracking.notes || '').replace(/</g, '&lt;') + '</textarea>' +
        '</div>' +
      '</div>';
    }

    function toggleSave(programId) {
      const saved = getSavedPrograms();
      const idx = saved.indexOf(programId);
      if (idx > -1) saved.splice(idx, 1);
      else saved.push(programId);
      saveProgramsToStorage(saved);
      updateBadge();
      // Re-render current view
      const active = document.querySelector('.page-section.active');
      if (active && active.id === 'search-page') renderCards();
      else if (active && active.id === 'saved-page') renderSavedPage();
    }

    function toggleSaveFromModal() {
      const btn = document.getElementById('modal-save-btn');
      const programId = parseInt(btn.getAttribute('data-program-id'));
      toggleSave(programId);
      if (isSaved(programId)) {
        btn.classList.add('saved');
        btn.innerHTML = '&#9733; Saved';
      } else {
        btn.classList.remove('saved');
        btn.innerHTML = '&#9733; Save';
      }
    }

    // ─── API School Save System ─────────────────────────────────────────
    // Parallel save system for API results (stored as objects with school data)
    function getSavedApiSchools() {
      try { return JSON.parse(localStorage.getItem('ak-saved-api-schools') || '[]'); } catch(e) { return []; }
    }
    function saveApiSchoolsToStorage(schools) {
      try { localStorage.setItem('ak-saved-api-schools', JSON.stringify(schools)); } catch(e) {}
    }
    function getApiSchoolKey(school) {
      return (school['school.name'] || '') + '|' + (school['school.state'] || '');
    }
    function isApiSchoolSaved(school) {
      var key = getApiSchoolKey(school);
      return getSavedApiSchools().some(function(s) { return getApiSchoolKey(s) === key; });
    }
    function toggleSaveApiSchool(cacheKey) {
      var school = _apiResultsCache[cacheKey];
      if (!school) return;
      var saved = getSavedApiSchools();
      var key = getApiSchoolKey(school);
      var idx = -1;
      for (var i = 0; i < saved.length; i++) {
        if (getApiSchoolKey(saved[i]) === key) { idx = i; break; }
      }
      if (idx > -1) {
        saved.splice(idx, 1);
      } else {
        // Store a slim copy (only the fields we need)
        saved.push({
          'school.name': school['school.name'],
          'school.city': school['school.city'],
          'school.state': school['school.state'],
          'school.school_url': school['school.school_url'],
          'school.ownership': school['school.ownership'],
          'school.locale': school['school.locale'],
          'latest.cost.tuition.in_state': school['latest.cost.tuition.in_state'],
          'latest.cost.tuition.out_of_state': school['latest.cost.tuition.out_of_state'],
          'latest.cost.avg_net_price.overall': school['latest.cost.avg_net_price.overall'],
          'latest.earnings.10_yrs_after_entry.mean_earnings': school['latest.earnings.10_yrs_after_entry.mean_earnings'],
          'latest.completion.completion_rate_4yr_150nt': school['latest.completion.completion_rate_4yr_150nt'],
          'latest.student.retention_rate.four_year.full_time': school['latest.student.retention_rate.four_year.full_time'],
          'latest.aid.median_debt.completers.overall': school['latest.aid.median_debt.completers.overall'],
          'latest.programs.cip_4_digit': school['latest.programs.cip_4_digit']
        });
      }
      saveApiSchoolsToStorage(saved);
      updateBadge();
      return idx === -1; // returns true if newly saved, false if removed
    }
    function toggleSaveApiFromModal() {
      var btn = document.getElementById('modal-save-btn');
      var cacheKey = btn.getAttribute('data-api-cache-key');
      if (!cacheKey) return;
      var nowSaved = toggleSaveApiSchool(cacheKey);
      if (nowSaved) {
        btn.classList.add('saved');
        btn.innerHTML = '&#9733; Saved';
      } else {
        btn.classList.remove('saved');
        btn.innerHTML = '&#9733; Save';
      }
    }

    function updateBadge() {
      const saved = getSavedPrograms();
      const savedApi = getSavedApiSchools();
      const total = saved.length + savedApi.length;
      const badge = document.getElementById('save-badge');
      if (total > 0) {
        badge.textContent = '(' + total + ')';
        badge.style.display = 'inline';
      } else {
        badge.textContent = '';
        badge.style.display = 'none';
      }
    }

    function clearAllSaved() {
      if (!confirm('Remove all saved programs and schools?')) return;
      saveProgramsToStorage([]);
      saveApiSchoolsToStorage([]);
      updateBadge();
      renderSavedPage();
    }

    function sortSavedApiSchools(schools, mode) {
      var sorted = schools.slice();
      switch (mode) {
        case 'tuition-asc':
          sorted.sort(function(a, b) {
            var tA = a['latest.cost.tuition.out_of_state'] || a['latest.cost.tuition.in_state'] || 999999;
            var tB = b['latest.cost.tuition.out_of_state'] || b['latest.cost.tuition.in_state'] || 999999;
            return tA - tB;
          });
          break;
        case 'tuition-desc':
          sorted.sort(function(a, b) {
            var tA = a['latest.cost.tuition.out_of_state'] || a['latest.cost.tuition.in_state'] || 0;
            var tB = b['latest.cost.tuition.out_of_state'] || b['latest.cost.tuition.in_state'] || 0;
            return tB - tA;
          });
          break;
        case 'living-asc':
          sorted.sort(function(a, b) {
            return getEstimatedLivingCost(a['school.state']) - getEstimatedLivingCost(b['school.state']);
          });
          break;
        case 'living-desc':
          sorted.sort(function(a, b) {
            return getEstimatedLivingCost(b['school.state']) - getEstimatedLivingCost(a['school.state']);
          });
          break;
        case 'total-asc':
          sorted.sort(function(a, b) { return getEstimatedTotalCost(a) - getEstimatedTotalCost(b); });
          break;
        case 'total-desc':
          sorted.sort(function(a, b) { return getEstimatedTotalCost(b) - getEstimatedTotalCost(a); });
          break;
        case 'ranking':
          sorted.sort(function(a, b) {
            var rA = getOverallRanking(a['school.name'] || '');
            var rB = getOverallRanking(b['school.name'] || '');
            var scoreA = rA ? Math.min(rA.un || 9999, rA.qs || 9999, rA.the || 9999) : 9999;
            var scoreB = rB ? Math.min(rB.un || 9999, rB.qs || 9999, rB.the || 9999) : 9999;
            return scoreA - scoreB;
          });
          break;
        default: // 'name'
          sorted.sort(function(a, b) {
            return (a['school.name'] || '').localeCompare(b['school.name'] || '');
          });
          break;
      }
      return sorted;
    }

    function renderSavedPage() {
      const saved = getSavedPrograms();
      var savedApi = getSavedApiSchools();
      const emptyEl = document.getElementById('saved-empty');
      const contentEl = document.getElementById('saved-content');

      if (saved.length === 0 && savedApi.length === 0) {
        emptyEl.style.display = 'block';
        contentEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      contentEl.style.display = 'block';

      // Sort API schools based on dropdown
      var savedSortEl = document.getElementById('saved-sort');
      var savedSortMode = savedSortEl ? savedSortEl.value : 'name';
      savedApi = sortSavedApiSchools(savedApi, savedSortMode);

      // Show count
      var savedCountEl = document.getElementById('saved-count');
      var totalSaved = saved.length + savedApi.length;
      if (savedCountEl) savedCountEl.textContent = totalSaved + ' program' + (totalSaved !== 1 ? 's' : '') + ' saved';

      const grid = document.getElementById('saved-cards-grid');
      const savedPrograms = DATABASE.programs.filter(p => saved.includes(p.id));

      // Application tracking summary
      var tracker = getAppTracker();
      var statusCounts = {};
      APP_STATUSES.forEach(function(s) { if (s.value) statusCounts[s.value] = 0; });
      Object.keys(tracker).forEach(function(k) {
        var st = tracker[k].status;
        if (st && statusCounts[st] !== undefined) statusCounts[st]++;
      });
      var summaryHtml = '';
      var hasAnyStatus = Object.keys(statusCounts).some(function(k) { return statusCounts[k] > 0; });
      if (hasAnyStatus) {
        summaryHtml = '<div style="grid-column: 1 / -1; display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">';
        APP_STATUSES.forEach(function(s) {
          if (s.value && statusCounts[s.value] > 0) {
            summaryHtml += '<span style="font-size:0.72rem; padding:3px 10px; background:' + s.color + '; color:#fff; border-radius:12px; font-weight:600;">' + s.label + ': ' + statusCounts[s.value] + '</span>';
          }
        });
        summaryHtml += '</div>';
      }

      // Curated program cards
      var cardsHtml = summaryHtml + savedPrograms.map(prog => {
        const school = DATABASE.schools.find(s => s.id === prog.schoolId);
        const tuition = prog.tuitionInState ? '$' + (prog.tuitionInState / 1000).toFixed(0) + 'K' : 'N/A';
        var trackKey = getTrackingKey('curated', prog.id);
        return '<div class="card" onclick="openModal(' + prog.id + ')" style="position:relative;">' +
          '<button class="bookmark-btn saved" onclick="event.stopPropagation(); toggleSave(' + prog.id + ');" title="Remove from saved" aria-label="Remove program">&#9733;</button>' +
          '<div class="card-school">' + school.name + '</div>' +
          '<div class="card-program">' + prog.name + '</div>' +
          '<div class="card-tags">' +
            '<span class="tag degree">' + prog.degreeType + '</span>' +
            '<span class="tag format">' + prog.format + '</span>' +
            '<span class="tag">' + prog.duration + '</span>' +
          '</div>' +
          '<div class="card-info"><strong>Tuition:</strong> ' + tuition + ' &middot; <strong>Dept:</strong> ' + prog.department + '</div>' +
          buildTrackingUI(trackKey) +
          '<span class="card-cta">View requirements &rarr;</span>' +
        '</div>';
      }).join('');

      // Saved API school cards
      if (savedApi.length > 0) {
        if (savedPrograms.length > 0) {
          cardsHtml += '<div style="grid-column: 1 / -1; margin: 12px 0 4px; border-top: 1px solid var(--border); padding-top: 12px;">' +
            '<div style="display: inline-block; background: var(--accent); color: #fff; padding: 4px 12px; border-radius: 16px; font-size: 0.75rem; font-weight: 600;">Saved from Live Search</div></div>';
        }
        cardsHtml += savedApi.map(function(school, idx) {
          // Cache so modal can access
          var cacheKey = 'saved_' + idx;
          _apiResultsCache[cacheKey] = school;
          var name = school['school.name'] || 'Unknown';
          var city = school['school.city'] || '';
          var state = school['school.state'] || '';
          var setting = getLocaleSetting(school['school.locale']);
          var tuitionStr = formatTuition(school);
          var outcomes = getSchoolOutcomes(school);
          var programs = school['latest.programs.cip_4_digit'] || [];
          var gradPrograms = programs.filter(function(p) { return p.credential && (p.credential.level === 5 || p.credential.level === 6); });
          var savedFirstGrad = gradPrograms.length > 0 ? gradPrograms[0] : null;
          var savedProgLabel, savedProgUrl;
          if (savedFirstGrad && savedFirstGrad.title) {
            savedProgLabel = 'Find ' + savedFirstGrad.title + ' program page';
            savedProgUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + savedFirstGrad.title + ' admissions program');
          } else {
            savedProgLabel = 'Find graduate admissions page';
            savedProgUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' graduate admissions programs');
          }

          var apiTrackKey = getTrackingKey('api', getApiSchoolKey(school));
          return '<div class="school-card" onclick="openApiModal(\'' + cacheKey + '\')" style="cursor:pointer; position:relative;">' +
            '<button class="bookmark-btn saved" onclick="event.stopPropagation(); toggleSaveApiSchool(\'' + cacheKey + '\'); renderSavedPage();" title="Remove from saved" aria-label="Remove school">&#9733;</button>' +
            '<div class="school-card-name">' + name + '</div>' +
            '<div class="school-card-location">' + city + ', ' + state + '</div>' +
            '<div class="school-stats">' +
              '<div class="school-stat"><div class="school-stat-label">Setting</div><div class="school-stat-value">' + setting + '</div></div>' +
              '<div class="school-stat"><div class="school-stat-label">Tuition</div><div class="school-stat-value">' + tuitionStr + '</div></div>' +
              '<div class="school-stat"><div class="school-stat-label">Est. Living Cost</div><div class="school-stat-value" style="color:#0369a1;">' + formatLivingCost(state) + '</div></div>' +
              '<div class="school-stat"><div class="school-stat-label">Grad Programs</div><div class="school-stat-value">' + gradPrograms.length + '</div></div>' +
              (outcomes.earnings ? '<div class="school-stat"><div class="school-stat-label">Avg Salary (10yr)</div><div class="school-stat-value" style="color:#059669;">' + outcomes.earnings + '</div></div>' : '') +
            '</div>' +
            buildRankingDisplay(name, null) +
            buildTrackingUI(apiTrackKey) +
            '<a href="' + savedProgUrl + '" target="_blank" onclick="event.stopPropagation();" class="school-card-link" style="cursor:pointer; color:var(--accent); text-decoration:none;">' + savedProgLabel + ' &rarr;</a>' +
          '</div>';
        }).join('');
      }

      grid.innerHTML = cardsHtml;
    }

    // ─── Toast Notification ───────────────────────────────────
    function showToast(icon, message, duration) {
      duration = duration || 3000;
      const toast = document.getElementById('toast');
      const toastText = document.getElementById('toast-text');
      toast.querySelector('.toast-icon').textContent = icon;
      toastText.textContent = message;
      toast.classList.add('visible');
      setTimeout(function() { toast.classList.remove('visible'); }, duration);
    }

    // ─── CSV Export ───────────────────────────────────
    function exportSavedCSV() {
      const saved = getSavedPrograms();
      const savedApi = getSavedApiSchools();
      if (saved.length === 0 && savedApi.length === 0) { alert('No programs saved to export.'); return; }

      const savedPrograms = DATABASE.programs.filter(p => saved.includes(p.id));
      const headers = ['School','City','State','Program','Degree','Department','Duration','Format','Tuition (In-State)','Tuition (Out-of-State)','Est. Living Cost (Annual)','Setting','Avg Earnings (10yr)','Graduation Rate','Retention Rate','Rankings','Min GPA','GRE','Essays / Statement of Purpose','Letters of Recommendation','Resume / CV Requirements','Transcripts','Language / English Proficiency','Prerequisites','Work Experience','Fall Deadline','Spring Deadline','Rolling','Application Fee','Other Requirements','Notes','Program Department Link','School Website'];

      const rows = [headers];

      // Curated programs — one row per program with full details
      savedPrograms.forEach(prog => {
        const school = DATABASE.schools.find(s => s.id === prog.schoolId);
        const req = DATABASE.requirements.find(r => r.programId === prog.id);
        var overallRank = getOverallRanking(school.name);
        var rankStr = overallRank ? ('U.S. News: #' + (overallRank.un || 'N/A') + ' | QS: #' + (overallRank.qs || 'N/A') + ' | THE: #' + (overallRank.the || 'N/A')) : '';
        rows.push([
          school.name, school.city || '', school.state || '',
          prog.name, prog.degreeType, prog.department, prog.duration, prog.format,
          prog.tuitionInState || '', prog.tuitionOutState || '',
          '$' + getEstimatedLivingCost(school.state).toLocaleString(),
          '', '', '', '',
          rankStr,
          req.minGpa || '', req.greRequired || '',
          req.essayDetails || (req.personalStatement ? 'Personal statement required' : 'Not required'),
          req.lorDetails || (req.lettersOfRec + ' letter(s) required'),
          req.cvDetails || (req.resumeCv ? 'Required' : 'Not required'),
          req.transcriptDetails || req.transcripts || '',
          req.languageTestDetails || ('TOEFL: ' + (req.toeflMin || 'N/A') + ' | IELTS: ' + (req.ieltsMin || 'N/A')),
          req.prerequisites || '', req.workExperience || '',
          req.fallDeadline || '', req.springDeadline || '', req.rollingAdmissions ? 'Yes' : 'No',
          req.applicationFee || '', req.otherRequirements || '', req.notes || '',
          'https://www.google.com/search?q=' + encodeURIComponent(school.name + ' ' + prog.name + ' program department admissions'),
          school.website || ''
        ]);
      });

      // API schools — one row per graduate program with school-level data
      savedApi.forEach(function(school) {
        var name = school['school.name'] || '';
        var city = school['school.city'] || '';
        var state = school['school.state'] || '';
        var setting = getLocaleSetting(school['school.locale']);
        var inState = school['latest.cost.tuition.in_state'] || '';
        var outState = school['latest.cost.tuition.out_of_state'] || '';
        var sUrl = school['school.school_url'] || '';
        var fullUrl = sUrl ? (sUrl.startsWith('http') ? sUrl : 'https://' + sUrl) : '';
        var outcomes = getSchoolOutcomes(school);
        var overallRank = getOverallRanking(name);
        var rankStr = overallRank ? ('U.S. News: #' + (overallRank.un || 'N/A') + ' | QS: #' + (overallRank.qs || 'N/A') + ' | THE: #' + (overallRank.the || 'N/A')) : '';
        var programs = school['latest.programs.cip_4_digit'] || [];
        var gradProgs = programs.filter(function(p) { return p.credential && (p.credential.level === 5 || p.credential.level === 6); });

        if (gradProgs.length === 0) {
          // No grad programs — single row for school
          var deptLink0 = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' graduate program department admissions');
          rows.push([
            name, city, state,
            'See school website', '', '', '', '',
            inState, outState,
            '$' + getEstimatedLivingCost(state).toLocaleString(),
            setting,
            outcomes.earnings || '', outcomes.gradRate || '', outcomes.retention || '',
            rankStr,
            'Check program website', 'Check program website', 'Statement of Purpose typically required',
            '2-3 letters typically required', 'Typically required', 'Official transcripts required',
            'TOEFL/IELTS required for international students',
            'Check program website', '', '', '', '', '', '', '',
            deptLink0, fullUrl
          ]);
        } else {
          // One row per grad program — with department-specific requirements
          gradProgs.forEach(function(p) {
            var pTitle = p.title || 'Unknown Program';
            var credTitle = (p.credential && p.credential.title) ? p.credential.title : '';
            var degreeType = (p.credential && p.credential.level === 5) ? "Master's" : 'Doctoral';
            var progRank = getProgramRanking(name, pTitle);
            var fullRank = rankStr + (progRank ? ' | #' + progRank.rank + ' in ' + progRank.field : '');
            var deptLink = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + pTitle + ' program department admissions');
            var csvReqs = getProgramRequirements(pTitle);
            var csvGpa = csvReqs ? csvReqs.gpa : 'Check program website';
            var csvGre = csvReqs ? csvReqs.gre : 'Check program website';
            var csvSop = csvReqs ? csvReqs.sop : 'Statement of Purpose typically required';
            var csvLor = csvReqs ? csvReqs.lor : '2-3 letters typically required';
            var csvResume = csvReqs ? csvReqs.resume : 'Typically required';
            var csvTranscripts = csvReqs ? csvReqs.transcripts : 'Official transcripts required';
            var csvEnglish = csvReqs ? csvReqs.english : 'TOEFL/IELTS required for international students';
            var csvPrereqs = csvReqs ? (csvReqs.special || '') : '';
            var csvOther = csvReqs && csvReqs.portfolio ? 'PORTFOLIO: ' + csvReqs.portfolio : '';
            rows.push([
              name, city, state,
              pTitle, degreeType, '', credTitle, '',
              inState, outState,
              '$' + getEstimatedLivingCost(state).toLocaleString(),
              setting,
              outcomes.earnings || '', outcomes.gradRate || '', outcomes.retention || '',
              fullRank,
              csvGpa, csvGre, csvSop,
              csvLor, csvResume, csvTranscripts,
              csvEnglish,
              csvPrereqs, '', '', '', '', '', csvOther, '',
              deptLink, fullUrl
            ]);
          });
        }
      });

      const csv = rows.map(row =>
        row.map(cell => {
          const str = String(cell === null || cell === undefined ? '' : cell).replace(/"/g, '""');
          return (str.includes(',') || str.includes('"') || str.includes('\n')) ? '"' + str + '"' : str;
        }).join(',')
      ).join('\n');

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'admitkit-saved-programs.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ─── PDF Export (Print-to-PDF — no external libraries needed) ───────
    function exportSavedPDF() {
      var saved = getSavedPrograms();
      var savedApi = getSavedApiSchools();
      if (saved.length === 0 && savedApi.length === 0) { alert('No programs saved to export.'); return; }

      var savedPrograms = DATABASE.programs.filter(function(p) { return saved.includes(p.id); });
      var totalCount = savedPrograms.length + savedApi.length;
      var dateStr = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      // Build printable HTML
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>AdmitKit - Saved Programs</title>' +
        '<style>' +
          '* { box-sizing: border-box; margin: 0; padding: 0; }' +
          'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; color: #1a1a2e; padding: 32px; font-size: 11px; line-height: 1.5; }' +
          'h1 { font-size: 22px; color: #7c3aed; margin-bottom: 4px; }' +
          '.subtitle { color: #666; font-size: 11px; margin-bottom: 20px; }' +
          'table { width: 100%; border-collapse: collapse; margin-bottom: 28px; page-break-inside: auto; }' +
          'th { background: #7c3aed; color: #fff; padding: 8px 10px; text-align: left; font-size: 10px; font-weight: 600; }' +
          'td { padding: 7px 10px; border-bottom: 1px solid #e5e5e5; font-size: 10px; vertical-align: top; }' +
          'tr:nth-child(even) { background: #f8f7ff; }' +
          '.school-section { margin-bottom: 22px; page-break-inside: avoid; border: 1px solid #e5e5e5; border-radius: 8px; padding: 16px; }' +
          '.school-name { font-size: 15px; font-weight: 700; color: #1a1a2e; margin-bottom: 2px; }' +
          '.school-location { color: #666; font-size: 11px; margin-bottom: 10px; }' +
          '.stats-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; }' +
          '.stat-item { background: #f3f0ff; border-radius: 6px; padding: 6px 12px; }' +
          '.stat-label { font-size: 9px; color: #666; text-transform: uppercase; font-weight: 600; }' +
          '.stat-value { font-size: 13px; font-weight: 700; color: #1a1a2e; }' +
          '.stat-value.green { color: #059669; }' +
          '.stat-value.amber { color: #d97706; }' +
          '.detail-row { margin-bottom: 6px; }' +
          '.detail-label { font-weight: 700; color: #444; display: inline; }' +
          '.detail-value { color: #333; display: inline; }' +
          '.prog-list { margin: 8px 0; padding-left: 18px; }' +
          '.prog-list li { margin-bottom: 3px; color: #333; }' +
          '.section-divider { border-top: 2px solid #7c3aed; margin: 6px 0 10px; opacity: 0.2; }' +
          '.rankings { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; }' +
          '.rank-pill { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; color: #fff; }' +
          '.rank-us { background: #1a365d; }' +
          '.rank-qs { background: #0070c0; }' +
          '.rank-the { background: #9b2335; }' +
          '.admission-guide { background: #f8f7ff; border-left: 3px solid #7c3aed; padding: 10px 14px; margin: 10px 0; border-radius: 0 6px 6px 0; }' +
          '.admission-guide .detail-row { margin-bottom: 4px; }' +
          '.footer { margin-top: 24px; padding-top: 12px; border-top: 1px solid #ddd; color: #999; font-size: 9px; text-align: center; }' +
          '@media print { body { padding: 16px; } .school-section { break-inside: avoid; } }' +
        '</style></head><body>';

      html += '<h1>AdmitKit &mdash; Saved Programs</h1>';
      html += '<div class="subtitle">Generated on ' + dateStr + ' &middot; ' + totalCount + ' item' + (totalCount !== 1 ? 's' : '') + ' saved</div>';

      // Summary table
      html += '<table><thead><tr><th>School</th><th>Program / Location</th><th>Tuition</th><th>Est. Living Cost</th><th>Setting</th><th>Avg Earnings</th><th>Grad Rate</th><th>Retention</th><th>Rankings</th></tr></thead><tbody>';

      savedPrograms.forEach(function(prog) {
        var school = DATABASE.schools.find(function(s) { return s.id === prog.schoolId; });
        var overallRank = getOverallRanking(school.name);
        var rankStr = '';
        if (overallRank) {
          var parts = [];
          if (overallRank.un) parts.push('#' + overallRank.un + ' USN');
          if (overallRank.qs) parts.push('#' + overallRank.qs + ' QS');
          if (overallRank.the) parts.push('#' + overallRank.the + ' THE');
          rankStr = parts.join(', ');
        }
        html += '<tr><td>' + school.name + '</td><td>' + prog.name + ' (' + prog.degreeType + ')</td><td>' + (prog.tuitionInState ? '$' + prog.tuitionInState.toLocaleString() : 'N/A') + '</td><td style="color:#0369a1;">' + formatLivingCost(school.state) + '</td><td>&mdash;</td><td>&mdash;</td><td>&mdash;</td><td>&mdash;</td><td>' + (rankStr || '&mdash;') + '</td></tr>';
      });

      savedApi.forEach(function(school) {
        var name = school['school.name'] || 'Unknown';
        var city = school['school.city'] || '';
        var state = school['school.state'] || '';
        var setting = getLocaleSetting(school['school.locale']);
        var outcomes = getSchoolOutcomes(school);
        var programs = school['latest.programs.cip_4_digit'] || [];
        var gradCount = programs.filter(function(p) { return p.credential && (p.credential.level === 5 || p.credential.level === 6); }).length;
        var overallRank = getOverallRanking(name);
        var rankStr = '';
        if (overallRank) {
          var parts = [];
          if (overallRank.un) parts.push('#' + overallRank.un + ' USN');
          if (overallRank.qs) parts.push('#' + overallRank.qs + ' QS');
          if (overallRank.the) parts.push('#' + overallRank.the + ' THE');
          rankStr = parts.join(', ');
        }
        html += '<tr><td><strong>' + name + '</strong></td><td>' + city + ', ' + state + ' (' + gradCount + ' grad programs)</td><td>' + formatTuition(school) + '</td><td style="color:#0369a1;">' + formatLivingCost(state) + '</td><td>' + setting + '</td><td>' + (outcomes.earnings || 'N/A') + '</td><td>' + (outcomes.gradRate || 'N/A') + '</td><td>' + (outcomes.retention || 'N/A') + '</td><td>' + (rankStr || 'N/A') + '</td></tr>';
      });

      html += '</tbody></table>';

      // Detailed sections for curated programs
      var itemIndex = 0;
      savedPrograms.forEach(function(prog) {
        var school = DATABASE.schools.find(function(s) { return s.id === prog.schoolId; });
        var req = DATABASE.requirements.find(function(r) { return r.programId === prog.id; });
        itemIndex++;

        html += '<div class="school-section">';
        html += '<div class="school-name">' + itemIndex + '. ' + prog.name + '</div>';
        html += '<div class="school-location">' + school.name + '</div>';
        html += '<div class="section-divider"></div>';

        html += '<div class="stats-row">';
        html += '<div class="stat-item"><div class="stat-label">Degree</div><div class="stat-value">' + prog.degreeType + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Duration</div><div class="stat-value">' + prog.duration + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Format</div><div class="stat-value">' + prog.format + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Tuition</div><div class="stat-value">' + (prog.tuitionInState ? '$' + prog.tuitionInState.toLocaleString() : 'N/A') + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">GPA</div><div class="stat-value">' + (req.minGpa || 'N/A') + '/' + req.gpaScale + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">GRE</div><div class="stat-value">' + (req.greRequired || 'N/A') + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Fee</div><div class="stat-value">$' + (req.applicationFee || 'N/A') + '</div></div>';
        html += '</div>';

        html += '<div class="detail-row"><div class="detail-label">Deadline: </div><div class="detail-value">' + (req.fallDeadline || 'N/A') + (req.springDeadline ? ' | Spring: ' + req.springDeadline : '') + (req.rollingAdmissions ? ' | Rolling: Yes' : '') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Essays / SOP: </div><div class="detail-value">' + (req.essayDetails || (req.personalStatement ? 'Personal statement required' : 'Not required')) + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Letters of Rec: </div><div class="detail-value">' + (req.lorDetails || (req.lettersOfRec + ' letter(s) required')) + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Resume/CV: </div><div class="detail-value">' + (req.cvDetails || (req.resumeCv ? 'Required' : 'Not required')) + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Transcripts: </div><div class="detail-value">' + (req.transcriptDetails || req.transcripts || 'Required') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">English Proficiency: </div><div class="detail-value">' + (req.languageTestDetails || ('TOEFL: ' + (req.toeflMin || 'N/A') + ' | IELTS: ' + (req.ieltsMin || 'N/A'))) + '</div></div>';
        if (req.prerequisites) html += '<div class="detail-row"><div class="detail-label">Prerequisites: </div><div class="detail-value">' + req.prerequisites + '</div></div>';
        if (req.workExperience) html += '<div class="detail-row"><div class="detail-label">Work Experience: </div><div class="detail-value">' + req.workExperience + '</div></div>';
        if (req.notes) html += '<div class="detail-row" style="margin-top:6px; padding:6px 10px; background:#f0fdf4; border-radius:6px;"><div class="detail-label">Tip: </div><div class="detail-value">' + req.notes + '</div></div>';

        html += '</div>';
      });

      // Detailed sections for API schools
      savedApi.forEach(function(school) {
        itemIndex++;
        var name = school['school.name'] || 'Unknown';
        var city = school['school.city'] || '';
        var state = school['school.state'] || '';
        var setting = getLocaleSetting(school['school.locale']);
        var outcomes = getSchoolOutcomes(school);
        var programs = school['latest.programs.cip_4_digit'] || [];
        var gradProgs = programs.filter(function(p) { return p.credential && (p.credential.level === 5 || p.credential.level === 6); });

        html += '<div class="school-section">';
        html += '<div class="school-name">' + itemIndex + '. ' + name + '</div>';
        html += '<div class="school-location">' + city + ', ' + state + '</div>';
        html += '<div class="section-divider"></div>';

        // Rankings
        var overallRank = getOverallRanking(name);
        if (overallRank) {
          html += '<div class="rankings">';
          if (overallRank.un) html += '<span class="rank-pill rank-us">#' + overallRank.un + ' U.S. News</span>';
          if (overallRank.qs) html += '<span class="rank-pill rank-qs">#' + overallRank.qs + ' QS World</span>';
          if (overallRank.the) html += '<span class="rank-pill rank-the">#' + overallRank.the + ' THE World</span>';
          html += '</div>';
        }

        html += '<div class="stats-row">';
        html += '<div class="stat-item"><div class="stat-label">Setting</div><div class="stat-value">' + setting + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Tuition</div><div class="stat-value">' + formatTuition(school) + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Est. Living Cost</div><div class="stat-value" style="color:#0369a1;">' + formatLivingCost(state) + '</div></div>';
        html += '<div class="stat-item"><div class="stat-label">Grad Programs</div><div class="stat-value">' + gradProgs.length + '</div></div>';
        if (outcomes.earnings) html += '<div class="stat-item"><div class="stat-label">Avg Earnings (10yr)</div><div class="stat-value green">' + outcomes.earnings + '</div></div>';
        if (outcomes.gradRate) html += '<div class="stat-item"><div class="stat-label">Graduation Rate</div><div class="stat-value">' + outcomes.gradRate + '</div></div>';
        if (outcomes.retention) html += '<div class="stat-item"><div class="stat-label">Retention Rate</div><div class="stat-value">' + outcomes.retention + '</div></div>';
        html += '</div>';

        // Admission Requirements Guide
        // Department-specific admission requirements
        var pdfProgCtx = _lastSearchProgramLabel || '';
        var _pdfReqs = getSearchedProgramRequirements();
        // Also try to match based on the school's own grad programs
        if (!_pdfReqs && gradProgs.length > 0) {
          for (var gi = 0; gi < gradProgs.length && !_pdfReqs; gi++) {
            _pdfReqs = getProgramRequirements(gradProgs[gi].title);
          }
        }

        html += '<div class="section-divider"></div>';
        html += '<div class="detail-row" style="margin-bottom:8px;"><div class="detail-label" style="font-size:12px;">&#128218; ' + (_pdfReqs ? _pdfReqs.label + ' Admission Requirements' : 'Admission Requirements Guide') + '</div></div>';
        html += '<div class="admission-guide">';

        if (_pdfReqs && _pdfReqs.portfolio) {
          html += '<div class="detail-row" style="border-left:3px solid #d97706; padding-left:8px; margin-bottom:6px;"><div class="detail-label" style="color:#d97706;">&#127912; Portfolio / Creative Work: </div><div class="detail-value">' + _pdfReqs.portfolio + '</div></div>';
        }
        html += '<div class="detail-row"><div class="detail-label">GPA: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.gpa : 'Minimum 3.0/4.0 is standard; check program-specific requirements') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">GRE / Standardized Tests: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.gre : 'Many programs have made GRE optional since 2020; verify with each program') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Statement of Purpose: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.sop : 'Typically required &mdash; describe research interests, career goals, and fit with faculty') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Letters of Recommendation: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.lor : '2&ndash;3 letters typically required from academic or professional references') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Resume / CV: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.resume : 'Usually required &mdash; include academic projects, publications, and relevant experience') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">Transcripts &amp; Prerequisites: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.transcripts : 'Official transcripts from all post-secondary institutions required') + '</div></div>';
        html += '<div class="detail-row"><div class="detail-label">English Proficiency: </div><div class="detail-value">' + (_pdfReqs ? _pdfReqs.english : 'TOEFL / IELTS required for non-native speakers; minimums vary by program (common: TOEFL 80&ndash;100, IELTS 6.5&ndash;7.0)') + '</div></div>';
        if (_pdfReqs && _pdfReqs.special) {
          html += '<div class="detail-row" style="margin-top:4px; padding:6px 10px; background:#f0fdf4; border-radius:6px;"><div class="detail-label">&#128161; Important: </div><div class="detail-value">' + _pdfReqs.special + '</div></div>';
        }
        html += '</div>';

        var schoolUrl = school['school.school_url'] || '';
        var deptSearchUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + (pdfProgCtx ? ' ' + pdfProgCtx : '') + ' program department admissions');
        html += '<div class="detail-row" style="margin-top:8px;"><div class="detail-label">&#127760; ' + (pdfProgCtx || 'Graduate') + ' Department: </div><div class="detail-value"><a href="' + deptSearchUrl + '" style="color:#7c3aed;">Search ' + name + ' ' + (pdfProgCtx || 'Graduate') + ' Department &rarr;</a></div></div>';
        if (schoolUrl) {
          if (schoolUrl.indexOf('http') !== 0) schoolUrl = 'https://' + schoolUrl;
          html += '<div class="detail-row"><div class="detail-label">&#127968; Main Website: </div><div class="detail-value"><a href="' + schoolUrl + '" style="color:#7c3aed;">' + schoolUrl + '</a></div></div>';
        }

        // List graduate programs
        if (gradProgs.length > 0) {
          html += '<div class="section-divider"></div>';
          var masters = gradProgs.filter(function(p) { return p.credential && p.credential.level === 5; });
          var doctoral = gradProgs.filter(function(p) { return p.credential && p.credential.level === 6; });
          if (masters.length > 0) {
            html += '<div class="detail-row"><div class="detail-label">Master\'s Programs (' + masters.length + '):</div></div><ul class="prog-list">';
            masters.slice(0, 20).forEach(function(p) {
              var title = p.title || 'Unknown';
              var progRank = getProgramRanking(name, p.title);
              var rankStr = progRank ? ' <span style="color:#7c3aed; font-weight:700;">(#' + progRank.rank + ' in ' + progRank.field.charAt(0).toUpperCase() + progRank.field.slice(1) + ')</span>' : '';
              html += '<li>' + title + rankStr + '</li>';
            });
            if (masters.length > 20) html += '<li><em>... and ' + (masters.length - 20) + ' more</em></li>';
            html += '</ul>';
          }
          if (doctoral.length > 0) {
            html += '<div class="detail-row"><div class="detail-label">Doctoral Programs (' + doctoral.length + '):</div></div><ul class="prog-list">';
            doctoral.slice(0, 20).forEach(function(p) {
              var title = p.title || 'Unknown';
              var progRank = getProgramRanking(name, p.title);
              var rankStr = progRank ? ' <span style="color:#7c3aed; font-weight:700;">(#' + progRank.rank + ' in ' + progRank.field.charAt(0).toUpperCase() + progRank.field.slice(1) + ')</span>' : '';
              html += '<li>' + title + rankStr + '</li>';
            });
            if (doctoral.length > 20) html += '<li><em>... and ' + (doctoral.length - 20) + ' more</em></li>';
            html += '</ul>';
          }
        }

        html += '</div>';
      });

      html += '<div class="footer">AdmitKit &mdash; This information is provided as a reference. Always verify details with official admissions offices.</div>';
      html += '</body></html>';

      // Open in new window and trigger print (Save as PDF)
      var printWin = window.open('', '_blank');
      if (!printWin) {
        alert('Pop-up blocked. Please allow pop-ups for this site and try again.');
        return;
      }
      printWin.document.write(html);
      printWin.document.close();
      var _printTriggered = false;
      printWin.onload = function() { _printTriggered = true; printWin.print(); };
      // Fallback: trigger print after short delay only if onload didn't fire
      setTimeout(function() { if (!_printTriggered) { try { printWin.print(); } catch(e) {} } }, 800);
    }

    // ─── College Scorecard API ───────────────────────────────────
    const API_BASE = 'https://api.data.gov/ed/collegescorecard/v1/schools';

    // Embedded API key — no visitor setup needed
    const EMBEDDED_API_KEY = 'nXZPowS4BflHrarIqkai6nZwsp2alozNBeTCKEIX';

    function getApiKey() {
      return EMBEDDED_API_KEY;
    }

    // Convert College Scorecard locale code to human-readable setting
    function getLocaleSetting(locale) {
      if (!locale) return 'N/A';
      var code = parseInt(locale);
      if (code >= 11 && code <= 13) return 'City';
      if (code >= 21 && code <= 23) return 'Suburb';
      if (code >= 31 && code <= 33) return 'Town';
      if (code >= 41 && code <= 43) return 'Rural';
      return 'N/A';
    }

    // Format tuition as a readable string
    function formatTuition(school) {
      var inState = school['latest.cost.tuition.in_state'];
      var outState = school['latest.cost.tuition.out_of_state'];
      if (inState && outState && inState !== outState) {
        return '$' + inState.toLocaleString() + ' / $' + outState.toLocaleString();
      }
      if (outState) return '$' + outState.toLocaleString();
      if (inState) return '$' + inState.toLocaleString();
      return 'N/A';
    }

    // Format school outcome metrics from Scorecard data
    function getSchoolOutcomes(school) {
      var earnings = school['latest.earnings.10_yrs_after_entry.mean_earnings'];
      var gradRate = school['latest.completion.completion_rate_4yr_150nt'];
      var retention = school['latest.student.retention_rate.four_year.full_time'];
      var debt = school['latest.aid.median_debt.completers.overall'];
      return {
        earnings: earnings ? '$' + Math.round(earnings).toLocaleString() : null,
        earningsRaw: earnings,
        gradRate: gradRate ? (gradRate * 100).toFixed(0) + '%' : null,
        retention: retention ? (retention * 100).toFixed(0) + '%' : null,
        debt: debt ? '$' + Math.round(debt).toLocaleString() : null
      };
    }

    // ─── Living Cost Helpers ──────────────────────────────────────────────
    function getEstimatedLivingCost(stateCode) {
      if (!stateCode) return 31000;
      return STATE_LIVING_COSTS[stateCode.toUpperCase()] || 31000;
    }

    function getEstimatedTotalCost(school) {
      var stateCode = school['school.state'] || '';
      var living = getEstimatedLivingCost(stateCode);
      var tuition = school['latest.cost.tuition.out_of_state'] || school['latest.cost.tuition.in_state'] || 0;
      return tuition + living;
    }

    function formatLivingCost(stateCode) {
      var cost = getEstimatedLivingCost(stateCode);
      return '$' + cost.toLocaleString() + '/yr';
    }

    function getMitLivingWageLink(stateCode) {
      if (!stateCode) return 'https://livingwage.mit.edu/';
      var fips = STATE_FIPS[stateCode.toUpperCase()];
      return fips ? 'https://livingwage.mit.edu/states/' + fips : 'https://livingwage.mit.edu/';
    }

    // ─── Program-Level Data Extraction ────────────────────────────────────
    // Extracts earnings data from matched CIP program objects (not institution-level)
    function getProgramEarnings(matchingProgs) {
      if (!matchingProgs || matchingProgs.length === 0) return null;
      for (var i = 0; i < matchingProgs.length; i++) {
        var p = matchingProgs[i];
        if (p.earnings) {
          var e4 = p.earnings['4_yr'] ? p.earnings['4_yr'].mean_earnings : null;
          var e1 = p.earnings['1_yr'] ? p.earnings['1_yr'].mean_earnings : null;
          if (e4) return { value: '$' + Math.round(e4).toLocaleString(), label: 'Avg Salary (4yr post-grad)', raw: e4 };
          if (e1) return { value: '$' + Math.round(e1).toLocaleString(), label: 'Avg Salary (1yr post-grad)', raw: e1 };
        }
      }
      return null;
    }

    function getProgramDebt(matchingProgs) {
      if (!matchingProgs || matchingProgs.length === 0) return null;
      for (var i = 0; i < matchingProgs.length; i++) {
        var p = matchingProgs[i];
        if (p.debt && p.debt.median_debt) {
          return { value: '$' + Math.round(p.debt.median_debt).toLocaleString(), raw: p.debt.median_debt };
        }
      }
      return null;
    }

    function getCredentialBadge(degreeLevel) {
      if (degreeLevel === 5) return '<span style="display:inline-block; font-size:0.65rem; padding:1px 7px; background:#7c3aed; color:#fff; border-radius:8px; font-weight:600; vertical-align:middle;">Master&#39;s</span>';
      if (degreeLevel === 6 || degreeLevel === 7 || degreeLevel === 8) return '<span style="display:inline-block; font-size:0.65rem; padding:1px 7px; background:#b45309; color:#fff; border-radius:8px; font-weight:600; vertical-align:middle;">Doctoral</span>';
      return '';
    }

    // ─── Program-Specific Admission Requirements ─────────────────────────
    // Maps program fields to their typical department-specific requirements
    var PROGRAM_REQUIREMENTS = {
      'architecture': {
        label: 'Architecture',
        portfolio: 'Design portfolio required (typically 15-25 pages of design work, sketches, models, and built projects)',
        gpa: '3.0/4.0 minimum; design coursework GPA weighted heavily',
        gre: 'Often optional or not required; check individual programs',
        sop: 'Statement describing design philosophy, research interests, and career goals in architecture',
        lor: '3 letters required, preferably from design professors or professional architects/mentors',
        resume: 'Required — highlight design experience, internships, competitions, and software skills (AutoCAD, Revit, Rhino, SketchUp)',
        transcripts: 'Official transcripts required; prerequisite coursework in design studio, structures, and building technology may be required',
        english: 'TOEFL 90-100 / IELTS 7.0 typical for international applicants',
        special: 'Portfolio is the most critical component. Some programs require a bachelor\'s in architecture (B.Arch) or related field. Non-architecture backgrounds may need to complete a 3-year M.Arch instead of 2-year.',
        keywords: ['architecture', 'architectural', 'urban design', 'landscape architecture', 'building science', 'interior architecture']
      },
      'fine_arts': {
        label: 'Fine Arts / MFA',
        portfolio: 'Portfolio required (15-20 works showing range and depth; digital submissions via SlideRoom common)',
        gpa: '3.0/4.0 typical minimum; portfolio quality outweighs GPA',
        gre: 'Generally not required for MFA programs',
        sop: 'Artist statement and statement of purpose describing creative practice, influences, and goals',
        lor: '3 letters from art professors, mentors, or professional artists who know your creative work',
        resume: 'CV/resume with exhibition history, publications, residencies, awards, and relevant experience',
        transcripts: 'Official transcripts required; BFA or equivalent studio art background typically expected',
        english: 'TOEFL 80-100 / IELTS 6.5-7.0 for international applicants',
        special: 'Portfolio is the primary admissions criterion. Many programs require an interview or studio visit. Some specializations (sculpture, painting, printmaking) may have additional requirements.',
        keywords: ['fine art', 'studio art', 'painting', 'sculpture', 'printmaking', 'ceramics', 'photography', 'art practice', 'visual art', 'mfa']
      },
      'design': {
        label: 'Design (UX, Graphic, Industrial)',
        portfolio: 'Design portfolio required (10-20 projects showing process, research, and final deliverables; case studies preferred for UX)',
        gpa: '3.0/4.0 minimum; design project work weighted heavily',
        gre: 'Usually not required for design programs',
        sop: 'Statement describing design approach, research interests, and how the program fits career goals',
        lor: '2-3 letters from design professors, industry mentors, or employers who can speak to design ability',
        resume: 'Required — highlight design projects, tools proficiency (Figma, Sketch, Adobe Creative Suite), research methods, and internships',
        transcripts: 'Official transcripts required; relevant coursework in design, HCI, or related fields valued',
        english: 'TOEFL 90-100 / IELTS 7.0 for international applicants',
        special: 'Portfolio quality is the deciding factor. UX programs value case studies with user research and testing. Industrial design programs may request physical prototypes or 3D models.',
        keywords: ['ux design', 'user experience', 'interaction design', 'graphic design', 'industrial design', 'product design', 'communication design', 'visual design', 'hci', 'human-computer', 'digital media design', 'interface design']
      },
      'film': {
        label: 'Film / Cinema / Animation',
        portfolio: 'Creative portfolio or demo reel required (short films, animations, or screenwriting samples; typically 10-15 minutes total)',
        gpa: '3.0/4.0 minimum; creative work portfolio more important than GPA',
        gre: 'Generally not required',
        sop: 'Statement of purpose describing creative vision, influences, and goals in filmmaking or animation',
        lor: '3 letters from professors, industry professionals, or collaborators familiar with your creative work',
        resume: 'CV highlighting productions, crew roles, festivals, screenings, and technical skills',
        transcripts: 'Official transcripts required',
        english: 'TOEFL 80-100 / IELTS 6.5-7.0 for international applicants',
        special: 'Some programs focus on specific areas (directing, producing, screenwriting, cinematography, animation). Screenwriting applicants typically submit writing samples instead of reels.',
        keywords: ['film', 'cinema', 'animation', 'filmmaking', 'screenwriting', 'cinematography', 'motion picture', 'video production', 'digital animation', 'visual effects']
      },
      'music': {
        label: 'Music',
        portfolio: 'Audition required (live or recorded performance; pre-screening recordings often required before live audition)',
        gpa: '3.0/4.0 minimum; audition performance is the primary criterion',
        gre: 'Generally not required for performance programs; may be required for musicology/theory',
        sop: 'Statement describing musical background, performance goals, and reasons for choosing the program',
        lor: '3 letters from music instructors, ensemble directors, or professional musicians',
        resume: 'Musical CV with performance history, repertoire, competitions, awards, and teaching experience',
        transcripts: 'Official transcripts required; music theory and history prerequisites common',
        english: 'TOEFL 79-90 / IELTS 6.5 for international applicants',
        special: 'Audition is the most critical component. Repertoire requirements vary by instrument/voice type. Composition applicants submit scores. Conducting applicants may need a video.',
        keywords: ['music', 'music performance', 'music composition', 'music education', 'conducting', 'musicology', 'music theory', 'jazz', 'vocal', 'opera']
      },
      'theater': {
        label: 'Theater / Drama',
        portfolio: 'Audition required for acting/directing; portfolio for design specializations (scenic, costume, lighting)',
        gpa: '3.0/4.0 minimum; audition/portfolio performance is primary',
        gre: 'Generally not required',
        sop: 'Statement describing artistic vision, theatrical influences, and career goals',
        lor: '3 letters from theater professors, directors, or professional collaborators',
        resume: 'Performance/design CV with production credits, roles, and relevant training',
        transcripts: 'Official transcripts required',
        english: 'TOEFL 80-100 / IELTS 6.5-7.0 for international applicants',
        special: 'Acting programs typically require 2 contrasting monologues. Design/tech programs require a portfolio of production work. Playwriting programs require writing samples.',
        keywords: ['theater', 'theatre', 'drama', 'acting', 'directing', 'scenic design', 'costume design', 'stage', 'playwriting', 'performance studies']
      },
      'creative_writing': {
        label: 'Creative Writing',
        portfolio: 'Writing sample required (typically 20-30 pages of fiction, poetry collection of 8-12 poems, or creative nonfiction)',
        gpa: '3.0/4.0 minimum; writing sample quality is the primary criterion',
        gre: 'Generally not required for MFA programs; may be required for PhD programs',
        sop: 'Statement of purpose describing writing background, influences, aesthetic goals, and why this program',
        lor: '3 letters, ideally from writing workshop instructors or published authors who know your work',
        resume: 'CV with publications, readings, workshops, residencies, and relevant experience',
        transcripts: 'Official transcripts required; undergraduate creative writing coursework valued',
        english: 'TOEFL 100+ / IELTS 7.0+ typical (higher bar given writing-intensive nature)',
        special: 'Writing sample is the most important part of the application. Programs are genre-specific (fiction, poetry, nonfiction). Many top programs are fully funded. Low acceptance rates (3-8% at top programs).',
        keywords: ['creative writing', 'fiction', 'poetry', 'nonfiction', 'literary arts', 'mfa writing']
      },
      'dance': {
        label: 'Dance',
        portfolio: 'Audition required (live audition class and/or video submission of solo and ensemble work)',
        gpa: '3.0/4.0 minimum; audition is the primary criterion',
        gre: 'Not required',
        sop: 'Statement describing dance training, artistic goals, and research interests',
        lor: '3 letters from dance instructors, choreographers, or artistic directors',
        resume: 'Dance CV with performance credits, training history, choreographic work, and teaching experience',
        transcripts: 'Official transcripts required',
        english: 'TOEFL 80 / IELTS 6.5 for international applicants',
        special: 'Audition is critical. Video submissions should show technique, artistry, and range. Choreography MFA may require examples of original work.',
        keywords: ['dance', 'choreography', 'dance performance', 'ballet', 'modern dance', 'contemporary dance']
      },
      'business': {
        label: 'Business / MBA',
        portfolio: null,
        gpa: '3.0/4.0 minimum; top programs average 3.5+',
        gre: 'GMAT or GRE accepted; many programs now test-optional. Top MBA programs: GMAT 680-730 average',
        sop: 'Personal essays on leadership, career goals, and why this MBA program (usually 2-3 essays with specific prompts)',
        lor: '2 letters required, typically from direct supervisors or managers who can assess professional impact',
        resume: 'Required — focus on career progression, leadership, quantifiable achievements, and impact',
        transcripts: 'Official transcripts required from all undergraduate and graduate institutions',
        english: 'TOEFL 100+ / IELTS 7.0+ for international applicants',
        special: '2-5 years of work experience typically required (average 5 years at top programs). Interview often required and may be by invitation only. Some programs value diverse industry backgrounds.',
        keywords: ['business', 'mba', 'management', 'finance', 'marketing', 'accounting', 'business analytics', 'entrepreneurship', 'supply chain']
      },
      'law': {
        label: 'Law / JD',
        portfolio: null,
        gpa: 'No minimum but highly competitive; median GPAs at top schools: 3.7-3.9',
        gre: 'LSAT required (most schools); some accept GRE. LSAT is the most important factor alongside GPA',
        sop: 'Personal statement (2-3 pages) plus optional diversity statement and addenda',
        lor: '2-3 letters from academic professors who can speak to analytical and writing abilities',
        resume: 'Required — include academic achievements, leadership, community service, and work experience',
        transcripts: 'Processed through LSAC CAS (Credential Assembly Service); all transcripts required',
        english: 'TOEFL 100+ / IELTS 7.0+ for international applicants; some schools require higher',
        special: 'LSAT score and GPA are the two most influential factors. Apply early (September-November) for best chances. Work experience valued but not required for JD programs.',
        keywords: ['law', 'legal', 'jd', 'juris doctor', 'llm', 'legal studies']
      },
      'medicine': {
        label: 'Medicine / MD',
        portfolio: null,
        gpa: 'Competitive; median GPA at medical schools is 3.7+; both science and overall GPA evaluated',
        gre: 'MCAT required (no GRE). Competitive score: 510+ (average at top schools: 518-522)',
        sop: 'Personal statement through AMCAS/AACOMAS plus secondary essays from each school',
        lor: '3-5 letters: at least 2 science faculty, 1 non-science, plus clinical/research mentors recommended',
        resume: 'Activities section in AMCAS: clinical experience, research, volunteering, leadership (tracked in hours)',
        transcripts: 'Processed through AMCAS/AACOMAS verification; all transcripts required',
        english: 'TOEFL required for international applicants; some schools require US/Canadian undergraduate degree',
        special: 'Clinical experience (shadowing, volunteering) is essential. Research experience strongly valued. Many schools require CASPer or other situational judgment tests. Interview (MMI or traditional) required.',
        keywords: ['medicine', 'medical', 'md', 'pre-med', 'biomedical science']
      },
      'nursing': {
        label: 'Nursing',
        portfolio: null,
        gpa: '3.0/4.0 minimum; nursing/science GPA weighted; top programs average 3.5+',
        gre: 'Often required (varies by program); some DNP programs waive for experienced nurses',
        sop: 'Statement of purpose describing clinical interests, leadership goals, and specialty focus',
        lor: '3 letters from nursing faculty, clinical supervisors, or nurse managers',
        resume: 'Required — include RN license, clinical experience, certifications (CCRN, CEN, etc.), and specializations',
        transcripts: 'Official transcripts required; prerequisite courses in anatomy, physiology, statistics, and pathophysiology',
        english: 'TOEFL 83-100 / IELTS 6.5-7.0 for international applicants',
        special: 'Active RN license required for most MSN/DNP programs. Clinical hours requirements vary. NP programs require specific clinical rotation hours. Some programs require current clinical employment.',
        keywords: ['nursing', 'nurse practitioner', 'dnp', 'msn', 'nurse', 'clinical nursing', 'nurse anesthesia', 'midwifery']
      },
      'public_health': {
        label: 'Public Health / MPH',
        portfolio: null,
        gpa: '3.0/4.0 minimum; quantitative coursework (statistics, epidemiology) valued',
        gre: 'Many MPH programs have waived GRE; some still require for PhD/DrPH programs',
        sop: 'Statement of purpose describing public health interests, relevant experience, and career goals in specific concentration area',
        lor: '3 letters from academic or professional references with knowledge of your public health or research experience',
        resume: 'Required — highlight health-related experience, research, community health work, and data analysis skills',
        transcripts: 'Official transcripts required; coursework in biology, statistics, and social sciences valued',
        english: 'TOEFL 90-100 / IELTS 7.0 for international applicants',
        special: 'Field experience or internship in health settings strongly valued. SOPHAS centralized application used by most programs. Choose concentration area before applying (epidemiology, biostatistics, health policy, global health, etc.).',
        keywords: ['public health', 'mph', 'epidemiology', 'biostatistics', 'health policy', 'global health', 'environmental health', 'health promotion']
      },
      'education': {
        label: 'Education',
        portfolio: 'Teaching portfolio may be required (lesson plans, teaching videos, student work samples)',
        gpa: '3.0/4.0 minimum for most programs',
        gre: 'Often waived for experienced teachers; may be required for research-focused programs',
        sop: 'Statement describing teaching philosophy, educational goals, and how the program advances your career',
        lor: '2-3 letters from principals, colleagues, professors, or supervisors who can speak to teaching ability',
        resume: 'Required — include teaching experience, certifications, curriculum development, and professional development',
        transcripts: 'Official transcripts required; teaching licensure prerequisites may apply',
        english: 'TOEFL 80-100 / IELTS 6.5-7.0 for international applicants',
        special: 'Teaching experience often required or strongly preferred. State licensure requirements vary. Some programs include student teaching. EdD vs PhD: EdD is practice-focused, PhD is research-focused.',
        keywords: ['education', 'teaching', 'curriculum', 'educational leadership', 'educational technology', 'special education', 'tesol', 'literacy', 'counseling education', 'higher education']
      },
      'engineering': {
        label: 'Engineering',
        portfolio: null,
        gpa: '3.0/4.0 minimum; 3.3+ for competitive programs; math and engineering GPA emphasized',
        gre: 'Many programs now GRE-optional; competitive scores: V155+ Q165+ when required',
        sop: 'Research statement describing technical interests, prior research experience, and faculty you want to work with',
        lor: '3 letters from engineering/science professors or research supervisors who can assess technical ability',
        resume: 'Required — include research, projects, publications, technical skills, and relevant internships',
        transcripts: 'Official transcripts required; prerequisite math (calculus, linear algebra, differential equations) and core engineering courses required',
        english: 'TOEFL 90-100 / IELTS 6.5-7.0 for international applicants',
        special: 'Research fit with faculty is critical for PhD admissions. Prior research experience highly valued. MS programs may be thesis or non-thesis track. Funding often available for PhD students.',
        keywords: ['engineering', 'electrical', 'mechanical', 'civil', 'chemical', 'biomedical', 'aerospace', 'industrial', 'materials', 'environmental engineering', 'computer engineering', 'systems engineering', 'structural']
      },
      'computer_science': {
        label: 'Computer Science',
        portfolio: null,
        gpa: '3.0/4.0 minimum; 3.5+ for top programs; CS and math GPA emphasized',
        gre: 'Increasingly optional; many top CS programs no longer require GRE',
        sop: 'Research statement describing technical interests, projects, prior research, and faculty alignment',
        lor: '3 letters from CS professors or research/industry supervisors who can assess technical ability',
        resume: 'Required — include research, publications, projects (with GitHub links), technical skills, and internships',
        transcripts: 'Official transcripts required; strong foundation in algorithms, data structures, math (calculus, linear algebra, probability) required',
        english: 'TOEFL 90-100 / IELTS 7.0 for international applicants',
        special: 'Research fit with specific faculty is the most important factor for PhD. Industry experience valued for MS. Strong programming skills expected. Publications or significant projects help PhD applications.',
        keywords: ['computer science', 'computing', 'software engineering', 'artificial intelligence', 'machine learning', 'data science', 'cybersecurity', 'information technology', 'algorithms', 'computer engineering']
      },
      'psychology': {
        label: 'Psychology',
        portfolio: null,
        gpa: '3.0/4.0 minimum; 3.5+ for clinical psychology (extremely competitive)',
        gre: 'Many programs GRE-optional; clinical psychology programs may still require it',
        sop: 'Research statement describing specific research interests, methodological experience, and faculty fit',
        lor: '3 letters from psychology professors or research supervisors; clinical programs want clinical supervisors too',
        resume: 'CV with research experience, publications, presentations, clinical hours (for clinical programs), and relevant experience',
        transcripts: 'Official transcripts required; prerequisite courses in statistics, research methods, and core psychology areas',
        english: 'TOEFL 90-100 / IELTS 7.0 for international applicants',
        special: 'Clinical psychology PhD acceptance rates are extremely low (2-10%). Research experience is essential for PhD. Match with faculty research interests is critical. Clinical programs require clinical hours. PsyD programs are practice-focused with higher acceptance rates.',
        keywords: ['psychology', 'clinical psychology', 'counseling psychology', 'cognitive', 'behavioral', 'developmental psychology', 'social psychology', 'neuropsychology', 'organizational psychology']
      },
      'social_work': {
        label: 'Social Work / MSW',
        portfolio: null,
        gpa: '3.0/4.0 minimum for most programs',
        gre: 'Most MSW programs do not require GRE',
        sop: 'Personal statement describing commitment to social justice, relevant experience, and career goals in social work',
        lor: '3 letters from professors, field supervisors, or employers in human services who can assess your potential',
        resume: 'Required — highlight social services experience, volunteer work, community involvement, and advocacy',
        transcripts: 'Official transcripts required; liberal arts prerequisites typically expected',
        english: 'TOEFL 80-90 / IELTS 6.5 for international applicants',
        special: 'Field experience in human services strongly valued. BSW holders may qualify for Advanced Standing (complete MSW in 1 year). Field placement is a major component (900+ hours). Choose concentration: clinical, community, policy, etc.',
        keywords: ['social work', 'msw', 'clinical social work', 'community practice', 'human services']
      },
      'public_policy': {
        label: 'Public Policy / Public Administration',
        portfolio: null,
        gpa: '3.0/4.0 minimum; quantitative skills valued',
        gre: 'Required by many programs; some waive for experienced professionals',
        sop: 'Policy statement describing policy interests, relevant experience, and career goals in public service',
        lor: '2-3 letters from professors or professional supervisors in government, nonprofit, or policy roles',
        resume: 'Required — highlight policy experience, government service, nonprofit work, and analytical skills',
        transcripts: 'Official transcripts required; coursework in economics, statistics, and political science valued',
        english: 'TOEFL 100+ / IELTS 7.0 for international applicants',
        special: 'Work experience valued (average 2-5 years at top programs). MPA focuses on management/administration, MPP on policy analysis. Many programs offer joint degrees (JD/MPA, MBA/MPP).',
        keywords: ['public policy', 'public administration', 'mpa', 'mpp', 'government', 'public affairs', 'nonprofit management', 'urban policy']
      }
    };

    // Look up department-specific requirements based on program title
    function getProgramRequirements(programTitle) {
      if (!programTitle) return null;
      var title = programTitle.toLowerCase();
      for (var key in PROGRAM_REQUIREMENTS) {
        var req = PROGRAM_REQUIREMENTS[key];
        for (var i = 0; i < req.keywords.length; i++) {
          if (title.indexOf(req.keywords[i]) >= 0) return req;
        }
      }
      return null;
    }

    // Get requirements for the searched program field
    function getSearchedProgramRequirements() {
      var label = _lastSearchProgramLabel || '';
      if (!label) return null;
      return getProgramRequirements(label);
    }

    // BLS Occupational Outlook links by program field
    var BLS_LINKS = {
      'business': { title: 'Business & Management', url: 'https://www.bls.gov/ooh/management/home.htm' },
      'computer science': { title: 'Computer & IT', url: 'https://www.bls.gov/ooh/computer-and-information-technology/home.htm' },
      'engineering': { title: 'Engineering', url: 'https://www.bls.gov/ooh/architecture-and-engineering/home.htm' },
      'psychology': { title: 'Psychology', url: 'https://www.bls.gov/ooh/life-physical-and-social-science/psychologists.htm' },
      'education': { title: 'Education', url: 'https://www.bls.gov/ooh/education-training-and-library/home.htm' },
      'law': { title: 'Legal', url: 'https://www.bls.gov/ooh/legal/home.htm' },
      'medicine': { title: 'Healthcare', url: 'https://www.bls.gov/ooh/healthcare/home.htm' },
      'public health': { title: 'Health Educators', url: 'https://www.bls.gov/ooh/community-and-social-service/health-educators.htm' },
      'data science': { title: 'Data Scientists', url: 'https://www.bls.gov/ooh/math/data-scientists.htm' },
      'economics': { title: 'Economists', url: 'https://www.bls.gov/ooh/life-physical-and-social-science/economists.htm' },
      'nursing': { title: 'Registered Nurses', url: 'https://www.bls.gov/ooh/healthcare/registered-nurses.htm' },
      'social work': { title: 'Social Workers', url: 'https://www.bls.gov/ooh/community-and-social-service/social-workers.htm' },
      'fine arts': { title: 'Art & Design', url: 'https://www.bls.gov/ooh/arts-and-design/home.htm' },
      'public affairs': { title: 'Public Administration', url: 'https://www.bls.gov/ooh/management/administrative-services-managers.htm' },
      'architecture': { title: 'Architects', url: 'https://www.bls.gov/ooh/architecture-and-engineering/architects.htm' },
      'biology': { title: 'Biological Scientists', url: 'https://www.bls.gov/ooh/life-physical-and-social-science/biochemists-and-biophysicists.htm' },
      'chemistry': { title: 'Chemists', url: 'https://www.bls.gov/ooh/life-physical-and-social-science/chemists-and-materials-scientists.htm' },
      'physics': { title: 'Physicists', url: 'https://www.bls.gov/ooh/life-physical-and-social-science/physicists-and-astronomers.htm' },
      'mathematics': { title: 'Mathematicians', url: 'https://www.bls.gov/ooh/math/mathematicians-and-statisticians.htm' },
      'environmental science': { title: 'Environmental Scientists', url: 'https://www.bls.gov/ooh/life-physical-and-social-science/environmental-scientists-and-specialists.htm' },
      'communications': { title: 'Media & Communication', url: 'https://www.bls.gov/ooh/media-and-communication/home.htm' },
      'library science': { title: 'Librarians', url: 'https://www.bls.gov/ooh/education-training-and-library/librarians-and-library-media-specialists.htm' }
    };

    // Get BLS link for a program title
    function getBLSLink(programTitle) {
      if (!programTitle) return null;
      var lower = programTitle.toLowerCase();
      for (var key in BLS_LINKS) {
        if (lower.indexOf(key) >= 0 || key.indexOf(lower) >= 0) return BLS_LINKS[key];
      }
      // Broader keyword matching
      if (lower.match(/business|mba|management|finance|marketing|accounting/)) return BLS_LINKS['business'];
      if (lower.match(/comput|software|cyber|information tech|IT /)) return BLS_LINKS['computer science'];
      if (lower.match(/engineer|mechanical|electrical|civil|chemical|aerospace|biomedical/)) return BLS_LINKS['engineering'];
      if (lower.match(/psych|cognitive|behavioral|counseling/)) return BLS_LINKS['psychology'];
      if (lower.match(/educ|teach|curriculum|instruction/)) return BLS_LINKS['education'];
      if (lower.match(/law|legal|juris/)) return BLS_LINKS['law'];
      if (lower.match(/medic|physician|surgery|clinical/)) return BLS_LINKS['medicine'];
      if (lower.match(/health|epidemiol|biostat/)) return BLS_LINKS['public health'];
      if (lower.match(/data|statistic|analytics/)) return BLS_LINKS['data science'];
      if (lower.match(/econom/)) return BLS_LINKS['economics'];
      if (lower.match(/nurs/)) return BLS_LINKS['nursing'];
      if (lower.match(/social work|msw/)) return BLS_LINKS['social work'];
      if (lower.match(/art|design|studio|creative/)) return BLS_LINKS['fine arts'];
      if (lower.match(/public (admin|policy|affairs)|government/)) return BLS_LINKS['public affairs'];
      if (lower.match(/architect/)) return BLS_LINKS['architecture'];
      if (lower.match(/biolog|biotech|genetics|neurosci/)) return BLS_LINKS['biology'];
      if (lower.match(/chemi|materials sci/)) return BLS_LINKS['chemistry'];
      if (lower.match(/physic|astronom/)) return BLS_LINKS['physics'];
      if (lower.match(/math|applied math/)) return BLS_LINKS['mathematics'];
      if (lower.match(/environ/)) return BLS_LINKS['environmental science'];
      if (lower.match(/communicat|journal|media/)) return BLS_LINKS['communications'];
      if (lower.match(/librar/)) return BLS_LINKS['library science'];
      return null;
    }

    // Build compact ranking links for cards
    function buildRankingLinks(schoolName) {
      var enc = encodeURIComponent(schoolName);
      return '<div style="display:flex; gap:6px; margin:6px 0 2px; flex-wrap:wrap;" onclick="event.stopPropagation();">' +
        '<a href="https://www.usnews.com/best-graduate-schools/search?name=' + enc + '" target="_blank" style="font-size:0.68rem; padding:2px 7px; background:#1a365d; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">U.S. News</a>' +
        '<a href="https://www.topuniversities.com/universities?q=' + enc + '" target="_blank" style="font-size:0.68rem; padding:2px 7px; background:#0070c0; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">QS</a>' +
        '<a href="https://www.timeshighereducation.com/world-university-rankings?search=' + enc + '" target="_blank" style="font-size:0.68rem; padding:2px 7px; background:#9b2335; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">THE</a>' +
      '</div>';
    }

    async function searchSchoolsAPI() {
      const query = document.getElementById('explore-query').value.trim();
      const key = getApiKey();
      const container = document.getElementById('explore-results');

      if (!key) {
        container.innerHTML = '<div class="api-error">API key not configured. Please contact the site administrator.</div>';
        return;
      }
      if (!query) {
        container.innerHTML = '<div class="api-error">Please enter a school name to search.</div>';
        return;
      }

      container.innerHTML = '<div class="api-loading"><div class="spinner"></div><p>Searching schools...</p></div>';

      // Extract school name from mixed queries
      const schoolName = extractSchoolName(query);

      try {
        const fields = [
          'school.name', 'school.city', 'school.state',
          'school.school_url', 'school.ownership',
          'school.locale',
          'latest.cost.tuition.in_state',
          'latest.cost.tuition.out_of_state',
          'latest.cost.avg_net_price.overall',
          'latest.earnings.10_yrs_after_entry.mean_earnings',
          'latest.completion.completion_rate_4yr_150nt',
          'latest.student.retention_rate.four_year.full_time',
          'latest.aid.median_debt.completers.overall',
          'latest.admissions.admission_rate.overall',
          'latest.programs.cip_4_digit'
        ].join(',');

        const url = `${API_BASE}?school.name=${encodeURIComponent(schoolName)}&fields=${fields}&per_page=12&api_key=${key}`;

        const res = await fetch(url);
        if (!res.ok) {
          if (res.status === 403) throw new Error('Invalid API key. Please check your key and try again.');
          throw new Error(`API returned status ${res.status}`);
        }

        const data = await res.json();
        var results = sortByRelevance(data.results || [], schoolName);

        _lastSearchContext = { type: 'school', args: [schoolName] };
        showSortDropdown();
        if (_currentSortMode !== 'relevance') {
          results = applySortToResults(results, _currentSortMode);
        }

        // Apply region and ranking filters (client-side post-filter)
        if (_activeRegionFilter) {
          results = results.filter(function(s) { return stateMatchesRegionFilter(s['school.state']); });
        }
        if (_activeRankingFilter) {
          results = results.filter(function(s) { return schoolMatchesRankingFilter(s['school.name'] || ''); });
        }

        if (results.length === 0) {
          container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">&#128269;</div><p>No schools found. Try a different name or adjust your filters.</p></div>';
          return;
        }

        container.innerHTML = results.map((school, idx) => {
          // Cache the result for modal access
          const cacheKey = 'exp_' + idx;
          _apiResultsCache[cacheKey] = school;

          const name = school['school.name'] || 'Unknown';
          const city = school['school.city'] || '';
          const state = school['school.state'] || '';
          const url = school['school.school_url'] || '#';
          const fullUrl = url.startsWith('http') ? url : 'https://' + url;
          const ownership = school['school.ownership'];
          const setting = getLocaleSetting(school['school.locale']);
          const tuitionStr = formatTuition(school);
          const outcomes = getSchoolOutcomes(school);
          const programs = school['latest.programs.cip_4_digit'] || [];
          const gradPrograms = programs.filter(p => p.credential && (p.credential.level === 5 || p.credential.level === 6));
          const gradCount = gradPrograms.length;

          const firstGradProg = gradPrograms.length > 0 ? gradPrograms[0] : null;
          let expProgLabel, expProgUrl;
          if (firstGradProg && firstGradProg.title) {
            expProgLabel = 'Find ' + firstGradProg.title + ' program page';
            expProgUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + firstGradProg.title + ' admissions program');
          } else {
            expProgLabel = 'Find graduate admissions page';
            expProgUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' graduate admissions programs');
          }

          return `
            <div class="school-card" onclick="openApiModal('${cacheKey}')" style="cursor:pointer;">
              <div class="school-card-name">${name}</div>
              <div class="school-card-location">${city}, ${state}</div>
              <div class="school-stats">
                <div class="school-stat">
                  <div class="school-stat-label">Setting</div>
                  <div class="school-stat-value">${setting}</div>
                </div>
                <div class="school-stat">
                  <div class="school-stat-label">Tuition</div>
                  <div class="school-stat-value">${tuitionStr}</div>
                </div>
                <div class="school-stat">
                  <div class="school-stat-label">Est. Living Cost</div>
                  <div class="school-stat-value" style="color:#0369a1;">${formatLivingCost(state)}</div>
                </div>
                <div class="school-stat">
                  <div class="school-stat-label">Grad Programs</div>
                  <div class="school-stat-value">${gradCount}</div>
                </div>
                ${outcomes.earnings ? `<div class="school-stat">
                  <div class="school-stat-label">Avg Salary (10yr)</div>
                  <div class="school-stat-value" style="color:#059669;">${outcomes.earnings}</div>
                </div>` : ''}
              </div>
              ${buildRankingDisplay(name, null)}
              <a href="${expProgUrl}" target="_blank" onclick="event.stopPropagation();" class="school-card-link" style="cursor:pointer; color:var(--accent); text-decoration:none;">${expProgLabel} &rarr;</a>
            </div>`;
        }).join('');

      } catch (err) {
        container.innerHTML = `<div class="api-error">${err.message}</div>`;
      }
    }
    // ─── Main Page API Fallback Search ───────────────────────────────────
    // Common school abbreviation/nickname map
    var SCHOOL_ALIASES = {
      'mit': 'Massachusetts Institute of Technology',
      'nyu': 'New York University',
      'usc': 'University of Southern California',
      'cmu': 'Carnegie Mellon University',
      'caltech': 'California Institute of Technology',
      'cal tech': 'California Institute of Technology',
      'gt': 'Georgia Institute of Technology',
      'gatech': 'Georgia Institute of Technology',
      'georgia tech': 'Georgia Institute of Technology',
      'ucla': 'University of California-Los Angeles',
      'ucsd': 'University of California-San Diego',
      'uc san diego': 'University of California-San Diego',
      'ucd': 'University of California-Davis',
      'uc davis': 'University of California-Davis',
      'ucb': 'University of California-Berkeley',
      'uc berkeley': 'University of California-Berkeley',
      'uci': 'University of California-Irvine',
      'uc irvine': 'University of California-Irvine',
      'ucsb': 'University of California-Santa Barbara',
      'uc santa barbara': 'University of California-Santa Barbara',
      'upenn': 'University of Pennsylvania',
      'u penn': 'University of Pennsylvania',
      'penn': 'University of Pennsylvania',
      'penn state': 'Pennsylvania State University',
      'ohio state': 'Ohio State University',
      'osu': 'Ohio State University',
      'umich': 'University of Michigan',
      'u of m': 'University of Michigan',
      'ut austin': 'University of Texas at Austin',
      'uiuc': 'University of Illinois Urbana-Champaign',
      'uw': 'University of Washington',
      'uva': 'University of Virginia',
      'unc': 'University of North Carolina',
      'uf': 'University of Florida',
      'uga': 'University of Georgia',
      'bu': 'Boston University',
      'bc': 'Boston College',
      'northeastern': 'Northeastern University',
      'northwestern': 'Northwestern University',
      'wustl': 'Washington University in St Louis',
      'wash u': 'Washington University in St Louis',
      'jhu': 'Johns Hopkins University',
      'johns hopkins': 'Johns Hopkins University',
      'tamu': 'Texas A & M University',
      'texas a&m': 'Texas A & M University',
      'texas am': 'Texas A & M University',
      'vt': 'Virginia Tech',
      'virginia tech': 'Virginia Polytechnic Institute',
      'rpi': 'Rensselaer Polytechnic Institute',
      'wpi': 'Worcester Polytechnic Institute',
      'cu boulder': 'University of Colorado Boulder',
      'uconn': 'University of Connecticut',
      'smu': 'Southern Methodist University',
      'gwu': 'George Washington University',
      'gw': 'George Washington University',
      'msu': 'Michigan State University',
      'isu': 'Iowa State University',
      'psu': 'Pennsylvania State University',
      'asu': 'Arizona State University',
      'umd': 'University of Maryland',
      'rutgers': 'Rutgers University',
      'purdue': 'Purdue University',
      'duke': 'Duke University',
      'rice': 'Rice University',
      'emory': 'Emory University',
      'tulane': 'Tulane University',
      'vanderbilt': 'Vanderbilt University',
      'yale': 'Yale University',
      'harvard': 'Harvard University',
      'stanford': 'Stanford University',
      'princeton': 'Princeton University',
      'cornell': 'Cornell University',
      'brown': 'Brown University',
      'dartmouth': 'Dartmouth College',
      'columbia': 'Columbia University in the City of New York',
      'georgetown': 'Georgetown University',
      'notre dame': 'University of Notre Dame',
      'nyu stern': 'New York University',
      'mit sloan': 'Massachusetts Institute of Technology',
      'wharton': 'University of Pennsylvania',
      'booth': 'University of Chicago',
      'kellogg': 'Northwestern University',
      'ross': 'University of Michigan',
      'haas': 'University of California-Berkeley',
      'fuqua': 'Duke University',
      'tuck': 'Dartmouth College',
      'anderson': 'University of California-Los Angeles',
      'marshall': 'University of Southern California',
      'tepper': 'Carnegie Mellon University'
    };

    // ─── University Rankings Data (2025-2026) ──────────────────────────────
    // Sources: U.S. News (un), QS World (qs), Times Higher Education (the)
    // Updated annually. Numbers are global rankings for QS/THE, national for U.S. News.
    // Key = normalized school name (lowercase, no "-Main Campus" etc.)
    function normalizeForRanking(name) {
      return name.toLowerCase()
        .replace(/-main campus/gi, '').replace(/-all campuses/gi, '')
        .replace(/-college station/gi, '').replace(/-ann arbor/gi, '')
        .replace(/-bloomington/gi, '').replace(/-twin cities/gi, '')
        .replace(/-new brunswick/gi, '').replace(/-park/gi, '')
        .replace(/-chapel hill/gi, '').replace(/-madison/gi, '')
        .replace(/-austin/gi, '').replace(/-seattle/gi, '')
        .replace(/-amherst/gi, '').replace(/-columbus/gi, '')
        .replace(/-urbana/gi, '').replace(/-champaign/gi, '')
        .replace(/-/g, ' ').replace(/\s+/g, ' ').trim();
    }

    var RANKINGS_DATA = {
      "princeton university": { un: 1, qs: 25, the: 3 },
      "massachusetts institute of technology": { un: 2, qs: 1, the: 2 },
      "harvard university": { un: 3, qs: 5, the: 5 },
      "stanford university": { un: 4, qs: 3, the: 5 },
      "yale university": { un: 4, qs: 21, the: 10 },
      "university of chicago": { un: 6, qs: 13, the: 15 },
      "duke university": { un: 7, qs: 62, the: 28 },
      "johns hopkins university": { un: 7, qs: 24, the: 16 },
      "northwestern university": { un: 7, qs: 42, the: 31 },
      "university of pennsylvania": { un: 7, qs: 15, the: 14 },
      "california institute of technology": { un: 11, qs: 10, the: 7 },
      "brown university": { un: 13, qs: 69, the: 53 },
      "cornell university": { un: 13, qs: 16, the: 18 },
      "dartmouth college": { un: 13, qs: 206, the: 99 },
      "columbia university in the city of new york": { un: 15, qs: 38, the: 20 },
      "university of california berkeley": { un: 15, qs: 17, the: 9 },
      "rice university": { un: 17, qs: 119, the: 87 },
      "university of california los angeles": { un: 17, qs: 46, the: 18 },
      "university of notre dame": { un: 20, qs: 241, the: 176 },
      "carnegie mellon university": { un: 20, qs: 52, the: 34 },
      "university of michigan": { un: 20, qs: 45, the: 23 },
      "vanderbilt university": { un: 20, qs: 189, the: 92 },
      "washington university in st louis": { un: 20, qs: 109, the: 56 },
      "emory university": { un: 24, qs: 182, the: 78 },
      "georgetown university": { un: 24, qs: 281, the: 143 },
      "university of virginia": { un: 26, qs: 211, the: 103 },
      "university of southern california": { un: 28, qs: 146, the: 72 },
      "university of north carolina at chapel hill": { un: 28, qs: 92, the: 52 },
      "university of florida": { un: 30, qs: 168, the: 126 },
      "wake forest university": { un: 30, qs: 451, the: 251 },
      "georgia institute of technology": { un: 32, qs: 70, the: 33 },
      "new york university": { un: 32, qs: 55, the: 29 },
      "tufts university": { un: 32, qs: 334, the: 176 },
      "university of california san diego": { un: 36, qs: 60, the: 37 },
      "university of illinois": { un: 36, qs: 70, the: 46 },
      "boston college": { un: 36, qs: 350, the: 251 },
      "university of rochester": { un: 39, qs: 189, the: 128 },
      "university of texas at austin": { un: 39, qs: 68, the: 43 },
      "college of william and mary": { un: 39, qs: 581, the: 351 },
      "university of wisconsin": { un: 39, qs: 83, the: 48 },
      "boston university": { un: 43, qs: 88, the: 64 },
      "brandeis university": { un: 43, qs: 481, the: 251 },
      "case western reserve university": { un: 43, qs: 320, the: 176 },
      "northeastern university": { un: 46, qs: 196, the: 168 },
      "purdue university": { un: 46, qs: 85, the: 86 },
      "university of georgia": { un: 46, qs: 340, the: 301 },
      "lehigh university": { un: 46, qs: 601, the: 351 },
      "tulane university": { un: 51, qs: 521, the: 301 },
      "ohio state university": { un: 51, qs: 120, the: 82 },
      "university of california davis": { un: 51, qs: 104, the: 66 },
      "university of california santa barbara": { un: 51, qs: 149, the: 59 },
      "florida state university": { un: 55, qs: 471, the: 251 },
      "university of maryland": { un: 55, qs: 138, the: 81 },
      "rutgers university": { un: 55, qs: 199, the: 134 },
      "university of pittsburgh": { un: 55, qs: 185, the: 128 },
      "university of washington": { un: 55, qs: 81, the: 25 },
      "george washington university": { un: 60, qs: 375, the: 251 },
      "syracuse university": { un: 60, qs: 601, the: 401 },
      "university of minnesota": { un: 60, qs: 210, the: 71 },
      "virginia polytechnic institute and state university": { un: 60, qs: 330, the: 201 },
      "worcester polytechnic institute": { un: 60, qs: 601, the: 501 },
      "pennsylvania state university": { un: 65, qs: 82, the: 75 },
      "university of connecticut": { un: 65, qs: 373, the: 251 },
      "university of massachusetts": { un: 65, qs: 214, the: 113 },
      "university of miami": { un: 65, qs: 281, the: 201 },
      "texas a & m university": { un: 70, qs: 144, the: 118 },
      "clemson university": { un: 70, qs: 541, the: 401 },
      "indiana university": { un: 70, qs: 261, the: 126 },
      "michigan state university": { un: 70, qs: 148, the: 93 },
      "university of california irvine": { un: 70, qs: 136, the: 78 },
      "fordham university": { un: 76, qs: 801, the: 501 },
      "north carolina state university at raleigh": { un: 76, qs: 291, the: 201 },
      "southern methodist university": { un: 76, qs: 601, the: 401 },
      "university of delaware": { un: 76, qs: 441, the: 251 },
      "university of colorado boulder": { un: 80, qs: 186, the: 103 },
      "colorado school of mines": { un: 80, qs: 401, the: 301 },
      "stony brook university": { un: 80, qs: 311, the: 168 },
      "university at buffalo": { un: 80, qs: 341, the: 201 },
      "iowa state university": { un: 85, qs: 451, the: 301 },
      "marquette university": { un: 85, qs: 801, the: 601 },
      "university of california santa cruz": { un: 85, qs: 271, the: 134 },
      "university of iowa": { un: 85, qs: 331, the: 176 },
      "university of illinois chicago": { un: 85, qs: 238, the: 176 },
      "baylor university": { un: 90, qs: 701, the: 501 },
      "binghamton university": { un: 90, qs: 601, the: 401 },
      "drexel university": { un: 90, qs: 601, the: 351 },
      "stevens institute of technology": { un: 90, qs: 701, the: 501 },
      "university of arizona": { un: 90, qs: 256, the: 176 },
      "arizona state university tempe": { un: 95, qs: 196, the: 143 },
      "howard university": { un: 95, qs: 801, the: 601 },
      "university of south carolina": { un: 95, qs: 651, the: 401 },
      "university of south florida": { un: 95, qs: 431, the: 201 },
      "yeshiva university": { un: 95, qs: 501, the: 251 },
      "american university": { un: 100, qs: 701, the: 501 },
      "rensselaer polytechnic institute": { un: 100, qs: 401, the: 301 },
      "university of oregon": { un: 100, qs: 501, the: 251 },
      "university of tennessee": { un: 100, qs: 531, the: 351 },
      "temple university": { un: 105, qs: 651, the: 401 },
      "university of alabama": { un: 105, qs: 801, the: 501 },
      "university of utah": { un: 105, qs: 312, the: 176 },
      "university of kansas": { un: 105, qs: 501, the: 301 },
      "university of nebraska": { un: 110, qs: 501, the: 301 },
      "university of new hampshire": { un: 110, qs: 801, the: 601 },
      "university of oklahoma": { un: 110, qs: 701, the: 501 },
      "university of kentucky": { un: 110, qs: 651, the: 401 },
      "creighton university": { un: 115, qs: null, the: null },
      "depaul university": { un: 115, qs: null, the: 601 },
      "george mason university": { un: 115, qs: 651, the: 351 },
      "loyola marymount university": { un: 115, qs: null, the: null },
      "saint louis university": { un: 115, qs: 701, the: 501 },
      "san diego state university": { un: 115, qs: 801, the: 601 },
      "university of cincinnati": { un: 120, qs: 561, the: 301 },
      "university of missouri": { un: 120, qs: 601, the: 401 },
      "university of hawaii at manoa": { un: 120, qs: 431, the: 401 },
      "university of denver": { un: 120, qs: 701, the: 501 },
      "colorado state university fort collins": { un: 125, qs: 431, the: 301 },
      "university of houston": { un: 125, qs: 521, the: 351 },
      "university of vermont": { un: 125, qs: 651, the: 401 },
      "clark university": { un: 130, qs: 801, the: 601 },
      "suny college of environmental science and forestry": { un: 130, qs: null, the: null },
      "university of tulsa": { un: 130, qs: null, the: null },
      "university of san diego": { un: 130, qs: null, the: null },
      "auburn university": { un: 135, qs: 801, the: 501 },
      "illinois institute of technology": { un: 135, qs: 651, the: 501 },
      "university of arkansas": { un: 135, qs: 801, the: 601 },
      "university of mississippi": { un: 135, qs: null, the: 601 },
      "loyola university chicago": { un: 140, qs: null, the: 501 },
      "new jersey institute of technology": { un: 140, qs: 651, the: 501 },
      "university of new mexico": { un: 140, qs: 801, the: 501 },
      "university of rhode island": { un: 140, qs: null, the: null },
      "kansas state university": { un: 145, qs: 801, the: 601 },
      "university of dayton": { un: 145, qs: null, the: null },
      "university of texas at dallas": { un: 145, qs: 421, the: 251 },
      "oregon state university": { un: 150, qs: 441, the: 301 },
      "university of idaho": { un: 150, qs: null, the: null },
      "university of wyoming": { un: 150, qs: null, the: null },
      "washington state university": { un: 150, qs: 451, the: 301 },
      "west virginia university": { un: 155, qs: 801, the: 601 },
      "university of maine": { un: 155, qs: null, the: null },
      "miami university oxford": { un: 155, qs: 701, the: 501 },
      "university of north carolina at charlotte": { un: 160, qs: 801, the: 601 },
      "university of texas at arlington": { un: 160, qs: 601, the: 401 },
      "university of texas at san antonio": { un: 165, qs: 801, the: 601 },
      "university of north texas": { un: 165, qs: 801, the: 601 },
      "georgia state university": { un: 170, qs: 801, the: 501 },
      "louisiana state university": { un: 170, qs: 801, the: 601 },
      "university of alabama at birmingham": { un: 170, qs: 501, the: 301 },
      "university of central florida": { un: 170, qs: 801, the: 601 },
      "wayne state university": { un: 175, qs: 651, the: 401 },
      "florida international university": { un: 175, qs: 801, the: 601 },
      "university of louisville": { un: 180, qs: 801, the: 601 },
      "old dominion university": { un: 180, qs: null, the: null },
      "university of memphis": { un: 185, qs: null, the: 601 },
      "university of nevada reno": { un: 185, qs: 801, the: 601 },
      "university of nevada las vegas": { un: 190, qs: 801, the: 601 },
      "kent state university": { un: 190, qs: 801, the: 601 },
      "bowling green state university": { un: 195, qs: null, the: null },
      "mississippi state university": { un: 195, qs: null, the: 601 },
      "ohio university": { un: 195, qs: 801, the: 601 },
      "university of montana": { un: 200, qs: null, the: null },
      "university of north dakota": { un: 200, qs: null, the: null }
    };

    // ─── Program-Specific Graduate Rankings (U.S. News 2025) ──────────────
    // Maps program field → school name → rank
    var PROGRAM_RANKINGS = {
      "business": {
        "stanford university": 1, "university of pennsylvania": 1,
        "harvard university": 3, "massachusetts institute of technology": 4,
        "university of chicago": 5, "columbia university in the city of new york": 6,
        "northwestern university": 7, "yale university": 8,
        "duke university": 9, "university of michigan": 10,
        "university of california berkeley": 11, "new york university": 12,
        "dartmouth college": 13, "university of virginia": 14,
        "cornell university": 15, "carnegie mellon university": 16,
        "university of california los angeles": 17, "university of texas at austin": 18,
        "university of north carolina at chapel hill": 19, "indiana university": 20,
        "emory university": 21, "washington university in st louis": 22,
        "georgetown university": 23, "georgia institute of technology": 24,
        "university of southern california": 25, "rice university": 26,
        "vanderbilt university": 27, "university of washington": 28,
        "university of wisconsin": 29, "arizona state university tempe": 30
      },
      "computer science": {
        "massachusetts institute of technology": 1, "carnegie mellon university": 1,
        "stanford university": 1, "university of california berkeley": 1,
        "university of illinois": 5, "cornell university": 5,
        "university of washington": 5, "georgia institute of technology": 8,
        "princeton university": 8, "california institute of technology": 10,
        "university of california los angeles": 10, "university of texas at austin": 10,
        "university of michigan": 10, "columbia university in the city of new york": 14,
        "university of wisconsin": 14, "university of california san diego": 16,
        "harvard university": 17, "university of pennsylvania": 17,
        "university of maryland": 19, "duke university": 20,
        "northwestern university": 20, "purdue university": 22,
        "new york university": 22, "ohio state university": 24,
        "rice university": 24, "university of massachusetts": 24
      },
      "engineering": {
        "massachusetts institute of technology": 1, "stanford university": 2,
        "university of california berkeley": 3, "california institute of technology": 4,
        "georgia institute of technology": 5, "carnegie mellon university": 6,
        "university of illinois": 7, "purdue university": 8,
        "university of michigan": 9, "university of texas at austin": 10,
        "cornell university": 11, "university of california san diego": 12,
        "princeton university": 13, "northwestern university": 14,
        "university of pennsylvania": 15, "university of california los angeles": 16,
        "johns hopkins university": 17, "columbia university in the city of new york": 18,
        "university of wisconsin": 19, "university of maryland": 20,
        "university of washington": 20, "duke university": 22,
        "harvard university": 22, "rice university": 24,
        "university of colorado boulder": 25, "ohio state university": 26,
        "university of minnesota": 26, "pennsylvania state university": 28,
        "university of southern california": 29, "virginia polytechnic institute and state university": 30
      },
      "psychology": {
        "stanford university": 1, "university of california berkeley": 2,
        "harvard university": 3, "university of california los angeles": 4,
        "university of michigan": 5, "yale university": 6,
        "university of illinois": 7, "princeton university": 8,
        "university of pennsylvania": 9, "university of minnesota": 10,
        "university of wisconsin": 11, "columbia university in the city of new york": 12,
        "duke university": 13, "northwestern university": 14,
        "university of north carolina at chapel hill": 15, "university of virginia": 16,
        "university of texas at austin": 17, "carnegie mellon university": 18,
        "university of california san diego": 19, "university of chicago": 20,
        "ohio state university": 21, "cornell university": 22,
        "university of washington": 23, "brown university": 24,
        "university of colorado boulder": 25, "university of pittsburgh": 26,
        "indiana university": 27, "new york university": 28,
        "johns hopkins university": 29, "emory university": 30
      },
      "education": {
        "university of pennsylvania": 1, "university of california los angeles": 2,
        "university of michigan": 3, "stanford university": 4,
        "vanderbilt university": 5, "university of wisconsin": 6,
        "harvard university": 7, "columbia university in the city of new york": 8,
        "northwestern university": 9, "university of california berkeley": 10,
        "new york university": 11, "university of texas at austin": 12,
        "university of virginia": 13, "johns hopkins university": 14,
        "university of washington": 15, "ohio state university": 16,
        "university of minnesota": 17, "university of illinois": 18,
        "university of florida": 19, "university of north carolina at chapel hill": 20
      },
      "law": {
        "yale university": 1, "stanford university": 2,
        "harvard university": 3, "university of chicago": 4,
        "columbia university in the city of new york": 5, "new york university": 6,
        "university of pennsylvania": 7, "university of virginia": 8,
        "duke university": 9, "northwestern university": 10,
        "university of michigan": 11, "university of california berkeley": 12,
        "cornell university": 13, "georgetown university": 14,
        "university of california los angeles": 15, "university of texas at austin": 16,
        "vanderbilt university": 17, "washington university in st louis": 18,
        "university of southern california": 19, "university of minnesota": 20
      },
      "medicine": {
        "harvard university": 1, "new york university": 2,
        "johns hopkins university": 3, "university of pennsylvania": 4,
        "stanford university": 5, "columbia university in the city of new york": 6,
        "university of california san francisco": 7, "duke university": 8,
        "university of washington": 9, "yale university": 10,
        "university of michigan": 11, "university of california los angeles": 12,
        "university of pittsburgh": 13, "cornell university": 14,
        "vanderbilt university": 15, "northwestern university": 16,
        "university of chicago": 17, "washington university in st louis": 18,
        "university of california san diego": 19, "emory university": 20
      },
      "public health": {
        "johns hopkins university": 1, "harvard university": 2,
        "university of north carolina at chapel hill": 3, "university of michigan": 4,
        "columbia university in the city of new york": 5, "emory university": 6,
        "university of washington": 7, "university of california los angeles": 8,
        "university of california berkeley": 9, "yale university": 10,
        "university of minnesota": 11, "boston university": 12,
        "university of pittsburgh": 13, "university of florida": 14,
        "george washington university": 15
      },
      "data science": {
        "massachusetts institute of technology": 1, "carnegie mellon university": 2,
        "stanford university": 3, "university of california berkeley": 4,
        "harvard university": 5, "university of michigan": 6,
        "columbia university in the city of new york": 7, "university of washington": 8,
        "new york university": 9, "university of pennsylvania": 10,
        "cornell university": 11, "georgia institute of technology": 12,
        "university of illinois": 13, "university of california san diego": 14,
        "duke university": 15, "university of chicago": 16,
        "university of texas at austin": 17, "northwestern university": 18,
        "purdue university": 19, "university of wisconsin": 20
      },
      "economics": {
        "massachusetts institute of technology": 1, "harvard university": 1,
        "stanford university": 3, "princeton university": 3,
        "university of chicago": 5, "university of california berkeley": 6,
        "yale university": 7, "northwestern university": 8,
        "columbia university in the city of new york": 9, "university of pennsylvania": 10,
        "new york university": 11, "university of michigan": 12,
        "university of wisconsin": 13, "duke university": 14,
        "university of california los angeles": 15, "university of minnesota": 16,
        "cornell university": 17, "carnegie mellon university": 18,
        "brown university": 19, "university of california san diego": 20
      },
      "nursing": {
        "johns hopkins university": 1, "duke university": 2,
        "emory university": 3, "university of pennsylvania": 4,
        "university of michigan": 5, "university of north carolina at chapel hill": 6,
        "university of washington": 7, "vanderbilt university": 8,
        "columbia university in the city of new york": 9, "yale university": 10,
        "university of california san francisco": 11, "university of pittsburgh": 12,
        "university of alabama at birmingham": 13, "ohio state university": 14,
        "university of virginia": 15
      },
      "social work": {
        "university of michigan": 1, "washington university in st louis": 2,
        "university of california berkeley": 3, "university of chicago": 4,
        "columbia university in the city of new york": 5, "university of washington": 6,
        "university of north carolina at chapel hill": 7, "university of texas at austin": 8,
        "university of pennsylvania": 9, "boston university": 10
      },
      "fine arts": {
        "yale university": 1, "university of california los angeles": 2,
        "virginia commonwealth university": 3, "rhode island school of design": 4,
        "school of the art institute of chicago": 5, "carnegie mellon university": 6,
        "columbia university in the city of new york": 7, "cranbrook academy of art": 8,
        "california institute of the arts": 9, "maryland institute college of art": 10
      },
      "public affairs": {
        "indiana university": 1, "syracuse university": 2,
        "harvard university": 3, "university of georgia": 4,
        "university of southern california": 5, "university of michigan": 6,
        "george washington university": 7, "georgetown university": 8,
        "university of california berkeley": 9, "american university": 10,
        "new york university": 11, "carnegie mellon university": 12,
        "university of texas at austin": 13, "university of wisconsin": 14,
        "university of minnesota": 15, "ohio state university": 16,
        "university of washington": 17, "duke university": 18,
        "columbia university in the city of new york": 19, "university of north carolina at chapel hill": 20
      }
    };

    // Lookup functions
    function getOverallRanking(schoolName) {
      var key = normalizeForRanking(schoolName);
      // Try exact match first
      if (RANKINGS_DATA[key]) return RANKINGS_DATA[key];
      // Try substring match
      for (var rk in RANKINGS_DATA) {
        if (key.indexOf(rk) >= 0 || rk.indexOf(key) >= 0) return RANKINGS_DATA[rk];
      }
      return null;
    }

    function getProgramRanking(schoolName, programField) {
      if (!programField) return null;
      var key = normalizeForRanking(schoolName);
      var field = programField.toLowerCase();
      // Map common search terms to ranking categories
      var fieldMap = {
        'mba': 'business', 'business administration': 'business', 'management': 'business', 'finance': 'business', 'marketing': 'business', 'accounting': 'business',
        'cs': 'computer science', 'computing': 'computer science', 'software': 'computer science', 'artificial intelligence': 'computer science', 'machine learning': 'computer science', 'information technology': 'computer science', 'cybersecurity': 'computer science',
        'engineering': 'engineering', 'electrical': 'engineering', 'mechanical': 'engineering', 'civil': 'engineering', 'chemical': 'engineering', 'biomedical': 'engineering', 'aerospace': 'engineering', 'industrial': 'engineering', 'materials': 'engineering', 'environmental engineering': 'engineering',
        'psychology': 'psychology', 'clinical psychology': 'psychology', 'cognitive': 'psychology', 'behavioral': 'psychology',
        'education': 'education', 'teaching': 'education', 'curriculum': 'education', 'educational': 'education',
        'law': 'law', 'legal': 'law', 'jd': 'law', 'juris': 'law',
        'medicine': 'medicine', 'medical': 'medicine', 'md': 'medicine',
        'public health': 'public health', 'epidemiology': 'public health', 'biostatistics': 'public health', 'health policy': 'public health', 'global health': 'public health',
        'data science': 'data science', 'data analytics': 'data science', 'statistics': 'data science', 'analytics': 'data science',
        'economics': 'economics', 'econometrics': 'economics',
        'nursing': 'nursing', 'nurse': 'nursing',
        'social work': 'social work', 'msw': 'social work',
        'fine arts': 'fine arts', 'mfa': 'fine arts', 'art': 'fine arts', 'studio art': 'fine arts',
        'public affairs': 'public affairs', 'public policy': 'public affairs', 'public administration': 'public affairs', 'mpa': 'public affairs', 'mpp': 'public affairs', 'government': 'public affairs'
      };
      var category = fieldMap[field] || field;
      var rankings = PROGRAM_RANKINGS[category];
      if (!rankings) return null;
      // Try exact match
      if (rankings[key] !== undefined) return { rank: rankings[key], field: category };
      // Try substring match
      for (var rk in rankings) {
        if (key.indexOf(rk) >= 0 || rk.indexOf(key) >= 0) return { rank: rankings[rk], field: category };
      }
      return null;
    }

    // Build ranking display HTML for cards
    function buildRankingDisplay(schoolName, programField) {
      var overall = getOverallRanking(schoolName);
      var program = getProgramRanking(schoolName, programField);
      var enc = encodeURIComponent(schoolName);

      if (!overall && !program) {
        return buildRankingLinks(schoolName);
      }

      var html = '<div style="margin:6px 0 2px;" onclick="event.stopPropagation();">';

      if (program) {
        html += '<div style="font-size:0.72rem; color:var(--accent); font-weight:700; margin-bottom:3px;">#' + program.rank + ' in ' + program.field.charAt(0).toUpperCase() + program.field.slice(1) + ' <span style="font-weight:400; color:var(--muted);">(U.S. News)</span></div>';
      }

      if (overall) {
        html += '<div style="display:flex; gap:6px; flex-wrap:wrap;">';
        if (overall.un) html += '<a href="https://www.usnews.com/best-graduate-schools/search?name=' + enc + '" target="_blank" style="font-size:0.68rem; padding:2px 7px; background:#1a365d; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">#' + overall.un + ' U.S. News</a>';
        if (overall.qs) html += '<a href="https://www.topuniversities.com/universities?q=' + enc + '" target="_blank" style="font-size:0.68rem; padding:2px 7px; background:#0070c0; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">#' + overall.qs + ' QS</a>';
        if (overall.the) html += '<a href="https://www.timeshighereducation.com/world-university-rankings?search=' + enc + '" target="_blank" style="font-size:0.68rem; padding:2px 7px; background:#9b2335; color:#fff; border-radius:10px; text-decoration:none; white-space:nowrap;">#' + overall.the + ' THE</a>';
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    // ─── Program-to-CIP-Code Mapping ─────────────────────────────────────
    // Maps common program names/keywords to College Scorecard CIP 4-digit codes
    // Credential levels: 5 = Master's, 6 = Research Doctorate, 7 = First Professional (JD/MD)
    var PROGRAM_CIP_MAP = {
      // Architecture
      'architecture': { cip: ['0402'], label: 'Architecture' },
      'architectural': { cip: ['0402'], label: 'Architecture' },
      'urban planning': { cip: ['0403'], label: 'Urban Planning' },
      'urban design': { cip: ['0403'], label: 'Urban Design' },
      'landscape architecture': { cip: ['0404'], label: 'Landscape Architecture' },
      // Computer & Information Sciences
      'computer science': { cip: ['1107'], label: 'Computer Science' },
      'cs': { cip: ['1107'], label: 'Computer Science' },
      'computing': { cip: ['1107'], label: 'Computer Science' },
      'software engineering': { cip: ['1107'], label: 'Software Engineering' },
      'hci': { cip: ['1104', '1105'], label: 'HCI / Information Science' },
      'human computer interaction': { cip: ['1104', '1105'], label: 'Human-Computer Interaction' },
      'human-computer interaction': { cip: ['1104', '1105'], label: 'Human-Computer Interaction' },
      'information science': { cip: ['1104'], label: 'Information Science' },
      'information systems': { cip: ['1104'], label: 'Information Systems' },
      'informatics': { cip: ['1104'], label: 'Informatics' },
      'ux': { cip: ['1104', '1105'], label: 'UX / HCI' },
      'ux design': { cip: ['1104', '1105'], label: 'UX Design' },
      'user experience': { cip: ['1104', '1105'], label: 'User Experience' },
      'information technology': { cip: ['1103'], label: 'Information Technology' },
      'it': { cip: ['1103'], label: 'Information Technology' },
      'cybersecurity': { cip: ['1110'], label: 'Cybersecurity' },
      'cyber security': { cip: ['1110'], label: 'Cybersecurity' },
      'artificial intelligence': { cip: ['1107', '1104'], label: 'Artificial Intelligence' },
      'ai': { cip: ['1107', '1104'], label: 'Artificial Intelligence' },
      'machine learning': { cip: ['1107', '2707'], label: 'Machine Learning' },
      'ml': { cip: ['1107', '2707'], label: 'Machine Learning' },
      'data science': { cip: ['3070', '1107', '2707'], label: 'Data Science' },
      'data analytics': { cip: ['3070', '1107', '2707'], label: 'Data Analytics' },
      'analytics': { cip: ['3070', '2707'], label: 'Analytics' },
      'business analytics': { cip: ['5202', '3070'], label: 'Business Analytics' },
      // Engineering
      'engineering': { cip: ['1400'], label: 'Engineering' },
      'electrical engineering': { cip: ['1410'], label: 'Electrical Engineering' },
      'ee': { cip: ['1410'], label: 'Electrical Engineering' },
      'ece': { cip: ['1410'], label: 'Electrical & Computer Engineering' },
      'mechanical engineering': { cip: ['1419'], label: 'Mechanical Engineering' },
      'civil engineering': { cip: ['1408'], label: 'Civil Engineering' },
      'biomedical engineering': { cip: ['1405'], label: 'Biomedical Engineering' },
      'bme': { cip: ['1405'], label: 'Biomedical Engineering' },
      'chemical engineering': { cip: ['1407'], label: 'Chemical Engineering' },
      'aerospace engineering': { cip: ['1402'], label: 'Aerospace Engineering' },
      'industrial engineering': { cip: ['1435'], label: 'Industrial Engineering' },
      'environmental engineering': { cip: ['1414'], label: 'Environmental Engineering' },
      'materials engineering': { cip: ['1418'], label: 'Materials Engineering' },
      'materials science': { cip: ['1418'], label: 'Materials Science' },
      // Business & Management
      'mba': { cip: ['5202'], label: 'Business Administration (MBA)' },
      'business administration': { cip: ['5202'], label: 'Business Administration' },
      'business': { cip: ['5202'], label: 'Business' },
      'management': { cip: ['5202'], label: 'Management' },
      'finance': { cip: ['5208'], label: 'Finance' },
      'accounting': { cip: ['5203'], label: 'Accounting' },
      'marketing': { cip: ['5214'], label: 'Marketing' },
      'supply chain': { cip: ['5202'], label: 'Supply Chain Management' },
      'operations': { cip: ['5202'], label: 'Operations Management' },
      'entrepreneurship': { cip: ['5207'], label: 'Entrepreneurship' },
      // Health & Medicine
      'public health': { cip: ['5122'], label: 'Public Health' },
      'mph': { cip: ['5122'], label: 'Public Health (MPH)' },
      'nursing': { cip: ['5138'], label: 'Nursing' },
      'healthcare': { cip: ['5107'], label: 'Healthcare Administration' },
      'health administration': { cip: ['5107'], label: 'Health Administration' },
      'health informatics': { cip: ['5107'], label: 'Health Informatics' },
      'biostatistics': { cip: ['2605'], label: 'Biostatistics' },
      'epidemiology': { cip: ['5122'], label: 'Epidemiology' },
      'pharmacy': { cip: ['5120'], label: 'Pharmacy' },
      'occupational therapy': { cip: ['5123'], label: 'Occupational Therapy' },
      'physical therapy': { cip: ['5126'], label: 'Physical Therapy' },
      'speech pathology': { cip: ['5102'], label: 'Speech-Language Pathology' },
      'speech language pathology': { cip: ['5102'], label: 'Speech-Language Pathology' },
      // Education
      'education': { cip: ['1301'], label: 'Education' },
      'teaching': { cip: ['1312'], label: 'Teacher Education' },
      'curriculum': { cip: ['1306'], label: 'Curriculum & Instruction' },
      'educational leadership': { cip: ['1304'], label: 'Educational Leadership' },
      'special education': { cip: ['1310'], label: 'Special Education' },
      'higher education': { cip: ['1306'], label: 'Higher Education' },
      // Social Sciences
      'psychology': { cip: ['4201'], label: 'Psychology' },
      'clinical psychology': { cip: ['4201'], label: 'Clinical Psychology' },
      'counseling': { cip: ['4201'], label: 'Counseling Psychology' },
      'social work': { cip: ['5115'], label: 'Social Work' },
      'msw': { cip: ['5115'], label: 'Social Work (MSW)' },
      'economics': { cip: ['4506'], label: 'Economics' },
      'political science': { cip: ['4510'], label: 'Political Science' },
      'international relations': { cip: ['4509'], label: 'International Relations' },
      'international affairs': { cip: ['4509'], label: 'International Affairs' },
      'sociology': { cip: ['4511'], label: 'Sociology' },
      // Public Policy & Administration
      'public policy': { cip: ['4404'], label: 'Public Policy' },
      'public administration': { cip: ['4404'], label: 'Public Administration' },
      'mpa': { cip: ['4404'], label: 'Public Administration (MPA)' },
      'mpp': { cip: ['4404'], label: 'Public Policy (MPP)' },
      'nonprofit': { cip: ['4404'], label: 'Nonprofit Management' },
      // Sciences
      'biology': { cip: ['2601'], label: 'Biology' },
      'biomedical sciences': { cip: ['2605'], label: 'Biomedical Sciences' },
      'neuroscience': { cip: ['2615'], label: 'Neuroscience' },
      'chemistry': { cip: ['4005'], label: 'Chemistry' },
      'physics': { cip: ['4008'], label: 'Physics' },
      'mathematics': { cip: ['2701'], label: 'Mathematics' },
      'math': { cip: ['2701'], label: 'Mathematics' },
      'applied math': { cip: ['2707'], label: 'Applied Mathematics' },
      'applied mathematics': { cip: ['2707'], label: 'Applied Mathematics' },
      'statistics': { cip: ['2705'], label: 'Statistics' },
      'environmental science': { cip: ['0301'], label: 'Environmental Science' },
      'ecology': { cip: ['0301'], label: 'Ecology' },
      'geology': { cip: ['4006'], label: 'Geology' },
      'earth science': { cip: ['4006'], label: 'Earth Sciences' },
      // Arts & Design
      'fine arts': { cip: ['5004'], label: 'Fine Arts' },
      'mfa': { cip: ['5004'], label: 'Fine Arts (MFA)' },
      'graphic design': { cip: ['5004'], label: 'Graphic Design' },
      'design': { cip: ['5004'], label: 'Design' },
      'music': { cip: ['5009'], label: 'Music' },
      'film': { cip: ['5006'], label: 'Film / Cinema Studies' },
      'theater': { cip: ['5005'], label: 'Theater / Drama' },
      'theatre': { cip: ['5005'], label: 'Theatre / Drama' },
      // Communications & Media
      'communications': { cip: ['0901'], label: 'Communications' },
      'communication': { cip: ['0901'], label: 'Communication Studies' },
      'journalism': { cip: ['0904'], label: 'Journalism' },
      'media': { cip: ['0901'], label: 'Media Studies' },
      'public relations': { cip: ['0909'], label: 'Public Relations' },
      // Humanities
      'history': { cip: ['5401'], label: 'History' },
      'english': { cip: ['2301'], label: 'English' },
      'philosophy': { cip: ['3801'], label: 'Philosophy' },
      'linguistics': { cip: ['1601'], label: 'Linguistics' },
      'creative writing': { cip: ['2305'], label: 'Creative Writing' },
      // Law
      'law': { cip: ['2201'], label: 'Law' },
      'jd': { cip: ['2201'], label: 'Law (JD)' },
      'legal studies': { cip: ['2201'], label: 'Legal Studies' },
      // Library & Information
      'library science': { cip: ['2501'], label: 'Library Science' },
      'mlis': { cip: ['2501'], label: 'Library & Information Science' },
      // Other Interdisciplinary
      'cognitive science': { cip: ['3025'], label: 'Cognitive Science' },
      'sustainability': { cip: ['0301'], label: 'Sustainability Studies' },
      'real estate': { cip: ['5215'], label: 'Real Estate' },
      'hospitality': { cip: ['5209'], label: 'Hospitality Management' },
      'sports management': { cip: ['3105'], label: 'Sports Management' },
      'kinesiology': { cip: ['3105'], label: 'Kinesiology' }
    };

    // ─── Query Analysis: Detect program vs school search ─────────────────
    // Analyzes a search query to determine if it's a program search, school search, or mixed
    function analyzeSearchQuery(query) {
      if (!query) return { type: 'school' };
      var lowerQ = query.toLowerCase().trim();

      // If it's exactly a known school alias, it's purely a school search
      if (SCHOOL_ALIASES[lowerQ]) return { type: 'school' };

      // Check if query starts with a school alias (e.g., "MIT computer science", "Stanford MBA")
      var schoolName = null;
      var remainder = lowerQ;
      var aliasKeys = Object.keys(SCHOOL_ALIASES).sort(function(a,b){ return b.length - a.length; });
      for (var k = 0; k < aliasKeys.length; k++) {
        var alias = aliasKeys[k];
        if (lowerQ.indexOf(alias + ' ') === 0) {
          schoolName = SCHOOL_ALIASES[alias];
          remainder = lowerQ.substring(alias.length + 1).trim();
          break;
        }
      }

      // If we found a school alias but nothing remains, it's a school search
      if (schoolName && !remainder) return { type: 'school' };

      // Try to find a program match in the remainder
      var programResult = findProgramCIP(remainder);

      if (programResult) {
        return {
          type: schoolName ? 'mixed' : 'program',
          cipCodes: programResult.cipCodes,
          cipLabel: programResult.label,
          degreeLevel: programResult.degreeLevel,
          schoolName: schoolName,
          searchTerms: programResult.searchTerms || programResult.label
        };
      }

      // No program found — treat as school search
      return { type: 'school' };
    }

    // Finds CIP codes from a program-related query string
    function findProgramCIP(text) {
      if (!text) return null;
      text = text.toLowerCase().trim();

      // 1. Direct match first (e.g., "hci", "mba", "computer science", "architecture")
      if (PROGRAM_CIP_MAP[text]) {
        var m = PROGRAM_CIP_MAP[text];
        var degreeLevel = null;
        // Infer degree level from well-known abbreviations
        if (/^(mba|mpa|mph|msw|mfa|mlis|meng|mpp)$/.test(text)) degreeLevel = 5;
        if (/^(jd)$/.test(text)) degreeLevel = 7;
        return { cipCodes: m.cip, label: m.label, degreeLevel: degreeLevel, searchTerms: text };
      }

      // 2. Strip degree words and try again
      var degreeLevel = null;
      var cleaned = text;

      // Detect and strip master's level indicators
      var masterRe = /\b(master'?s?|ms|m\.s\.?|ma|m\.a\.?|meng|m\.eng)\b/gi;
      if (masterRe.test(cleaned)) {
        degreeLevel = 5;
        cleaned = cleaned.replace(/\b(master'?s?|ms|m\.s\.?|ma|m\.a\.?|meng|m\.eng)\b/gi, '');
      }

      // Detect and strip doctoral level indicators
      var doctoralRe = /\b(phd|ph\.d\.?|doctorate|doctoral|doctor)\b/gi;
      if (doctoralRe.test(cleaned)) {
        degreeLevel = 6;
        cleaned = cleaned.replace(/\b(phd|ph\.d\.?|doctorate|doctoral|doctor)\b/gi, '');
      }

      // Strip filler / connector words
      cleaned = cleaned.replace(/\b(in|of|the|for|at|and|with|a|an|to|from|on|degree|program|programs|certificate|graduate|grad|studies|study)\b/gi, '');
      cleaned = cleaned.replace(/\s+/g, ' ').trim();

      // Direct match after cleaning
      if (cleaned && PROGRAM_CIP_MAP[cleaned]) {
        return { cipCodes: PROGRAM_CIP_MAP[cleaned].cip, label: PROGRAM_CIP_MAP[cleaned].label, degreeLevel: degreeLevel, searchTerms: cleaned };
      }

      // 3. Substring match — check if any CIP map key is contained in the cleaned text (longest first)
      if (cleaned) {
        var cipKeys = Object.keys(PROGRAM_CIP_MAP).sort(function(a,b){ return b.length - a.length; });
        for (var c = 0; c < cipKeys.length; c++) {
          var ck = cipKeys[c];
          if (ck.length >= 2 && cleaned.indexOf(ck) >= 0) {
            return { cipCodes: PROGRAM_CIP_MAP[ck].cip, label: PROGRAM_CIP_MAP[ck].label, degreeLevel: degreeLevel, searchTerms: cleaned };
          }
        }
      }

      // 4. No program match
      return null;
    }

    // Smart query parser: extracts school name from mixed queries like "Cornell master in business analytics"
    function extractSchoolName(query) {
      if (!query) return query;
      var original = query.trim();
      var lowerQ = original.toLowerCase();

      // 1. Check full query against alias map first
      if (SCHOOL_ALIASES[lowerQ]) return SCHOOL_ALIASES[lowerQ];

      // 2. Check if query starts with a known alias (e.g., "MIT computer science")
      var aliasKeys = Object.keys(SCHOOL_ALIASES).sort(function(a,b){ return b.length - a.length; }); // longest first
      for (var k = 0; k < aliasKeys.length; k++) {
        var alias = aliasKeys[k];
        if (lowerQ.indexOf(alias) === 0 && (lowerQ.length === alias.length || lowerQ[alias.length] === ' ')) {
          return SCHOOL_ALIASES[alias];
        }
      }

      // 3. Fall back to stripping program words
      // Common program/degree words to strip out
      var programWords = [
        'master', 'masters', 'master\'s', 'ms', 'm\\.s', 'ma', 'm\\.a', 'mba', 'mfa', 'meng', 'mph', 'msw',
        'phd', 'ph\\.d', 'doctorate', 'doctoral', 'doctor',
        'bachelor', 'bachelors', 'bachelor\'s', 'bs', 'b\\.s', 'ba', 'b\\.a',
        'degree', 'program', 'certificate', 'diploma',
        'computer', 'science', 'engineering', 'business', 'analytics', 'data',
        'information', 'technology', 'systems', 'management', 'administration',
        'finance', 'accounting', 'marketing', 'economics', 'statistics',
        'mathematics', 'math', 'physics', 'chemistry', 'biology',
        'psychology', 'education', 'nursing', 'health', 'public',
        'arts', 'design', 'architecture', 'music', 'communication',
        'electrical', 'mechanical', 'civil', 'biomedical', 'chemical',
        'aerospace', 'industrial', 'environmental', 'materials',
        'artificial', 'intelligence', 'machine', 'learning', 'cybersecurity',
        'software', 'applied', 'computational', 'biostatistics',
        'school', 'college', 'graduate', 'admission', 'admissions',
        'requirements', 'application', 'apply'
      ];

      // Filler / connector words
      var fillerWords = ['in', 'of', 'the', 'for', 'at', 'and', 'with', 'a', 'an', 'to', 'from', 'on'];

      // Build a regex from all strip words
      var allStripWords = programWords.concat(fillerWords);
      var words = original.split(/\s+/);
      var schoolWords = [];

      for (var i = 0; i < words.length; i++) {
        var w = words[i].toLowerCase().replace(/[^a-z.'\\-]/g, '');
        var isStripWord = false;
        for (var j = 0; j < allStripWords.length; j++) {
          if (w === allStripWords[j] || w === allStripWords[j] + 's') {
            isStripWord = true;
            break;
          }
        }
        if (!isStripWord && w.length > 0) {
          schoolWords.push(words[i]);
        }
      }

      // If we stripped everything, fall back to first 1-2 words of original
      if (schoolWords.length === 0) {
        schoolWords = original.split(/\s+/).slice(0, 2);
      }

      return schoolWords.join(' ').trim();
    }

    // ─── Sort System ────────────────────────────────────────────────────
    var _currentSortMode = 'relevance';
    var _lastSearchContext = null; // { type: 'main'|'program'|'school', args: [...] }

    function applySortToResults(results, sortMode) {
      if (!results || results.length === 0) return results;
      var sorted = results.slice(); // copy
      switch (sortMode) {
        case 'total-asc':
          sorted.sort(function(a, b) { return getEstimatedTotalCost(a) - getEstimatedTotalCost(b); });
          break;
        case 'total-desc':
          sorted.sort(function(a, b) { return getEstimatedTotalCost(b) - getEstimatedTotalCost(a); });
          break;
        case 'tuition-asc':
          sorted.sort(function(a, b) {
            var tA = a['latest.cost.tuition.out_of_state'] || a['latest.cost.tuition.in_state'] || 999999;
            var tB = b['latest.cost.tuition.out_of_state'] || b['latest.cost.tuition.in_state'] || 999999;
            return tA - tB;
          });
          break;
        case 'ranking':
          sorted.sort(function(a, b) {
            var rA = getOverallRanking(a['school.name'] || '');
            var rB = getOverallRanking(b['school.name'] || '');
            var scoreA = rA ? Math.min(rA.un || 9999, rA.qs || 9999, rA.the || 9999) : 9999;
            var scoreB = rB ? Math.min(rB.un || 9999, rB.qs || 9999, rB.the || 9999) : 9999;
            return scoreA - scoreB;
          });
          break;
        default: // 'relevance' — no re-sort
          break;
      }
      return sorted;
    }

    function handleSort() {
      var sel = document.getElementById('search-sort');
      _currentSortMode = sel ? sel.value : 'relevance';
      if (!_lastSearchContext) return;
      var ctx = _lastSearchContext;
      if (ctx.type === 'main') {
        searchFromMainPage(ctx.args[0], ctx.args[1]);
      } else if (ctx.type === 'program') {
        searchProgramsAPI(ctx.args[0], ctx.args[1]);
      } else if (ctx.type === 'school') {
        searchSchoolsAPI();
      }
    }

    function showSortDropdown() {
      var sel = document.getElementById('search-sort');
      if (sel) sel.style.display = '';
    }

    // Sort API results so best match appears first
    function sortByRelevance(results, query) {
      var q = query.toLowerCase().trim();
      return results.sort(function(a, b) {
        var nameA = (a['school.name'] || '').toLowerCase();
        var nameB = (b['school.name'] || '').toLowerCase();

        // Exact match gets highest priority
        var exactA = nameA === q ? 1 : 0;
        var exactB = nameB === q ? 1 : 0;
        if (exactA !== exactB) return exactB - exactA;

        // Starts with query gets next priority
        var startsA = nameA.indexOf(q) === 0 ? 1 : 0;
        var startsB = nameB.indexOf(q) === 0 ? 1 : 0;
        if (startsA !== startsB) return startsB - startsA;

        // Contains query as whole word
        var containsA = nameA.indexOf(q) >= 0 ? 1 : 0;
        var containsB = nameB.indexOf(q) >= 0 ? 1 : 0;
        if (containsA !== containsB) return containsB - containsA;

        // Prefer "Main Campus" entries (the API uses this suffix for primary campuses)
        var mainA = nameA.indexOf('main campus') >= 0 ? 1 : 0;
        var mainB = nameB.indexOf('main campus') >= 0 ? 1 : 0;
        if (mainA !== mainB) return mainB - mainA;

        // Shorter names are more likely the main campus (not branch)
        var lenDiff = nameA.length - nameB.length;
        if (Math.abs(lenDiff) > 5) return lenDiff;

        // Prefer names that contain more query words
        var qWords = q.split(/\s+/);
        var matchA = 0, matchB = 0;
        for (var i = 0; i < qWords.length; i++) {
          if (qWords[i].length > 2) {
            if (nameA.indexOf(qWords[i]) >= 0) matchA++;
            if (nameB.indexOf(qWords[i]) >= 0) matchB++;
          }
        }
        return matchB - matchA;
      });
    }

    async function searchFromMainPage(query, stateFilter) {
      const grid = document.getElementById('cards-grid');
      const countEl = document.getElementById('results-count');
      const key = getApiKey();

      // Extract school name from mixed queries like "Cornell master in business analytics"
      const schoolName = query ? extractSchoolName(query) : '';

      try {
        const fields = [
          'school.name', 'school.city', 'school.state',
          'school.school_url', 'school.ownership',
          'school.locale',
          'latest.cost.tuition.in_state',
          'latest.cost.tuition.out_of_state',
          'latest.cost.avg_net_price.overall',
          'latest.earnings.10_yrs_after_entry.mean_earnings',
          'latest.completion.completion_rate_4yr_150nt',
          'latest.student.retention_rate.four_year.full_time',
          'latest.aid.median_debt.completers.overall',
          'latest.admissions.admission_rate.overall',
          'latest.programs.cip_4_digit'
        ].join(',');

        var apiUrl = `${API_BASE}?fields=${fields}&per_page=12&api_key=${key}`;
        if (schoolName) apiUrl += `&school.name=${encodeURIComponent(schoolName)}`;
        if (stateFilter) apiUrl += `&school.state=${encodeURIComponent(stateFilter)}`;
        // If no school name and no state, search by grad programs existing
        if (!schoolName && !stateFilter) { return; }
        const url = apiUrl;
        const res = await fetch(url);
        if (!res.ok) throw new Error('API error');

        const data = await res.json();
        var results = sortByRelevance(data.results || [], schoolName);

        _lastSearchContext = { type: 'main', args: [query, stateFilter] };
        showSortDropdown();
        if (_currentSortMode !== 'relevance') {
          results = applySortToResults(results, _currentSortMode);
        }

        // Apply region and ranking filters (client-side post-filter)
        if (_activeRegionFilter) {
          results = results.filter(function(s) { return stateMatchesRegionFilter(s['school.state']); });
        }
        if (_activeRankingFilter) {
          results = results.filter(function(s) { return schoolMatchesRankingFilter(s['school.name'] || ''); });
        }

        if (results.length === 0) {
          var searchDesc = schoolName || '';
          if (stateFilter) searchDesc += (searchDesc ? ' in ' : 'schools in ') + (US_STATES[stateFilter] || stateFilter);
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1">
              <div class="empty-state-icon">&#128269;</div>
              <p>No schools found for "${searchDesc}". Try a different search or adjust your filters.</p>
            </div>`;
          if (countEl) countEl.textContent = '0 results';
          return;
        }

        if (countEl) countEl.textContent = `${results.length} school${results.length !== 1 ? 's' : ''} found (live data)`;

        grid.innerHTML = `
          <div style="grid-column: 1 / -1; margin-bottom: 8px;">
            <div style="display: inline-block; background: var(--accent); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">Live results from U.S. Department of Education</div>
          </div>` +
          results.map(function(school, idx) {
            // Cache the result so the modal can access it
            var cacheKey = 'sch_' + idx;
            _apiResultsCache[cacheKey] = school;

            var name = school['school.name'] || 'Unknown';
            var city = school['school.city'] || '';
            var state = school['school.state'] || '';
            var setting = getLocaleSetting(school['school.locale']);
            var tuitionStr = formatTuition(school);
            var programs = school['latest.programs.cip_4_digit'] || [];
            var gradPrograms = programs.filter(function(p) { return p.credential && (p.credential.level === 5 || p.credential.level === 6); });
            var gradCount = gradPrograms.length;

            var apiSaved = isApiSchoolSaved(school);
            var outcomes = getSchoolOutcomes(school);
            // Build a program-specific link from first grad program, or generic grad admissions link
            var firstGradProg = gradPrograms.length > 0 ? gradPrograms[0] : null;
            var progLinkLabel, progLinkUrl;
            if (firstGradProg && firstGradProg.title) {
              progLinkLabel = 'Find ' + firstGradProg.title + ' program page';
              progLinkUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + firstGradProg.title + ' admissions program');
            } else {
              progLinkLabel = 'Find graduate admissions page';
              progLinkUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' graduate admissions programs');
            }
            return '<div class="school-card" onclick="openApiModal(\'' + cacheKey + '\')" style="cursor:pointer; position:relative;">' +
              '<button class="bookmark-btn ' + (apiSaved ? 'saved' : '') + '" onclick="event.stopPropagation(); toggleSaveApiSchool(\'' + cacheKey + '\'); this.classList.toggle(\'saved\'); this.innerHTML = this.classList.contains(\'saved\') ? \'&#9733; Saved\' : \'&#9733;\';" title="' + (apiSaved ? 'Remove from saved' : 'Save school') + '" aria-label="Save school">&#9733;</button>' +
              '<div class="school-card-name">' + name + '</div>' +
              '<div class="school-card-location">' + city + ', ' + state + '</div>' +
              '<div class="school-stats">' +
                '<div class="school-stat"><div class="school-stat-label">Setting</div><div class="school-stat-value">' + setting + '</div></div>' +
                '<div class="school-stat"><div class="school-stat-label">Tuition</div><div class="school-stat-value">' + tuitionStr + '</div></div>' +
                '<div class="school-stat"><div class="school-stat-label">Est. Living Cost</div><div class="school-stat-value" style="color:#0369a1;">' + formatLivingCost(state) + '</div></div>' +
                '<div class="school-stat"><div class="school-stat-label">Grad Programs</div><div class="school-stat-value">' + gradCount + '</div></div>' +
                (outcomes.earnings ? '<div class="school-stat"><div class="school-stat-label">Avg Salary (10yr)</div><div class="school-stat-value" style="color:#059669;">' + outcomes.earnings + '</div></div>' : '') +
                (outcomes.gradRate ? '<div class="school-stat"><div class="school-stat-label">UG Grad Rate</div><div class="school-stat-value">' + outcomes.gradRate + '</div></div>' : '') +
              '</div>' +
              buildRankingDisplay(name, null) +
              '<a href="' + progLinkUrl + '" target="_blank" onclick="event.stopPropagation();" class="school-card-link" style="cursor:pointer; color:var(--accent); text-decoration:none;">' + progLinkLabel + ' &rarr;</a>' +
            '</div>';
          }).join('');

      } catch (err) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1">
            <div class="empty-state-icon">&#128269;</div>
            <p>No results found for "${query}". Try a different search term or adjust your filters.</p>
          </div>`;
      }
    }

    // ─── Program Search via CIP Codes ────────────────────────────────────
    // Searches the College Scorecard API by program CIP code instead of school name
    async function searchProgramsAPI(analysis, stateFilter) {
      const grid = document.getElementById('cards-grid');
      const countEl = document.getElementById('results-count');
      const key = getApiKey();

      try {
        const fields = [
          'school.name', 'school.city', 'school.state',
          'school.school_url', 'school.ownership',
          'school.locale',
          'latest.cost.tuition.in_state',
          'latest.cost.tuition.out_of_state',
          'latest.cost.avg_net_price.overall',
          'latest.earnings.10_yrs_after_entry.mean_earnings',
          'latest.completion.completion_rate_4yr_150nt',
          'latest.student.retention_rate.four_year.full_time',
          'latest.aid.median_debt.completers.overall',
          'latest.admissions.admission_rate.overall',
          'latest.programs.cip_4_digit'
        ].join(',');

        // Use the first CIP code for filtering (API only supports one at a time)
        var cipCode = analysis.cipCodes[0];
        var apiUrl = API_BASE + '?fields=' + fields + '&per_page=20&api_key=' + key;
        apiUrl += '&latest.programs.cip_4_digit.code=' + cipCode;

        // Filter by degree level if specified
        if (analysis.degreeLevel) {
          apiUrl += '&latest.programs.cip_4_digit.credential.level=' + analysis.degreeLevel;
        }

        // Filter by school name for mixed queries (e.g., "Stanford MBA")
        if (analysis.schoolName) {
          apiUrl += '&school.name=' + encodeURIComponent(analysis.schoolName);
        }

        // Filter by state
        if (stateFilter) {
          apiUrl += '&school.state=' + encodeURIComponent(stateFilter);
        }

        // Sort by admission rate to surface selective schools first
        apiUrl += '&sort=latest.admissions.admission_rate.overall:asc';

        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('API error');
        const data = await res.json();

        var results = data.results || [];

        // ── KEY QUALITY FILTER: Remove schools that don't actually have a matching program ──
        // The API filter is inclusive: CIP code + credential level are applied separately,
        // so a school may appear if it has CIP 0901 at bachelor's level AND any master's program.
        // We verify each school has a program matching BOTH the CIP code AND degree level.
        results = results.filter(function(school) {
          var progs = school['latest.programs.cip_4_digit'] || [];
          var hasMatch = progs.some(function(p) {
            var codeOk = false;
            for (var ci = 0; ci < analysis.cipCodes.length; ci++) {
              if (p.code === analysis.cipCodes[ci]) { codeOk = true; break; }
            }
            if (!codeOk) return false;
            if (analysis.degreeLevel && p.credential && p.credential.level !== analysis.degreeLevel) return false;
            return true;
          });
          return hasMatch;
        });

        // ── KEYWORD RELEVANCE FILTER: Verify program titles relate to search query ──
        // Uses the user's actual search terms (not the CIP label) so "communication" doesn't
        // match "Comparative Media Studies" just because the CIP label includes "Studies".
        // When searchTerms is available: strict filter (user typed these specific words).
        // When only cipLabel available: soft fallback (don't eliminate all results).
        var kwSource = analysis.searchTerms || analysis.cipLabel || '';
        if (kwSource) {
          var searchWords = kwSource.toLowerCase().split(/\s+/).filter(function(w) { return w.length >= 3; });
          if (searchWords.length > 0) {
            var kwFiltered = results.filter(function(school) {
              var progs = school['latest.programs.cip_4_digit'] || [];
              var hasRelevantTitle = progs.some(function(p) {
                var codeOk = false;
                for (var ci = 0; ci < analysis.cipCodes.length; ci++) {
                  if (p.code === analysis.cipCodes[ci]) { codeOk = true; break; }
                }
                if (!codeOk) return false;
                if (analysis.degreeLevel && p.credential && p.credential.level !== analysis.degreeLevel) return false;
                var title = (p.title || '').toLowerCase();
                return searchWords.some(function(w) { return title.indexOf(w) >= 0; });
              });
              return hasRelevantTitle;
            });
            // Strict when using user's searchTerms; soft fallback when using cipLabel only
            if (analysis.searchTerms) {
              results = kwFiltered; // strict: user explicitly searched these words
            } else if (kwFiltered.length > 0) {
              results = kwFiltered; // soft: only apply if it doesn't eliminate everything
            }
          }
        }

        if (analysis.schoolName) {
          results = sortByRelevance(results, analysis.schoolName);
        }

        _lastSearchContext = { type: 'program', args: [analysis, stateFilter] };
        showSortDropdown();
        if (_currentSortMode !== 'relevance') {
          results = applySortToResults(results, _currentSortMode);
        }

        // Apply region and ranking filters (client-side post-filter)
        if (_activeRegionFilter) {
          results = results.filter(function(s) { return stateMatchesRegionFilter(s['school.state']); });
        }
        if (_activeRankingFilter) {
          results = results.filter(function(s) { return schoolMatchesRankingFilter(s['school.name'] || ''); });
        }

        var total = results.length;

        if (results.length === 0) {
          var searchDesc = analysis.cipLabel || 'this program';
          if (stateFilter) searchDesc += ' in ' + (US_STATES[stateFilter] || stateFilter);
          if (analysis.schoolName) searchDesc += ' at ' + analysis.schoolName;
          grid.innerHTML =
            '<div class="empty-state" style="grid-column: 1 / -1">' +
              '<div class="empty-state-icon">&#128269;</div>' +
              '<p>No schools found offering ' + searchDesc + '. Try broadening your search.</p>' +
            '</div>';
          if (countEl) countEl.textContent = '0 results';
          return;
        }

        var degreeSuffix = analysis.degreeLevel === 5 ? " Master's" : analysis.degreeLevel === 6 ? ' Doctoral' : '';
        if (countEl) countEl.textContent = (total > 20 ? '20 of ' + total : results.length) + ' school' + (results.length !== 1 ? 's' : '') + ' with ' + analysis.cipLabel + degreeSuffix + ' programs';

        grid.innerHTML =
          '<div style="grid-column: 1 / -1; margin-bottom: 8px;">' +
            '<div style="display: inline-flex; align-items: center; gap: 8px; background: var(--accent); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">' +
              '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 14l9-5-9-5-9 5 9 5z"/><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/></svg>' +
              total + ' schools offer ' + analysis.cipLabel + degreeSuffix + ' programs &mdash; Live data from U.S. Dept. of Education' +
            '</div>' +
          '</div>' +
          results.map(function(school, idx) {
            // Cache the result so the modal can access it
            var cacheKey = 'prog_' + idx;
            _apiResultsCache[cacheKey] = school;

            var name = school['school.name'] || 'Unknown';
            var city = school['school.city'] || '';
            var state = school['school.state'] || '';
            var setting = getLocaleSetting(school['school.locale']);
            var tuitionStr = formatTuition(school);

            // Find the matching program(s) in this school's CIP data
            var programs = school['latest.programs.cip_4_digit'] || [];
            var matchingProgs = programs.filter(function(p) {
              var codeMatch = false;
              for (var ci = 0; ci < analysis.cipCodes.length; ci++) {
                if (p.code === analysis.cipCodes[ci]) { codeMatch = true; break; }
              }
              if (!codeMatch) return false;
              if (analysis.degreeLevel && p.credential && p.credential.level !== analysis.degreeLevel) return false;
              return true;
            });
            // Further narrow to programs whose titles match the user's search keywords
            // This prevents showing "Journalism, Public Relations, Digital Media" when user searched "communication"
            var _kwSrc = (analysis.searchTerms || analysis.cipLabel || '').toLowerCase();
            var _kwWords = _kwSrc.split(/\s+/).filter(function(w) { return w.length >= 3; });
            if (_kwWords.length > 0) {
              var kwMatchedProgs = matchingProgs.filter(function(p) {
                var t = (p.title || '').toLowerCase();
                return _kwWords.some(function(w) { return t.indexOf(w) >= 0; });
              });
              // Use keyword-matched if any found; otherwise fall back to all CIP-matched
              if (kwMatchedProgs.length > 0) matchingProgs = kwMatchedProgs;
            }
            var progNames = matchingProgs.map(function(p) {
              var credLabel = p.credential ? p.credential.title || '' : '';
              return p.title + (credLabel ? ' (' + credLabel + ')' : '');
            });
            var progDisplay = progNames.length > 0 ? progNames.slice(0, 3).join(', ') : analysis.cipLabel;

            var apiSaved = isApiSchoolSaved(school);
            // Use program-specific data instead of institution-level (undergrad) stats
            var progEarnings = getProgramEarnings(matchingProgs);
            var progDebt = getProgramDebt(matchingProgs);
            // Build a program-specific search URL (API doesn't provide program URLs)
            var firstProgTitle = matchingProgs.length > 0 ? (matchingProgs[0].title || analysis.cipLabel) : analysis.cipLabel;
            var progSearchUrl = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' ' + firstProgTitle + ' admissions program');
            var degreeBadge = analysis.degreeLevel ? getCredentialBadge(analysis.degreeLevel) : '';

            return '<div class="school-card" onclick="openApiModal(\'' + cacheKey + '\')" style="cursor:pointer; position:relative;">' +
              '<button class="bookmark-btn ' + (apiSaved ? 'saved' : '') + '" onclick="event.stopPropagation(); toggleSaveApiSchool(\'' + cacheKey + '\'); this.classList.toggle(\'saved\'); this.innerHTML = this.classList.contains(\'saved\') ? \'&#9733; Saved\' : \'&#9733;\';" title="' + (apiSaved ? 'Remove from saved' : 'Save school') + '" aria-label="Save school">&#9733;</button>' +
              '<div class="school-card-name">' + name + '</div>' +
              '<div style="color: var(--accent); font-weight: 600; font-size: 0.9rem; margin: 2px 0 6px;">' + progDisplay + ' ' + degreeBadge + '</div>' +
              '<div class="school-card-location">' + city + ', ' + state + '</div>' +
              '<div class="school-stats">' +
                '<div class="school-stat"><div class="school-stat-label">Setting</div><div class="school-stat-value">' + setting + '</div></div>' +
                '<div class="school-stat"><div class="school-stat-label">Tuition (Inst.)</div><div class="school-stat-value">' + tuitionStr + '</div></div>' +
                '<div class="school-stat"><div class="school-stat-label">Est. Living Cost</div><div class="school-stat-value" style="color:#0369a1;">' + formatLivingCost(state) + '</div></div>' +
                (progEarnings ? '<div class="school-stat"><div class="school-stat-label">' + progEarnings.label + '</div><div class="school-stat-value" style="color:#059669;">' + progEarnings.value + '</div></div>' : '') +
                (progDebt ? '<div class="school-stat"><div class="school-stat-label">Median Grad Debt</div><div class="school-stat-value" style="color:#b45309;">' + progDebt.value + '</div></div>' : '') +
              '</div>' +
              '<div style="font-size:0.65rem; color:var(--muted); margin-top:2px; padding: 0 2px;">Tuition is institutional (may differ for graduate programs)</div>' +
              buildRankingDisplay(name, analysis.cipLabel) +
              '<a href="' + progSearchUrl + '" target="_blank" onclick="event.stopPropagation();" class="school-card-link" style="cursor:pointer; color:var(--accent); text-decoration:none;">Find ' + firstProgTitle + ' program page &rarr;</a>' +
            '</div>';
          }).join('');

      } catch (err) {
        grid.innerHTML =
          '<div class="empty-state" style="grid-column: 1 / -1">' +
            '<div class="empty-state-icon">&#128269;</div>' +
            '<p>Error searching programs. Please try again with a different search term.</p>' +
          '</div>';
      }
    }
  </script>
</body>
</html>
